<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SG FITNESS EVOLUTION</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#f5820b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SG FITNESS EVOLUTION">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="logo.png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        /* Complete CSS Styles */
        :root {
            --primary: #4a6fa5;
            --secondary: #166088;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --light: #f8f9fa;
            --dark: #343a40;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            
            /* Light Mode Colors */
            --bg-primary: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --bg-card: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #343a40;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --header-bg: linear-gradient(135deg, #4a6fa5, #166088);
        }

        /* Dark Mode Colors - Professional Theme */
        [data-theme="dark"] {
            --bg-primary: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 100%);
            --bg-card: #1a1f2e;
            --bg-secondary: #141820;
            --text-primary: #f0f2f5;
            --text-secondary: #9ca3af;
            --border-color: #2d3748;
            --shadow-color: rgba(0, 0, 0, 0.4);
            --primary: #6b8cce;
            --secondary: #4a90a4;
            --success: #34d399;
            --warning: #fbbf24;
            --danger: #f87171;
            --light: #1e2533;
            --dark: #f0f2f5;
            --gray: #9ca3af;
            --light-gray: #1e2533;
            --header-bg: linear-gradient(135deg, #1e2533 0%, #0f1419 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            transition: background 0.3s ease, color 0.3s ease;
            padding: 20px;
            -webkit-tap-highlight-color: transparent;
        }

        /* Smooth transitions for all interactive elements */
        button, .btn-primary, .btn-secondary, .action-btn, .filter-btn, .nav-tab, .member-card, input, select {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--bg-card);
            border-radius: 15px;
            box-shadow: 0 10px 30px var(--shadow-color);
            overflow: hidden;
        }

        /* Header */
        .header {
            background: var(--header-bg);
            color: white;
            padding: 25px 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stat-label {
            display: block;
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: bold;
        }

        /* Alerts */
        .alerts-section {
            display: none;
            padding: 15px 30px;
            background: #fff3cd;
            border-bottom: 1px solid #ffecb5;
        }

        .alert {
            background: #fff3cd;
            border: 1px solid #ffecb5;
            color: #856404;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            animation: slideIn 0.3s ease;
        }

        .alert i {
            font-size: 1.2rem;
        }

        .btn-whatsapp {
            background: #25D366;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .btn-sms {
            background: #2196F3;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .btn-sms:hover {
            background: #1976D2;
        }

        .msg-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        /* Workout & Diet Plans Styles */
        .workout-subtab {
            padding: 12px 20px;
            border: 2px solid var(--primary);
            background: white;
            color: var(--primary);
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .workout-subtab:hover {
            background: var(--light);
        }

        .workout-subtab.active {
            background: var(--primary);
            color: white;
        }

        .plans-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .plan-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: all 0.3s;
        }

        .plan-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .plan-card-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px;
        }

        .plan-card-header.diet {
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
        }

        .plan-card-header h4 {
            margin: 0 0 5px;
            font-size: 1.2rem;
        }

        .plan-card-header p {
            margin: 0;
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .plan-card-body {
            padding: 20px;
        }

        .plan-day {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .plan-day h5 {
            margin: 0 0 8px;
            color: var(--primary);
            font-size: 0.95rem;
        }

        .plan-day ul {
            margin: 0;
            padding-left: 20px;
            font-size: 0.9rem;
            color: var(--gray);
        }

        .plan-day ul li {
            margin-bottom: 3px;
        }

        .plan-card-actions {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .plan-card-actions button {
            flex: 1;
            min-width: 80px;
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .member-plan-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary);
        }

        .member-plan-card h4 {
            margin: 0 0 10px;
            color: var(--dark);
        }

        .member-plan-info {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 15px;
            font-size: 0.9rem;
            color: var(--gray);
        }

        .member-plan-info span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Notification Center */
        .notification-bell {
            position: relative;
            cursor: pointer;
            padding: 10px 15px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            font-size: 1.2rem;
            transition: all 0.3s;
        }

        .notification-bell:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            font-size: 0.7rem;
            font-weight: bold;
            padding: 3px 7px;
            border-radius: 50%;
            min-width: 18px;
            text-align: center;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .notification-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 380px;
            max-width: 100vw;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 20px rgba(0,0,0,0.2);
            z-index: 10000;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .notification-panel.open {
            right: 0;
        }

        .notification-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-header h3 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s;
        }

        .notification-close:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        .notification-actions {
            padding: 10px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            display: flex;
            gap: 10px;
        }

        .notification-actions button {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.3s;
        }

        .notification-filters {
            padding: 10px 15px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            overflow-x: auto;
        }

        .notification-filter-btn {
            padding: 8px 15px;
            border: 2px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-primary);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.3s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .notification-filter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-color);
        }

        .notification-filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .notification-filter-btn.all.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }

        .notification-filter-btn.birthday.active {
            background: #e91e63;
            border-color: #e91e63;
        }

        .notification-filter-btn.expiring.active {
            background: #ff9800;
            border-color: #ff9800;
        }

        .notification-filter-btn.expired.active {
            background: #f44336;
            border-color: #f44336;
        }

        .notification-filter-btn.dues.active {
            background: #9c27b0;
            border-color: #9c27b0;
        }

        .notification-filter-btn.payment.active {
            background: #4caf50;
            border-color: #4caf50;
        }

        .notification-count-badge {
            background: rgba(255,255,255,0.3);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .notification-filter-btn.active .notification-count-badge {
            background: rgba(255,255,255,0.4);
        }

        .notification-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .notification-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 4px solid var(--primary);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .notification-item.unread {
            background: #e3f2fd;
            border-left-color: var(--warning);
        }

        .notification-item.unread::before {
            content: '';
            position: absolute;
            top: 10px;
            right: 10px;
            width: 10px;
            height: 10px;
            background: var(--warning);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .notification-item:hover {
            transform: translateX(-5px);
            box-shadow: 3px 3px 10px rgba(0,0,0,0.1);
        }

        .notification-item.birthday {
            border-left-color: #e91e63;
            background: #fce4ec;
        }

        .notification-item.expiry {
            border-left-color: var(--warning);
        }

        .notification-item.payment {
            border-left-color: var(--success);
        }

        .notification-item.dues {
            border-left-color: #9c27b0;
            background: #f3e5f5;
        }

        .notification-item h4 {
            margin: 0 0 8px;
            font-size: 0.95rem;
            color: var(--dark);
        }

        .notification-item p {
            margin: 0;
            font-size: 0.85rem;
            color: var(--gray);
        }

        .notification-item .notification-time {
            font-size: 0.75rem;
            color: #aaa;
            margin-top: 8px;
        }

        .notification-item .notification-actions-btns {
            margin-top: 10px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .notification-empty {
            text-align: center;
            padding: 50px 20px;
            color: var(--gray);
        }

        .notification-empty i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #ddd;
        }

        .notification-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .notification-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        /* Main Content */
        .main-content {
            padding: 30px;
        }

        /* Search Section */
        .search-section {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-box i {
            position: absolute;
            left: 15px;
            color: var(--gray);
        }

        .search-box input {
            width: 100%;
            padding: 15px 15px 15px 45px;
            border: 2px solid var(--light-gray);
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(74, 111, 165, 0.1);
        }

        .btn-clear {
            position: absolute;
            right: 10px;
            background: var(--light-gray);
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        /* Buttons */
        .btn-primary, .btn-secondary, .btn-success, .btn-danger, .btn-excel {
            padding: 15px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #374151;
            border: 1px solid #cbd5e1;
        }

        .btn-secondary:hover {
            background: #cbd5e1;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .btn-excel {
            background: #1d6f42;
            color: white;
        }

        .btn-excel:hover {
            background: #155d32;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        /* Filters */
        .filter-section {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 10px 20px;
            border: 2px solid var(--light-gray);
            background: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Members Grid */
        .members-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
        }

        .member-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            transition: all 0.3s;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
            /* Performance optimization */
            will-change: transform;
            transform: translateZ(0);
            contain: layout style paint;
        }

        .member-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--primary);
        }

        .member-card.expiring::before {
            background: var(--warning);
        }

        .member-card.expired::before {
            background: var(--danger);
        }

        .member-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .member-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .member-id {
            background: var(--light-gray);
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: bold;
            color: var(--primary);
        }

        .status-badge {
            padding: 6px 15px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status-active {
            background: #d4edda;
            color: var(--success);
        }

        .status-expiring {
            background: #fff3cd;
            color: var(--warning);
        }

        .status-expired {
            background: #f8d7da;
            color: var(--danger);
        }

        .member-info {
            margin-bottom: 20px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--light-gray);
        }

        .info-label {
            color: var(--gray);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .info-value {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .member-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .action-btn {
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: 500;
        }

        .action-btn-attendance {
            background: var(--success);
            color: white;
        }

        .action-btn-details {
            background: var(--primary);
            color: white;
        }

        .action-btn-edit {
            background: var(--warning);
            color: white;
        }

        .action-btn-delete {
            background: var(--danger);
            color: white;
        }

        .action-btn-payment {
            background: #9c27b0;
            color: white;
            grid-column: span 2;
        }

        .action-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        /* Payment Modal */
        .payment-plans {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .plan-card {
            background: var(--light);
            border: 2px solid var(--light-gray);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .plan-card:hover {
            border-color: var(--primary);
            transform: translateY(-3px);
        }

        .plan-card.selected {
            border-color: var(--primary);
            background: #e3f2fd;
        }

        .plan-days {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }

        .plan-price {
            font-size: 1.2rem;
            color: var(--success);
            margin-top: 5px;
        }

        .payment-summary {
            background: #e8f5e9;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .payment-summary h4 {
            margin-bottom: 15px;
            color: var(--success);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px dashed var(--light-gray);
        }

        .summary-row:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.1rem;
        }

        /* Excel Import Modal */
        .excel-import-section {
            background: var(--light);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            border: 2px dashed var(--primary);
        }

        .upload-area {
            text-align: center;
            padding: 40px 20px;
            border: 2px dashed var(--gray);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: rgba(74, 111, 165, 0.05);
        }

        .upload-area i {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .upload-area h3 {
            margin-bottom: 10px;
            color: var(--primary);
        }

        .upload-area p {
            color: var(--gray);
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .file-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid var(--light-gray);
        }

        .file-name {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
        }

        .file-size {
            color: var(--gray);
            font-size: 0.9em;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .preview-table th {
            background: var(--primary);
            color: white;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
        }

        .preview-table td {
            padding: 10px 15px;
            border-bottom: 1px solid var(--light-gray);
        }

        .preview-table tr:hover {
            background: var(--light);
        }

        .preview-table .error-row {
            background: #f8d7da;
            color: var(--danger);
        }

        .mapping-section {
            margin-top: 25px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border: 1px solid var(--light-gray);
        }

        .mapping-row {
            display: grid;
            grid-template-columns: 200px 1fr 100px;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: var(--light);
            border-radius: 8px;
        }

        .sample-template {
            background: #e8f4fd;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid var(--primary);
        }

        .sample-template h4 {
            color: var(--primary);
            margin-bottom: 10px;
        }

        .sample-template pre {
            background: white;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
            padding: 20px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 20px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
            margin: auto;
            position: relative;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 20px 20px 0 0;
            flex-shrink: 0;
        }

        .modal-header h2 {
            color: white;
            font-size: 1.5rem;
            margin: 0;
        }

        .close-modal, .close-details {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: white;
            opacity: 0.8;
        }

        .close-modal:hover, .close-details:hover {
            opacity: 1;
        }

        /* Form */
        .modal-body {
            padding: 20px 25px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 0;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.85rem;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s;
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(74, 111, 165, 0.1);
        }

        .form-group input[readonly] {
            background: var(--light-gray);
            cursor: not-allowed;
        }

        .duration-options {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .duration-option {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--light-gray);
            background: white;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .duration-option:hover {
            border-color: var(--primary);
            background: rgba(74, 111, 165, 0.05);
        }

        .duration-option.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        .expiry-options {
            margin-top: 10px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .expiry-option {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .expiry-option input[type="radio"] {
            width: 16px;
            height: 16px;
        }

        .expiry-option label {
            font-weight: 500;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .membership-duration-inputs {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .membership-duration-inputs input {
            flex: 1;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 15px 25px;
            border-top: 1px solid var(--border-color);
            background: var(--bg-secondary);
            border-radius: 0 0 20px 20px;
        }

        .modal-footer .btn-secondary {
            padding: 12px 25px;
            border-radius: 10px;
            font-weight: 600;
        }

        .modal-footer .btn-primary {
            padding: 12px 30px;
            border-radius: 10px;
            font-weight: 600;
        }

        /* Details Modal */
        .details-content {
            padding: 25px;
        }

        .details-grid {
            display: grid;
            gap: 15px;
        }

        .detail-item {
            padding: 20px;
            background: var(--light);
            border-radius: 10px;
            border-left: 4px solid var(--primary);
        }

        .detail-label {
            color: var(--gray);
            font-size: 0.9rem;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .detail-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark);
        }

        .attendance-history {
            margin-top: 25px;
        }

        .attendance-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid var(--light-gray);
        }

        .attendance-item {
            background: white;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            border-left: 4px solid var(--success);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--success);
            color: white;
            padding: 18px 25px;
            border-radius: 10px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
            display: none;
            animation: slideInRight 0.3s ease;
            z-index: 1001;
            min-width: 300px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .toast i {
            font-size: 1.5rem;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* No Results */
        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray);
            grid-column: 1 / -1;
        }

        .no-results i {
            font-size: 4rem;
            margin-bottom: 20px;
            color: var(--light-gray);
        }

        .no-results h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 10px;
            background: var(--light-gray);
            border-radius: 5px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--success);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Animations */
        @keyframes slideIn {
            from {
                transform: translateY(-10px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .search-box {
                min-width: 100%;
            }
            
            .search-section {
                flex-direction: column;
            }
            
            .members-grid {
                grid-template-columns: 1fr;
            }
            
            .dashboard-stats {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                margin: 10px;
                max-height: 90vh;
                border-radius: 15px;
            }
            
            .modal-header {
                padding: 15px 20px;
                border-radius: 15px 15px 0 0;
            }
            
            .modal-header h2 {
                font-size: 1.2rem;
            }
            
            .modal-body {
                padding: 15px 20px;
            }
            
            .member-actions {
                grid-template-columns: 1fr;
            }
            
            .modal-footer {
                flex-direction: row;
                padding: 12px 20px;
                border-radius: 0 0 15px 15px;
            }
            
            .modal-footer .btn-secondary,
            .modal-footer .btn-primary {
                flex: 1;
                padding: 12px 15px;
            }
            
            .btn-primary, .btn-secondary {
                width: 100%;
            }
            
            .membership-duration-inputs {
                flex-direction: column;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .mapping-row {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .stat-value {
                font-size: 1.8rem;
            }
            
            .filter-section {
                justify-content: center;
            }
            
            .member-card {
                padding: 20px;
            }
            
            .modal-header {
                padding: 20px;
            }
            
            .modal-body {
                padding: 20px;
            }
        }

        /* Loading State */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 50px;
            grid-column: 1 / -1;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--light-gray);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Text Utilities */
        .text-warning {
            color: var(--warning) !important;
        }

        .text-danger {
            color: var(--danger) !important;
        }

        .text-success {
            color: var(--success) !important;
        }

        /* ============ NAVIGATION TABS ============ */
        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid var(--light-gray);
            overflow-x: auto;
            padding: 0 20px;
        }

        .nav-tab {
            padding: 15px 20px;
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 600;
            color: var(--gray);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .nav-tab:hover {
            color: var(--primary);
            background: rgba(74, 111, 165, 0.1);
        }

        .nav-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: white;
        }

        .tab-content {
            display: none;
            padding: 20px;
        }

        .tab-content.active {
            display: block;
        }

        /* ============ TODAY'S SUMMARY SECTION ============ */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .summary-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border-left: 4px solid var(--primary);
        }

        .summary-card.success { border-left-color: var(--success); }
        .summary-card.warning { border-left-color: var(--warning); }
        .summary-card.danger { border-left-color: var(--danger); }

        .summary-card h3 {
            font-size: 0.9rem;
            color: var(--gray);
            margin-bottom: 10px;
        }

        .summary-card .value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--dark);
        }

        /* ============ DATA TABLES ============ */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .data-table th, .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--light-gray);
        }

        .data-table th {
            background: var(--primary);
            color: white;
            font-weight: 600;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .data-table .badge {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-danger { background: #f8d7da; color: #721c24; }

        /* ============ FILTER BAR ============ */
        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }

        .filter-bar input, .filter-bar select {
            padding: 10px 15px;
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            font-size: 14px;
        }

        .filter-bar input:focus, .filter-bar select:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* ============ PLANS GRID ============ */
        .plans-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .plan-card-big {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s;
            border: 2px solid transparent;
        }

        .plan-card-big:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
        }

        .plan-card-big.featured {
            border-color: var(--success);
            background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%);
        }

        .plan-card-big h3 {
            font-size: 1.5rem;
            color: var(--dark);
            margin-bottom: 10px;
        }

        .plan-card-big .price {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary);
        }

        .plan-card-big .duration {
            color: var(--gray);
            margin-bottom: 15px;
        }

        .plan-card-big ul {
            list-style: none;
            text-align: left;
            margin: 15px 0;
        }

        .plan-card-big ul li {
            padding: 8px 0;
            border-bottom: 1px solid var(--light-gray);
        }

        .plan-card-big ul li i {
            color: var(--success);
            margin-right: 10px;
        }

        /* ============ CAPACITY TRACKER ============ */
        .capacity-display {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 25px;
        }

        .capacity-circle {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            border: 8px solid rgba(255,255,255,0.3);
        }

        .capacity-circle .current {
            font-size: 3rem;
            font-weight: bold;
        }

        .capacity-circle .max {
            font-size: 1rem;
            opacity: 0.8;
        }

        .capacity-bar {
            background: rgba(255,255,255,0.3);
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 20px;
        }

        .capacity-fill {
            height: 100%;
            background: white;
            transition: width 0.5s ease;
        }

        .capacity-fill.warning { background: var(--warning); }
        .capacity-fill.danger { background: var(--danger); }

        /* ============ VISITING CARD ============ */
        .visiting-card-preview {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            margin: 20px auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .visiting-card-preview .gym-name {
            font-size: 1.8rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 5px;
        }

        .visiting-card-preview .tagline {
            text-align: center;
            opacity: 0.8;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .visiting-card-preview .contact-info {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
        }

        .visiting-card-preview .contact-info p {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 8px 0;
        }

        .broadcast-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .broadcast-box textarea {
            width: 100%;
            padding: 15px;
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            min-height: 100px;
            font-size: 14px;
            resize: vertical;
        }

        .broadcast-recipients {
            display: flex;
            gap: 15px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .broadcast-recipients label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        /* ============ SETTINGS FORM ============ */
        .settings-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .settings-section h3 {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light-gray);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .setting-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .setting-item label {
            font-weight: 600;
            color: var(--dark);
        }

        .setting-item input, .setting-item select {
            padding: 12px;
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            font-size: 14px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 26px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--success);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* ============ EXPORT BUTTONS ============ */
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        .export-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }

        .export-btn.pdf {
            background: #dc3545;
            color: white;
        }

        .export-btn.excel {
            background: #1d6f42;
            color: white;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }

        /* ============ EMPTY STATE ============ */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* ============ HAMBURGER MENU & SIDE PANEL ============ */
        .new-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .menu-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.3rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .menu-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-logo img {
            height: 40px;
        }

        .header-logo h1 {
            font-size: 1.3rem;
            margin: 0;
        }

        .header-logo h1 span {
            color: #f5820b;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.3s;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .header-btn .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        .sync-status-header {
            background: rgba(255,255,255,0.2);
            padding: 8px 12px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            color: white;
        }

        .sync-status-header i {
            font-size: 1rem;
        }

        .install-btn-header {
            background: var(--success);
            padding: 10px 15px;
            border-radius: 10px;
            border: none;
            color: white;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .install-btn-header:hover {
            background: #219a52;
            transform: scale(1.02);
        }

        /* See All Members Button */
        .see-members-section {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            border: 2px dashed var(--primary);
        }

        .see-members-btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
        }

        .see-members-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
        }

        .see-members-btn.active {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }

        .see-members-btn #seeMembersArrow {
            transition: transform 0.3s;
        }

        .see-members-btn.active #seeMembersArrow {
            transform: rotate(180deg);
        }

        .members-count-badge {
            background: var(--primary);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.95rem;
        }

        /* Member Search Box for Assign */
        .member-search-box {
            position: relative;
        }

        .member-search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .member-search-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }

        .member-search-item:hover {
            background: #f0f7ff;
        }

        .member-search-item:last-child {
            border-bottom: none;
        }

        .member-search-item .member-info-left {
            display: flex;
            flex-direction: column;
        }

        .member-search-item .member-roll {
            font-weight: 600;
            color: var(--primary);
            font-size: 0.85rem;
        }

        .member-search-item .member-name {
            font-size: 0.95rem;
            color: #333;
        }

        .member-search-item .member-status {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .member-search-item .member-status.active {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .member-search-item .member-status.expired {
            background: #ffebee;
            color: #c62828;
        }

        .member-search-no-results {
            padding: 15px;
            text-align: center;
            color: #999;
        }

        /* Side Menu */
        .side-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9998;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .side-menu-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .side-menu {
            position: fixed;
            top: 0;
            left: -300px;
            width: 280px;
            height: 100%;
            background: white;
            z-index: 9999;
            transition: left 0.3s ease;
            display: flex;
            flex-direction: column;
            box-shadow: 5px 0 20px rgba(0,0,0,0.2);
        }

        .side-menu.active {
            left: 0;
        }

        .side-menu-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 25px 20px;
            text-align: center;
        }

        .side-menu-header img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: white;
            padding: 5px;
            margin-bottom: 10px;
        }

        .side-menu-header h2 {
            margin: 0;
            font-size: 1.2rem;
        }

        .side-menu-header p {
            margin: 5px 0 0;
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .side-menu-items {
            flex: 1;
            overflow-y: auto;
            padding: 15px 0;
        }

        .side-menu-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 25px;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--dark);
            border-left: 4px solid transparent;
        }

        .side-menu-item:hover {
            background: #f0f4f8;
            border-left-color: var(--primary);
        }

        .side-menu-item.active {
            background: #e3f2fd;
            border-left-color: var(--primary);
            color: var(--primary);
            font-weight: 600;
        }

        .side-menu-item i {
            width: 24px;
            text-align: center;
            font-size: 1.1rem;
        }

        .side-menu-divider {
            height: 1px;
            background: #eee;
            margin: 10px 20px;
        }

        .side-menu-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .sync-status-menu {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--bg-card);
            border-radius: 8px;
            font-size: 0.9rem;
        }

        /* Dark Mode Toggle Button */
        .theme-toggle-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        /* Dark Mode Specific Styles - Professional Theme */
        [data-theme="dark"] .member-card,
        [data-theme="dark"] .settings-card,
        [data-theme="dark"] .summary-card,
        [data-theme="dark"] .enquiry-card,
        [data-theme="dark"] .workout-plan-card,
        [data-theme="dark"] .diet-plan-card {
            background: linear-gradient(145deg, #1e2533 0%, #161b26 100%);
            border: 1px solid rgba(99, 102, 241, 0.15);
            color: var(--text-primary);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3), 
                        0 0 0 1px rgba(255, 255, 255, 0.03);
        }

        [data-theme="dark"] .main-content {
            background: linear-gradient(180deg, #0d1117 0%, #161b22 100%);
        }

        [data-theme="dark"] input,
        [data-theme="dark"] select,
        [data-theme="dark"] textarea {
            background: #0d1117;
            border: 1px solid rgba(99, 102, 241, 0.2);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        [data-theme="dark"] input:focus,
        [data-theme="dark"] select:focus,
        [data-theme="dark"] textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
            outline: none;
        }

        [data-theme="dark"] input::placeholder,
        [data-theme="dark"] textarea::placeholder {
            color: #6b7280;
        }

        [data-theme="dark"] .modal-content {
            background: linear-gradient(145deg, #1a1f2e 0%, #0f1419 100%);
            color: var(--text-primary);
            border: 1px solid rgba(99, 102, 241, 0.2);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        [data-theme="dark"] .data-table th {
            background: linear-gradient(180deg, #1a1f2e 0%, #141820 100%);
            color: #a5b4fc;
            font-weight: 600;
            border-bottom: 2px solid rgba(99, 102, 241, 0.3);
        }

        [data-theme="dark"] .data-table td {
            border-color: rgba(99, 102, 241, 0.1);
            color: var(--text-primary);
        }

        [data-theme="dark"] .data-table tr:hover {
            background: rgba(99, 102, 241, 0.08);
        }

        [data-theme="dark"] .filter-btn {
            background: #1a1f2e;
            color: #94a3b8;
            border: 1px solid rgba(99, 102, 241, 0.2);
            transition: all 0.3s ease;
        }

        [data-theme="dark"] .filter-btn:hover {
            background: rgba(99, 102, 241, 0.15);
            color: #e2e8f0;
        }

        [data-theme="dark"] .filter-btn.active {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }

        [data-theme="dark"] .search-bar input {
            background: #0d1117;
            color: var(--text-primary);
            border: 1px solid rgba(99, 102, 241, 0.2);
        }

        [data-theme="dark"] .side-menu {
            background: linear-gradient(180deg, #0f1419 0%, #1a1f2e 100%);
            border-right: 1px solid rgba(99, 102, 241, 0.15);
        }

        [data-theme="dark"] .side-menu-header {
            background: linear-gradient(135deg, #1a1f2e 0%, #0f1419 100%);
            border-bottom: 1px solid rgba(99, 102, 241, 0.2);
        }

        [data-theme="dark"] .side-menu-item {
            color: #94a3b8;
            transition: all 0.3s ease;
        }

        [data-theme="dark"] .side-menu-item:hover {
            background: rgba(99, 102, 241, 0.1);
            color: #e2e8f0;
            border-left: 3px solid var(--primary);
        }

        [data-theme="dark"] .side-menu-item.active {
            background: linear-gradient(90deg, rgba(99, 102, 241, 0.2) 0%, transparent 100%);
            color: #a5b4fc;
            border-left: 3px solid var(--primary);
        }

        [data-theme="dark"] .side-menu-divider {
            background: rgba(99, 102, 241, 0.15);
        }

        [data-theme="dark"] .dashboard-stats-inline .stat-card-inline {
            background: linear-gradient(145deg, #1e2533 0%, #141820 100%);
            border: 1px solid rgba(99, 102, 241, 0.15);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        [data-theme="dark"] .notification-panel {
            background: linear-gradient(145deg, #1a1f2e 0%, #0f1419 100%);
            border: 1px solid rgba(99, 102, 241, 0.2);
        }

        /* Dark Mode Notification Items - Complete Fix */
        [data-theme="dark"] .notification-item {
            background: linear-gradient(145deg, #1e2533 0%, #161b26 100%);
            border: 1px solid rgba(99, 102, 241, 0.15);
            border-left: 4px solid var(--primary);
        }

        [data-theme="dark"] .notification-item h4 {
            color: #f0f2f5 !important;
        }

        [data-theme="dark"] .notification-item p {
            color: #94a3b8 !important;
        }

        [data-theme="dark"] .notification-item .notification-time {
            color: #6b7280 !important;
        }

        [data-theme="dark"] .notification-item.unread {
            background: linear-gradient(145deg, #1e2a3d 0%, #162030 100%);
            border-left-color: var(--warning);
        }

        [data-theme="dark"] .notification-item.birthday {
            background: linear-gradient(145deg, #2d1f2e 0%, #1f1520 100%);
            border-left-color: #e91e63;
        }

        [data-theme="dark"] .notification-item.birthday h4 {
            color: #f8bbd9 !important;
        }

        [data-theme="dark"] .notification-item.expiry {
            background: linear-gradient(145deg, #2d2a1f 0%, #1f1c15 100%);
            border-left-color: var(--warning);
        }

        [data-theme="dark"] .notification-item:hover {
            background: rgba(99, 102, 241, 0.15);
            transform: translateX(-5px);
        }

        [data-theme="dark"] .notification-header {
            background: linear-gradient(145deg, #1a1f2e 0%, #0f1419 100%);
            border-bottom: 1px solid rgba(99, 102, 241, 0.2);
            color: #f0f2f5;
        }

        [data-theme="dark"] .notification-header h3 {
            color: #f0f2f5 !important;
        }

        [data-theme="dark"] .notification-actions {
            background: #0d1117;
            border-bottom: 1px solid rgba(99, 102, 241, 0.15);
        }

        [data-theme="dark"] .notification-empty {
            color: #6b7280;
        }

        [data-theme="dark"] .notification-empty i {
            color: #374151;
        }

        [data-theme="dark"] .notification-item .notification-actions-btns button {
            background: linear-gradient(145deg, #1a1f2e 0%, #141820 100%);
            color: #e2e8f0;
            border: 1px solid rgba(99, 102, 241, 0.2);
        }

        [data-theme="dark"] .notification-item .notification-actions-btns button:hover {
            background: rgba(99, 102, 241, 0.2);
        }

        [data-theme="dark"] .see-members-section {
            background: linear-gradient(145deg, #1a1f2e 0%, #0f1419 100%);
            border: 1px solid rgba(99, 102, 241, 0.2);
        }

        [data-theme="dark"] .member-search-results {
            background: #0f1419;
            border: 1px solid rgba(99, 102, 241, 0.2);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
        }

        [data-theme="dark"] .member-search-item {
            border-color: rgba(99, 102, 241, 0.1);
        }

        [data-theme="dark"] .member-search-item:hover {
            background: rgba(99, 102, 241, 0.1);
        }

        [data-theme="dark"] .info-label {
            color: #6b7280;
        }

        [data-theme="dark"] .info-value {
            color: #e2e8f0;
        }

        [data-theme="dark"] .workout-sub-tab,
        [data-theme="dark"] .workout-sub-tab-btn {
            background: #1a1f2e;
            color: #94a3b8;
        }

        [data-theme="dark"] .workout-sub-tab-btn.active {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
        }

        /* Dark Mode Buttons */
        [data-theme="dark"] .btn-primary,
        [data-theme="dark"] button[type="submit"] {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.35);
        }

        [data-theme="dark"] .btn-primary:hover,
        [data-theme="dark"] button[type="submit"]:hover {
            box-shadow: 0 6px 25px rgba(99, 102, 241, 0.5);
            transform: translateY(-1px);
        }

        [data-theme="dark"] .btn-secondary {
            background: #1a1f2e;
            color: #94a3b8;
            border: 1px solid rgba(99, 102, 241, 0.2);
        }

        [data-theme="dark"] .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        [data-theme="dark"] .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        /* Dark Mode Header */
        [data-theme="dark"] .header {
            background: linear-gradient(135deg, #1a1f2e 0%, #0f1419 100%);
            border-bottom: 1px solid rgba(99, 102, 241, 0.15);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        /* Dark Mode Status Badges */
        [data-theme="dark"] .status-active {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(5, 150, 105, 0.2) 100%);
            color: #34d399;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        [data-theme="dark"] .status-expired {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(220, 38, 38, 0.2) 100%);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        [data-theme="dark"] .status-expiring {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2) 0%, rgba(217, 119, 6, 0.2) 100%);
            color: #fbbf24;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        /* Dark Mode Glow Effects */
        [data-theme="dark"] .member-card:hover {
            border-color: rgba(99, 102, 241, 0.4);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4), 
                        0 0 20px rgba(99, 102, 241, 0.15);
        }

        /* Dark Mode Scrollbar */
        [data-theme="dark"] ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        [data-theme="dark"] ::-webkit-scrollbar-track {
            background: #0f1419;
        }

        [data-theme="dark"] ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #374151 0%, #1f2937 100%);
            border-radius: 4px;
        }

        [data-theme="dark"] ::-webkit-scrollbar-thumb:hover {
            background: #4b5563;
        }

        /* Dark Mode Payment History */
        [data-theme="dark"] .payment-item {
            background: linear-gradient(145deg, #1a1f2e 0%, #141820 100%);
            border: 1px solid rgba(99, 102, 241, 0.15);
        }

        [data-theme="dark"] .payment-history-container {
            background: #0d1117;
            border: 1px solid rgba(99, 102, 241, 0.15);
        }

        /* ===== COMPREHENSIVE DARK MODE FIXES ===== */
        
        /* Main Content Area */
        [data-theme="dark"] .main-content {
            background: linear-gradient(180deg, #0d1117 0%, #161b22 100%) !important;
        }

        /* Nav Tabs */
        [data-theme="dark"] .nav-tabs {
            background: #0d1117;
            border-bottom-color: rgba(99, 102, 241, 0.2);
        }

        [data-theme="dark"] .nav-tab {
            color: #94a3b8;
        }

        [data-theme="dark"] .nav-tab:hover {
            color: #e2e8f0;
            background: rgba(99, 102, 241, 0.1);
        }

        [data-theme="dark"] .nav-tab.active {
            color: #a5b4fc;
            background: #1a1f2e;
            border-bottom-color: var(--primary);
        }

        /* ============ ATTENDANCE SYSTEM STYLES ============ */
        .attendance-header {
            margin-bottom: 25px;
        }

        .attendance-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .att-stat-card {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            border-radius: 12px;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-left: 4px solid var(--primary);
        }

        .att-stat-card.in-gym {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border-left-color: #22c55e;
        }

        .att-stat-card.in-gym i {
            color: #22c55e;
        }

        .att-stat-card.checked-in {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border-left-color: #3b82f6;
        }

        .att-stat-card.checked-in i {
            color: #3b82f6;
        }

        .att-stat-card.checked-out {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left-color: #f59e0b;
        }

        .att-stat-card.checked-out i {
            color: #f59e0b;
        }

        .att-stat-card i {
            font-size: 2rem;
            color: var(--primary);
        }

        .att-stat-info {
            display: flex;
            flex-direction: column;
        }

        .att-stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--dark);
        }

        .att-stat-label {
            font-size: 0.85rem;
            color: var(--gray);
        }

        .quick-checkin-section {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px var(--shadow-color);
        }

        .quick-checkin-section h3 {
            margin-bottom: 15px;
            color: var(--primary);
        }

        .checkin-search-box {
            display: flex;
            align-items: center;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 12px 15px;
            gap: 10px;
        }

        .checkin-search-box i {
            color: var(--gray);
        }

        .checkin-search-box input {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 1rem;
            color: var(--text-primary);
            outline: none;
        }

        .attendance-search-results {
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .attendance-member-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid var(--border-color);
        }

        .attendance-member-info {
            display: flex;
            flex-direction: column;
        }

        .attendance-member-info .name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .attendance-member-info .details {
            font-size: 0.85rem;
            color: var(--gray);
        }

        .attendance-member-info .status-in {
            color: #22c55e;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .btn-checkin {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-checkin:hover {
            transform: scale(1.05);
        }

        .btn-checkout {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-checkout:hover {
            transform: scale(1.05);
        }

        .currently-in-gym-section {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px var(--shadow-color);
        }

        .currently-in-gym-section h3 {
            margin-bottom: 15px;
            color: #22c55e;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .currently-in-gym-section h3 .badge {
            background: #22c55e;
            color: white;
            padding: 2px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .in-gym-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
        }

        .in-gym-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-radius: 10px;
            border: 1px solid #86efac;
        }

        .in-gym-card .member-info {
            display: flex;
            flex-direction: column;
        }

        .in-gym-card .member-name {
            font-weight: 600;
            color: var(--dark);
        }

        .in-gym-card .entry-time {
            font-size: 0.85rem;
            color: #16a34a;
        }

        .attendance-log-section {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px var(--shadow-color);
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .log-header h3 {
            color: var(--primary);
        }

        .log-header input[type="date"] {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-badge.in-gym {
            background: #dcfce7;
            color: #16a34a;
        }

        .status-badge.completed {
            background: #dbeafe;
            color: #2563eb;
        }

        /* Dark mode attendance styles */
        [data-theme="dark"] .att-stat-card {
            background: linear-gradient(135deg, #1e2533 0%, #161b26 100%);
        }

        [data-theme="dark"] .att-stat-card.in-gym {
            background: linear-gradient(135deg, #064e3b 0%, #022c22 100%);
            border-left-color: #34d399;
        }

        [data-theme="dark"] .att-stat-card.checked-in {
            background: linear-gradient(135deg, #1e3a5f 0%, #172554 100%);
            border-left-color: #60a5fa;
        }

        [data-theme="dark"] .att-stat-card.checked-out {
            background: linear-gradient(135deg, #451a03 0%, #78350f 100%);
            border-left-color: #fbbf24;
        }

        [data-theme="dark"] .att-stat-value {
            color: #f0f2f5;
        }

        [data-theme="dark"] .quick-checkin-section,
        [data-theme="dark"] .currently-in-gym-section,
        [data-theme="dark"] .attendance-log-section {
            background: #1a1f2e;
        }

        [data-theme="dark"] .attendance-member-item {
            background: #161b26;
            border-color: #2d3748;
        }

        [data-theme="dark"] .in-gym-card {
            background: linear-gradient(135deg, #064e3b 0%, #022c22 100%);
            border-color: #34d399;
        }

        [data-theme="dark"] .in-gym-card .member-name {
            color: #f0f2f5;
        }

        [data-theme="dark"] .in-gym-card .entry-time {
            color: #34d399;
        }

        /* Summary Cards */
        [data-theme="dark"] .summary-card {
            background: linear-gradient(145deg, #1e2533 0%, #161b26 100%);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        [data-theme="dark"] .summary-card h3 {
            color: #94a3b8;
        }

        [data-theme="dark"] .summary-card .value {
            color: #f0f2f5;
        }

        /* Filter Bar */
        [data-theme="dark"] .filter-bar {
            background: linear-gradient(145deg, #1a1f2e 0%, #141820 100%);
            border: 1px solid rgba(99, 102, 241, 0.15);
        }

        [data-theme="dark"] .filter-bar label {
            color: #94a3b8;
        }

        /* Data Tables */
        [data-theme="dark"] .data-table {
            background: #1a1f2e;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        [data-theme="dark"] .data-table th {
            background: linear-gradient(180deg, #252d3d 0%, #1a1f2e 100%);
            color: #a5b4fc;
            border-bottom: 2px solid rgba(99, 102, 241, 0.3);
        }

        [data-theme="dark"] .data-table td {
            color: #e2e8f0;
            border-bottom-color: rgba(99, 102, 241, 0.1);
        }

        [data-theme="dark"] .data-table tr:hover {
            background: rgba(99, 102, 241, 0.08);
        }

        [data-theme="dark"] .empty-state {
            color: #6b7280;
        }

        /* Badges in Dark Mode */
        [data-theme="dark"] .badge-success {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
        }

        [data-theme="dark"] .badge-warning {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
        }

        [data-theme="dark"] .badge-danger {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        /* Total Collection Box - Payment History */
        [data-theme="dark"] div[style*="background: #e8f5e9"],
        [data-theme="dark"] div[style*="background:#e8f5e9"] {
            background: linear-gradient(145deg, rgba(16, 185, 129, 0.15) 0%, rgba(5, 150, 105, 0.1) 100%) !important;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        /* Settings Section */
        [data-theme="dark"] .settings-section {
            background: linear-gradient(145deg, #1e2533 0%, #161b26 100%);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(99, 102, 241, 0.15);
        }

        [data-theme="dark"] .settings-section h3 {
            color: #f0f2f5;
            border-bottom-color: rgba(99, 102, 241, 0.2);
        }

        [data-theme="dark"] .setting-item label {
            color: #94a3b8;
        }

        /* Firebase Info Box */
        [data-theme="dark"] div[style*="background: #e3f2fd"],
        [data-theme="dark"] div[style*="background:#e3f2fd"] {
            background: linear-gradient(145deg, rgba(99, 102, 241, 0.15) 0%, rgba(139, 92, 246, 0.1) 100%) !important;
            border: 1px solid rgba(99, 102, 241, 0.3);
            color: #e2e8f0;
        }

        [data-theme="dark"] div[style*="background: #e3f2fd"] a,
        [data-theme="dark"] div[style*="background:#e3f2fd"] a {
            color: #a5b4fc !important;
        }

        /* Plan Cards */
        [data-theme="dark"] .plan-card-big {
            background: linear-gradient(145deg, #1e2533 0%, #161b26 100%);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(99, 102, 241, 0.15);
        }

        [data-theme="dark"] .plan-card-big:hover {
            border-color: var(--primary);
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.2);
        }

        [data-theme="dark"] .plan-card-big h3 {
            color: #f0f2f5;
        }

        [data-theme="dark"] .plan-card-big .price {
            color: #a5b4fc;
        }

        /* Broadcast Box */
        [data-theme="dark"] .broadcast-box {
            background: linear-gradient(145deg, #1a1f2e 0%, #141820 100%);
            border: 1px solid rgba(99, 102, 241, 0.15);
        }

        [data-theme="dark"] .broadcast-box textarea {
            background: #0d1117;
            border-color: rgba(99, 102, 241, 0.2);
            color: #e2e8f0;
        }

        [data-theme="dark"] .broadcast-recipients label {
            color: #94a3b8;
        }

        /* Capacity Section */
        [data-theme="dark"] .capacity-section {
            background: linear-gradient(145deg, #1e2533 0%, #161b26 100%) !important;
        }

        /* All inline style overrides for backgrounds */
        [data-theme="dark"] [style*="background: #f8f9fa"],
        [data-theme="dark"] [style*="background:#f8f9fa"],
        [data-theme="dark"] [style*="background: white"],
        [data-theme="dark"] [style*="background:white"] {
            background: linear-gradient(145deg, #1a1f2e 0%, #141820 100%) !important;
        }

        /* Text colors in dark mode */
        [data-theme="dark"] h2, 
        [data-theme="dark"] h3,
        [data-theme="dark"] h4,
        [data-theme="dark"] strong {
            color: #f0f2f5;
        }

        [data-theme="dark"] p,
        [data-theme="dark"] span,
        [data-theme="dark"] label {
            color: #e2e8f0;
        }

        /* Links in dark mode */
        [data-theme="dark"] a {
            color: #a5b4fc;
        }

        [data-theme="dark"] a:hover {
            color: #c4b5fd;
        }

        /* Toggle Switch in Dark Mode */
        [data-theme="dark"] .toggle-slider {
            background: #374151;
        }

        [data-theme="dark"] input:checked + .toggle-slider {
            background: var(--primary);
        }

        /* Export Buttons */
        [data-theme="dark"] .export-btn.excel {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        [data-theme="dark"] .export-btn.pdf {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        /* Enquiry and Workout Cards */
        [data-theme="dark"] .enquiry-card,
        [data-theme="dark"] .workout-plan-card,
        [data-theme="dark"] .diet-plan-card {
            background: linear-gradient(145deg, #1e2533 0%, #161b26 100%) !important;
        }

        /* Info boxes with colored backgrounds */
        [data-theme="dark"] [style*="background: #fff3cd"],
        [data-theme="dark"] [style*="background:#fff3cd"] {
            background: rgba(245, 158, 11, 0.15) !important;
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: #fbbf24 !important;
        }

        [data-theme="dark"] [style*="background: #f8d7da"],
        [data-theme="dark"] [style*="background:#f8d7da"] {
            background: rgba(239, 68, 68, 0.15) !important;
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #f87171 !important;
        }

        [data-theme="dark"] [style*="background: #d4edda"],
        [data-theme="dark"] [style*="background:#d4edda"] {
            background: rgba(16, 185, 129, 0.15) !important;
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #34d399 !important;
        }

        /* Visiting Card */
        [data-theme="dark"] .visiting-card-preview {
            background: linear-gradient(135deg, #0f1419 0%, #1a1f2e 100%);
            border: 1px solid rgba(99, 102, 241, 0.3);
        }

        /* ===== BILL PREVIEW DARK MODE FIX ===== */
        [data-theme="dark"] #billPreview,
        [data-theme="dark"] [style*="background: #f8f9fa"] {
            background: linear-gradient(145deg, #1e2533 0%, #161b26 100%) !important;
            border-color: rgba(99, 102, 241, 0.3) !important;
        }

        [data-theme="dark"] #billPreview h3,
        [data-theme="dark"] #billPreview h4 {
            color: #f0f2f5 !important;
        }

        [data-theme="dark"] #billPreview p {
            color: #e2e8f0 !important;
        }

        [data-theme="dark"] #billPreview p strong {
            color: #f0f2f5 !important;
        }

        [data-theme="dark"] #billPreview [style*="color: var(--gray)"],
        [data-theme="dark"] #billPreview [style*="color:var(--gray)"] {
            color: #94a3b8 !important;
        }

        [data-theme="dark"] #billPreview [style*="color: var(--dark)"],
        [data-theme="dark"] #billPreview [style*="color:var(--dark)"] {
            color: #f0f2f5 !important;
        }

        [data-theme="dark"] #billPreview [style*="border-top: 1px solid #ddd"],
        [data-theme="dark"] #billPreview [style*="border-top:1px solid #ddd"] {
            border-color: rgba(99, 102, 241, 0.2) !important;
        }

        /* Payment Modal Content Dark Mode */
        [data-theme="dark"] #paymentContent {
            color: #e2e8f0;
        }

        [data-theme="dark"] #paymentContent h2 {
            color: #f0f2f5;
        }

        [data-theme="dark"] .msg-buttons .btn-whatsapp {
            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%) !important;
        }

        [data-theme="dark"] .msg-buttons .btn-sms {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%) !important;
        }

        /* Dashboard Stats in Main Content */
        .dashboard-stats-inline {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }

        .stat-card-inline {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            color: white;
        }

        .stat-card-inline .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            display: block;
        }

        .stat-card-inline .stat-label {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        @media (max-width: 600px) {
            .header-logo h1 {
                font-size: 1rem;
            }
            .install-btn-header span {
                display: none;
            }
            .install-btn-header {
                padding: 10px;
            }
        }

        /* ===== REMAINING DARK MODE FIXES ===== */
        
        /* Search Box */
        [data-theme="dark"] .search-box input {
            background: #0d1117;
            border-color: rgba(99, 102, 241, 0.2);
            color: #f0f2f5;
        }

        [data-theme="dark"] .search-box i {
            color: #6b7280;
        }

        [data-theme="dark"] .btn-clear {
            background: #1a1f2e;
            color: #94a3b8;
        }

        /* Workout/Diet Subtabs */
        [data-theme="dark"] .workout-subtab {
            background: #1a1f2e;
            color: #94a3b8;
            border-color: rgba(99, 102, 241, 0.3);
        }

        [data-theme="dark"] .workout-subtab:hover {
            background: rgba(99, 102, 241, 0.15);
        }

        [data-theme="dark"] .workout-subtab.active {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
        }

        /* Plan Card */
        [data-theme="dark"] .plan-card {
            background: linear-gradient(145deg, #1e2533 0%, #161b26 100%);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        [data-theme="dark"] .plan-card:hover {
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.2);
        }

        [data-theme="dark"] .plan-card-header {
            background: linear-gradient(135deg, #1a1f2e 0%, #0f1419 100%);
        }

        /* Member ID Badge */
        [data-theme="dark"] .member-id {
            background: rgba(99, 102, 241, 0.2);
            color: #a5b4fc;
        }

        /* Mapping Section */
        [data-theme="dark"] .mapping-section {
            background: linear-gradient(145deg, #1e2533 0%, #161b26 100%);
            border-color: rgba(99, 102, 241, 0.2);
        }

        [data-theme="dark"] .mapping-row {
            background: #0d1117;
        }

        /* Sample Template */
        [data-theme="dark"] .sample-template {
            background: linear-gradient(145deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.05) 100%);
            border-left-color: var(--primary);
        }

        [data-theme="dark"] .sample-template h4 {
            color: #a5b4fc;
        }

        [data-theme="dark"] .sample-template pre {
            background: #0d1117;
            color: #e2e8f0;
        }

        /* Preview Table */
        [data-theme="dark"] .preview-table th {
            background: linear-gradient(180deg, #1a1f2e 0%, #141820 100%);
            color: #a5b4fc;
        }

        [data-theme="dark"] .preview-table td {
            background: #161b22;
            color: #e2e8f0;
        }

        [data-theme="dark"] .preview-table tr:hover td {
            background: rgba(99, 102, 241, 0.1);
        }

        /* Import Section */
        [data-theme="dark"] .import-section,
        [data-theme="dark"] .import-summary {
            background: linear-gradient(145deg, #1e2533 0%, #161b26 100%);
            border-color: rgba(99, 102, 241, 0.2);
        }

        /* File Input */
        [data-theme="dark"] .file-input-wrapper {
            background: #0d1117;
            border-color: rgba(99, 102, 241, 0.3);
        }

        /* Member Details Modal */
        [data-theme="dark"] .member-details-grid {
            background: linear-gradient(145deg, #1a1f2e 0%, #141820 100%);
        }

        [data-theme="dark"] .detail-item {
            border-color: rgba(99, 102, 241, 0.1);
        }

        [data-theme="dark"] .detail-label {
            color: #6b7280;
        }

        [data-theme="dark"] .detail-value {
            color: #f0f2f5;
        }

        /* Attendance History */
        [data-theme="dark"] .attendance-list {
            background: #0d1117;
        }

        [data-theme="dark"] .attendance-item {
            background: #1a1f2e;
            border-color: rgba(99, 102, 241, 0.1);
            color: #e2e8f0;
        }

        /* Payment History in Member Details */
        [data-theme="dark"] .payment-history-list {
            background: #0d1117;
        }

        [data-theme="dark"] .payment-history-item {
            background: linear-gradient(145deg, #1a1f2e 0%, #141820 100%);
            border-color: rgba(99, 102, 241, 0.1);
        }

        /* Form Groups and Labels */
        [data-theme="dark"] .form-group label {
            color: #94a3b8;
        }

        [data-theme="dark"] .form-row {
            border-color: rgba(99, 102, 241, 0.1);
        }

        /* Expiry Options */
        [data-theme="dark"] .expiry-option {
            background: #1a1f2e;
            border-color: rgba(99, 102, 241, 0.2);
            color: #94a3b8;
        }

        [data-theme="dark"] .expiry-option:hover {
            background: rgba(99, 102, 241, 0.1);
        }

        [data-theme="dark"] .expiry-option.active {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2) 0%, rgba(139, 92, 246, 0.2) 100%);
            border-color: var(--primary);
            color: #a5b4fc;
        }

        /* Alert Boxes */
        [data-theme="dark"] .alert-box {
            background: linear-gradient(145deg, #1a1f2e 0%, #141820 100%);
            border-color: rgba(99, 102, 241, 0.2);
        }

        /* Toast Notification */
        [data-theme="dark"] .toast {
            background: linear-gradient(145deg, #1e2533 0%, #161b26 100%);
            color: #f0f2f5;
            border: 1px solid rgba(99, 102, 241, 0.2);
        }

        /* Quick Stats Card */
        [data-theme="dark"] .quick-stats {
            background: linear-gradient(145deg, #1a1f2e 0%, #141820 100%);
        }

        /* Tab Content Background */
        [data-theme="dark"] .tab-content {
            background: transparent;
        }

        /* No Results */
        [data-theme="dark"] .no-results {
            color: #6b7280;
        }

        [data-theme="dark"] .no-results h3 {
            color: #94a3b8;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- New Header with Hamburger Menu -->
        <header class="new-header">
            <div class="header-left">
                <button class="menu-btn" onclick="gym.toggleSideMenu()">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="header-logo">
                    <img src="logo.png" alt="SG">
                    <h1>SG FITNESS <span>EVOLUTION</span></h1>
                </div>
            </div>
            <div class="header-right">
                <button class="theme-toggle-btn" id="themeToggle" onclick="gym.toggleDarkMode()" title="Toggle Dark Mode">
                    <i class="fas fa-moon" id="themeIcon"></i>
                </button>
                <button class="header-btn" onclick="gym.toggleNotificationPanel()">
                    <i class="fas fa-bell"></i>
                    <span class="badge" id="notificationBadge" style="display: none;">0</span>
                </button>
            </div>
        </header>

        <!-- Side Menu Overlay -->
        <div class="side-menu-overlay" id="sideMenuOverlay" onclick="gym.closeSideMenu()"></div>

        <!-- Side Menu -->
        <div class="side-menu" id="sideMenu">
            <div class="side-menu-header">
                <img src="logo.png" alt="SG Fitness">
                <h2>SG FITNESS EVOLUTION</h2>
                <p>Gym Management System</p>
            </div>
            <div class="side-menu-items">
                <div class="side-menu-item active" data-tab="members" onclick="gym.switchTabFromMenu('members')">
                    <i class="fas fa-users"></i>
                    <span>Members</span>
                </div>
                <div class="side-menu-item" data-tab="attendance" onclick="gym.switchTabFromMenu('attendance')">
                    <i class="fas fa-clipboard-check"></i>
                    <span>Attendance</span>
                </div>
                <div class="side-menu-item" data-tab="today" onclick="gym.switchTabFromMenu('today')">
                    <i class="fas fa-calendar-day"></i>
                    <span>Today's Summary</span>
                </div>
                <div class="side-menu-item" data-tab="payments" onclick="gym.switchTabFromMenu('payments')">
                    <i class="fas fa-rupee-sign"></i>
                    <span>Payment History</span>
                </div>
                <div class="side-menu-divider"></div>
                <div class="side-menu-item" data-tab="workout" onclick="gym.switchTabFromMenu('workout')">
                    <i class="fas fa-dumbbell"></i>
                    <span>Workout & Diet</span>
                </div>
                <div class="side-menu-item" data-tab="enquiry" onclick="gym.switchTabFromMenu('enquiry')">
                    <i class="fas fa-user-clock"></i>
                    <span>Enquiry</span>
                </div>
                <div class="side-menu-item" data-tab="media" onclick="gym.switchTabFromMenu('media')">
                    <i class="fas fa-share-alt"></i>
                    <span>Broadcast & Cards</span>
                </div>
                <div class="side-menu-divider"></div>
                <div class="side-menu-item" data-tab="messages" onclick="gym.switchTabFromMenu('messages')">
                    <i class="fas fa-envelope-open-text"></i>
                    <span>Message Settings</span>
                </div>
                <div class="side-menu-item" data-tab="plans" onclick="gym.switchTabFromMenu('plans')">
                    <i class="fas fa-cog"></i>
                    <span>Plans & Settings</span>
                </div>
            </div>
            <div class="side-menu-footer">
                <div class="side-menu-item" id="installBtnMenu" onclick="installApp()" style="background: var(--primary); color: white; border-radius: 8px; margin: 10px; justify-content: center;">
                    <i class="fas fa-download"></i>
                    <span>Install App</span>
                </div>
                <div class="sync-status-menu" id="syncStatusMenu">
                    <i class="fas fa-cloud-slash" style="color: #ffc107;"></i>
                    <span>Not Connected</span>
                </div>
            </div>
        </div>

        <!-- Dashboard Stats -->
        <div class="dashboard-stats-inline">
            <div class="stat-card-inline">
                <span class="stat-value" id="totalMembers">0</span>
                <span class="stat-label">Total Members</span>
            </div>
            <div class="stat-card-inline">
                <span class="stat-value" id="todayAttendance">0</span>
                <span class="stat-label">Today's Attendance</span>
            </div>
            <div class="stat-card-inline">
                <span class="stat-value" id="expiringSoon">0</span>
                <span class="stat-label">Expiring Soon</span>
            </div>
            <div class="stat-card-inline">
                <span class="stat-value" id="activeMembers">0</span>
                <span class="stat-label">Active</span>
            </div>
            <div class="stat-card-inline" style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border-color: #f87171;">
                <span class="stat-value" id="totalDues" style="color: #dc2626;">0</span>
                <span class="stat-label" style="color: #991b1b;">Total Dues</span>
            </div>
        </div>

        <!-- Notification Overlay -->
        <div class="notification-overlay" id="notificationOverlay" onclick="gym.closeNotificationPanel()"></div>

        <!-- Notification Panel -->
        <div class="notification-panel" id="notificationPanel">
            <div class="notification-header">
                <h3><i class="fas fa-bell"></i> Notifications</h3>
                <button class="notification-close" onclick="gym.closeNotificationPanel()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="notification-actions">
                <button onclick="gym.markAllNotificationsRead()" style="background: var(--primary); color: white;">
                    <i class="fas fa-check-double"></i> Mark All Read
                </button>
                <button onclick="gym.clearAllNotifications()" style="background: var(--danger); color: white;">
                    <i class="fas fa-trash"></i> Clear All
                </button>
            </div>
            <div class="notification-filters">
                <button class="notification-filter-btn all active" onclick="gym.filterNotifications('all')">
                    <i class="fas fa-bell"></i> All
                    <span class="notification-count-badge" id="filter-count-all">0</span>
                </button>
                <button class="notification-filter-btn birthday" onclick="gym.filterNotifications('birthday')">
                    <i class="fas fa-birthday-cake"></i> Birthday
                    <span class="notification-count-badge" id="filter-count-birthday">0</span>
                </button>
                <button class="notification-filter-btn expiring" onclick="gym.filterNotifications('expiring')">
                    <i class="fas fa-exclamation-triangle"></i> Expiring
                    <span class="notification-count-badge" id="filter-count-expiring">0</span>
                </button>
                <button class="notification-filter-btn expired" onclick="gym.filterNotifications('expired')">
                    <i class="fas fa-times-circle"></i> Expired
                    <span class="notification-count-badge" id="filter-count-expired">0</span>
                </button>
                <button class="notification-filter-btn dues" onclick="gym.filterNotifications('dues')">
                    <i class="fas fa-rupee-sign"></i> Dues
                    <span class="notification-count-badge" id="filter-count-dues">0</span>
                </button>
                <button class="notification-filter-btn payment" onclick="gym.filterNotifications('payment')">
                    <i class="fas fa-check-circle"></i> Payments
                    <span class="notification-count-badge" id="filter-count-payment">0</span>
                </button>
            </div>
            <div class="notification-list" id="notificationList">
                <!-- Notifications will be loaded here -->
            </div>
        </div>

        <!-- Alerts Section -->
        <div class="alerts-section" id="alertsContainer">
            <!-- Alerts will appear here -->
        </div>
        </nav>

        <!-- ============ TAB 1: MEMBERS (Original Main Content) ============ -->
        <div class="tab-content active" id="tab-members">
            <!-- Search and Action Buttons -->
            <div class="search-section">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Search by Roll No, Name, Father's Name, Mobile...">
                    <button class="btn-clear" id="clearSearch">Clear</button>
                </div>
                <div class="action-buttons">
                    <button class="btn-primary" id="addMemberBtn">
                        <i class="fas fa-user-plus"></i> Add Single
                    </button>
                    <button class="btn-excel" id="importExcelBtn">
                        <i class="fas fa-file-excel"></i> Import Excel
                    </button>
                    <button class="btn-primary" id="exportExcelBtn" style="background: var(--warning);">
                        <i class="fas fa-download"></i> Export
                    </button>
                    <button class="btn-primary" id="refreshBtn" style="background: var(--success);">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>

            <!-- Filter Buttons -->
            <div class="filter-section">
                <button class="filter-btn active" data-filter="all">All Members</button>
                <button class="filter-btn" data-filter="expiring">Expiring in 7 Days</button>
                <button class="filter-btn" data-filter="active">Active</button>
                <button class="filter-btn" data-filter="expired">Expired</button>
                <button class="filter-btn" data-filter="dues">Dues Pending</button>
            </div>

            <!-- See All Members Toggle Button -->
            <div class="see-members-section">
                <button class="see-members-btn" id="seeMembersBtn" onclick="gym.toggleMembersView()">
                    <i class="fas fa-users"></i> 
                    <span id="seeMembersBtnText">See All Members</span>
                    <i class="fas fa-chevron-down" id="seeMembersArrow"></i>
                </button>
                <span class="members-count-badge" id="membersCountBadge">0 Members</span>
            </div>

            <!-- Members Grid (Hidden by default) -->
            <div class="members-grid" id="membersGrid" style="display: none;">
                <!-- Loading initially -->
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
        <!-- End Tab 1: Members -->

        <!-- ============ TAB: ATTENDANCE ============ -->
        <div class="tab-content" id="tab-attendance">
            <div class="main-content">
                <h2 style="margin-bottom: 20px;"><i class="fas fa-clipboard-check"></i> Attendance System</h2>
                
                <!-- Currently In Gym Section -->
                <div class="attendance-header">
                    <div class="attendance-stats">
                        <div class="att-stat-card in-gym">
                            <i class="fas fa-running"></i>
                            <div class="att-stat-info">
                                <span class="att-stat-value" id="currentlyInGym">0</span>
                                <span class="att-stat-label">Currently In Gym</span>
                            </div>
                        </div>
                        <div class="att-stat-card checked-in">
                            <i class="fas fa-sign-in-alt"></i>
                            <div class="att-stat-info">
                                <span class="att-stat-value" id="totalCheckins">0</span>
                                <span class="att-stat-label">Total Check-ins Today</span>
                            </div>
                        </div>
                        <div class="att-stat-card checked-out">
                            <i class="fas fa-sign-out-alt"></i>
                            <div class="att-stat-info">
                                <span class="att-stat-value" id="totalCheckouts">0</span>
                                <span class="att-stat-label">Checked Out</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Check-in Section -->
                <div class="quick-checkin-section">
                    <h3><i class="fas fa-bolt"></i> Quick Check-in / Check-out</h3>
                    <div class="checkin-search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="attendanceSearch" placeholder="Search member by name, roll no, or mobile..." oninput="gym.searchForAttendance()">
                    </div>
                    <div class="attendance-search-results" id="attendanceSearchResults">
                        <!-- Search results will appear here -->
                    </div>
                </div>

                <!-- Currently In Gym List -->
                <div class="currently-in-gym-section">
                    <h3><i class="fas fa-users"></i> Currently In Gym <span class="badge" id="inGymBadge">0</span></h3>
                    <div class="in-gym-list" id="inGymList">
                        <div class="empty-state">No members currently in gym</div>
                    </div>
                </div>

                <!-- Today's Attendance Log -->
                <div class="attendance-log-section">
                    <div class="log-header">
                        <h3><i class="fas fa-history"></i> Today's Attendance Log</h3>
                        <input type="date" id="attendanceDate" onchange="gym.loadAttendanceByDate()">
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Roll No</th>
                                <th>Name</th>
                                <th>Entry Time</th>
                                <th>Exit Time</th>
                                <th>Duration</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceLogBody">
                            <tr><td colspan="6" class="empty-state">No attendance records for today</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- End Tab: Attendance -->

        <!-- ============ TAB 2: TODAY'S SUMMARY ============ -->
        <div class="tab-content" id="tab-today">
            <div class="main-content">
                <h2 style="margin-bottom: 20px;"><i class="fas fa-calendar-day"></i> Today's Check-in & Payment Summary</h2>
                <p style="color: var(--gray); margin-bottom: 25px;">Daily summary for <strong id="todaySummaryDate"></strong></p>
                
                <div class="summary-cards">
                    <div class="summary-card success">
                        <h3><i class="fas fa-user-check"></i> Today's Check-ins</h3>
                        <div class="value" id="todayCheckinCount">0</div>
                    </div>
                    <div class="summary-card">
                        <h3><i class="fas fa-rupee-sign"></i> Today's Collection</h3>
                        <div class="value" id="todayCollection">0</div>
                    </div>
                    <div class="summary-card warning">
                        <h3><i class="fas fa-user-plus"></i> New Admissions</h3>
                        <div class="value" id="todayAdmissions">0</div>
                    </div>
                    <div class="summary-card danger">
                        <h3><i class="fas fa-user-clock"></i> Renewals Today</h3>
                        <div class="value" id="todayRenewals">0</div>
                    </div>
                </div>

                <div style="display: flex; gap: 30px; flex-wrap: wrap;">
                    <!-- Today's Payments List -->
                    <div style="flex: 1; min-width: 300px;">
                        <h3 style="margin-bottom: 15px;"><i class="fas fa-receipt"></i> Payment List</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Serial</th>
                                    <th>Name</th>
                                    <th>Amount</th>
                                    <th>Type</th>
                                </tr>
                            </thead>
                            <tbody id="todayPaymentList">
                                <tr><td colspan="4" class="empty-state">No payments today</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Tab 2 -->

        <!-- ============ TAB 3: PAYMENT HISTORY ============ -->
        <div class="tab-content" id="tab-payments">
            <div class="main-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                    <h2><i class="fas fa-history"></i> Monthly Payment History</h2>
                    <div class="export-buttons" style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn-danger" onclick="gym.deleteAllPaymentHistory()" style="padding: 10px 20px;">
                            <i class="fas fa-trash"></i> Delete All
                        </button>
                        <button class="export-btn excel" onclick="gym.exportPaymentHistory('excel')">
                            <i class="fas fa-file-excel"></i> Export Excel
                        </button>
                        <button class="export-btn pdf" onclick="gym.exportPaymentHistory('pdf')">
                            <i class="fas fa-file-pdf"></i> Export PDF
                        </button>
                    </div>
                </div>

                <div class="filter-bar">
                    <div>
                        <label>From Date:</label>
                        <input type="date" id="paymentDateFrom">
                    </div>
                    <div>
                        <label>To Date:</label>
                        <input type="date" id="paymentDateTo">
                    </div>
                    <div>
                        <label>Member:</label>
                        <input type="text" id="paymentMemberSearch" placeholder="Search by name...">
                    </div>
                    <div>
                        <label>Status:</label>
                        <select id="paymentStatusFilter">
                            <option value="all">All</option>
                            <option value="paid">Paid (No Dues)</option>
                            <option value="pending">Unpaid (Has Dues)</option>
                        </select>
                    </div>
                    <button class="btn-primary" onclick="gym.filterPaymentHistory()" style="padding: 10px 20px;">
                        <i class="fas fa-filter"></i> Filter
                    </button>
                </div>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date & Time</th>
                            <th>Roll No</th>
                            <th>Member Name</th>
                            <th>Plan</th>
                            <th>Paid</th>
                            <th>Due</th>
                            <th>Mode</th>
                            <th>New Expiry</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="paymentHistoryTable">
                        <tr><td colspan="10" class="empty-state"><i class="fas fa-receipt"></i><br>No payment records found</td></tr>
                    </tbody>
                </table>

                <div style="margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 10px;">
                    <strong>Total Collection (Filtered): </strong>
                    <span id="filteredTotalCollection" style="font-size: 1.5rem; color: var(--success);">0</span>
                </div>
            </div>
        </div>
        <!-- End Tab 3 -->

        <!-- ============ TAB 4: PLANS & SETTINGS ============ -->
        <div class="tab-content" id="tab-plans">
            <div class="main-content">
                <h2 style="margin-bottom: 25px;"><i class="fas fa-cog"></i> Custom Plans & Gym Settings</h2>

                <!-- Custom Plans Section -->
                <div class="settings-section">
                    <h3><i class="fas fa-tags"></i> Membership Plans</h3>
                    <div class="plans-grid" id="plansGrid">
                        <!-- Plans will be rendered here -->
                    </div>
                    <button class="btn-primary" onclick="gym.openAddPlanModal()" style="margin-top: 20px;">
                        <i class="fas fa-plus"></i> Add New Plan
                    </button>
                </div>

                <!-- Gym Settings Section -->
                <div class="settings-section">
                    <h3><i class="fas fa-building"></i> Gym Information</h3>
                    <div class="settings-grid">
                        <div class="setting-item">
                            <label>Gym Name</label>
                            <input type="text" id="settingGymName" placeholder="Your Gym Name" onchange="gym.saveSettings()">
                        </div>
                        <div class="setting-item">
                            <label>Tagline</label>
                            <input type="text" id="settingTagline" placeholder="Your fitness journey starts here" onchange="gym.saveSettings()">
                        </div>
                        <div class="setting-item">
                            <label>Contact Number</label>
                            <input type="tel" id="settingPhone" placeholder="9876543210" onchange="gym.saveSettings()">
                        </div>
                        <div class="setting-item">
                            <label>WhatsApp Number</label>
                            <input type="tel" id="settingWhatsApp" placeholder="919876543210" onchange="gym.saveSettings()">
                        </div>
                        <div class="setting-item">
                            <label>Address</label>
                            <input type="text" id="settingAddress" placeholder="Gym address" onchange="gym.saveSettings()">
                        </div>
                        <div class="setting-item">
                            <label>Email</label>
                            <input type="email" id="settingEmail" placeholder="gym@email.com" onchange="gym.saveSettings()">
                        </div>
                    </div>
                </div>

                <!-- Timing & Fees Settings -->
                <div class="settings-section">
                    <h3><i class="fas fa-clock"></i> Timing & Alerts</h3>
                    <div class="settings-grid">
                        <div class="setting-item">
                            <label>Opening Time</label>
                            <input type="time" id="settingOpenTime" value="05:00" onchange="gym.saveSettings()">
                        </div>
                        <div class="setting-item">
                            <label>Closing Time</label>
                            <input type="time" id="settingCloseTime" value="22:00" onchange="gym.saveSettings()">
                        </div>
                        <div class="setting-item">
                            <label>Max Capacity</label>
                            <input type="number" id="settingMaxCapacity" value="50" min="1" onchange="gym.saveSettings()">
                        </div>
                        <div class="setting-item">
                            <label>Expiry Alert Days</label>
                            <input type="number" id="settingExpiryAlertDays" value="7" min="1" onchange="gym.saveSettings()">
                        </div>
                        <div class="setting-item">
                            <label>Enable WhatsApp Alerts</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="settingEnableAlerts" onchange="gym.saveSettings()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Cloud Sync Settings (Firebase) -->
                <div class="settings-section">
                    <h3><i class="fas fa-cloud"></i> Cloud Sync (Firebase) - Data Sync Across Devices</h3>
                    <p style="color: var(--gray); margin-bottom: 15px;">
                        Setup Firebase to sync your data across all devices. Create a free Firebase project at 
                        <a href="https://console.firebase.google.com" target="_blank" style="color: var(--primary);">console.firebase.google.com</a>
                    </p>
                    <div class="settings-grid">
                        <div class="setting-item">
                            <label>Firebase API Key</label>
                            <input type="text" id="firebaseApiKey" placeholder="AIzaSy...">
                        </div>
                        <div class="setting-item">
                            <label>Project ID</label>
                            <input type="text" id="firebaseProjectId" placeholder="your-project-id">
                        </div>
                        <div class="setting-item" style="grid-column: 1 / -1;">
                            <label>Database URL</label>
                            <input type="text" id="firebaseDatabaseURL" placeholder="https://your-project-id-default-rtdb.firebaseio.com">
                        </div>
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn-primary" onclick="gym.saveFirebaseConfig()">
                            <i class="fas fa-save"></i> Save & Connect
                        </button>
                    </div>
                    <div style="margin-top: 15px; padding: 15px; background: #d4edda; border-radius: 8px; border-left: 4px solid #28a745;">
                        <strong style="color: #155724;"><i class="fas fa-sync-alt"></i> Auto-Sync Enabled!</strong>
                        <p style="margin: 8px 0 0; font-size: 0.9rem; color: #155724;">All changes automatically sync to cloud in real-time. No manual upload needed!</p>
                    </div>
                    <div style="margin-top: 15px; padding: 15px; background: #e3f2fd; border-radius: 8px;">
                        <strong><i class="fas fa-info-circle"></i> How to setup:</strong>
                        <ol style="margin: 10px 0 0 20px; font-size: 0.9rem;">
                            <li>Go to <a href="https://console.firebase.google.com" target="_blank">Firebase Console</a></li>
                            <li>Create a new project (free)</li>
                            <li>Go to Project Settings  General  Your apps  Add Web app</li>
                            <li>Copy API Key and Project ID</li>
                            <li>Go to Realtime Database  Create Database  Start in Test Mode</li>
                            <li>Copy the Database URL</li>
                            <li>Paste all values here and click Save</li>
                            <li>After saving, click "Pull from Cloud" to load your data</li>
                        </ol>
                    </div>
                    <div style="margin-top: 10px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                        <strong><i class="fas fa-exclamation-triangle"></i> Important - Database Rules:</strong>
                        <p style="margin: 8px 0 0; font-size: 0.9rem;">Go to Realtime Database  Rules and paste this:</p>
                        <pre style="background: white; padding: 10px; border-radius: 5px; margin-top: 8px; font-size: 0.85rem; overflow-x: auto;">{
  "rules": {
    "gymData": {
      ".read": true,
      ".write": true
    }
  }
}</pre>
                        <p style="margin: 8px 0 0; font-size: 0.85rem; color: #856404;">Click <strong>Publish</strong> after pasting the rules!</p>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Tab 4 -->

        <!-- ============ TAB 5: ENQUIRY ============ -->
        <div class="tab-content" id="tab-enquiry">
            <div class="main-content">
                <h2 style="margin-bottom: 25px;"><i class="fas fa-user-clock"></i> Enquiry Management</h2>

                <div style="display: flex; gap: 30px; flex-wrap: wrap;">
                    <!-- Add Enquiry Form -->
                    <div style="flex: 1; min-width: 350px;">
                        <div class="broadcast-box">
                            <h3 style="margin-bottom: 20px;"><i class="fas fa-user-plus"></i> Add New Enquiry</h3>
                            
                            <div class="form-group">
                                <label>Name <span style="color: red;">*</span></label>
                                <input type="text" id="enquiryName" placeholder="Enter name" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
                            </div>
                            
                            <div class="form-group" style="margin-top: 15px;">
                                <label>Mobile Number <span style="color: red;">*</span></label>
                                <input type="tel" id="enquiryMobile" placeholder="Enter 10 digit mobile number" maxlength="10" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
                            </div>
                            
                            <div class="form-group" style="margin-top: 15px;">
                                <label>Interested In</label>
                                <select id="enquiryPlan" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
                                    <option value="">Select Plan</option>
                                    <option value="1 Month">1 Month</option>
                                    <option value="3 Months">3 Months</option>
                                    <option value="6 Months">6 Months</option>
                                    <option value="12 Months">12 Months</option>
                                </select>
                            </div>
                            
                            <div class="form-group" style="margin-top: 15px;">
                                <label>Notes</label>
                                <textarea id="enquiryNotes" placeholder="Any additional notes..." style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; min-height: 80px;"></textarea>
                            </div>
                            
                            <button class="btn-primary" onclick="gym.addEnquiry()" style="width: 100%; margin-top: 20px; padding: 15px;">
                                <i class="fas fa-plus"></i> Add Enquiry
                            </button>
                        </div>
                    </div>

                    <!-- Enquiry List -->
                    <div style="flex: 2; min-width: 400px;">
                        <div class="broadcast-box">
                            <h3 style="margin-bottom: 20px;"><i class="fas fa-list"></i> Enquiry List</h3>
                            <div id="enquiryList" style="max-height: 500px; overflow-y: auto;">
                                <!-- Enquiries will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Enquiry Tab -->

        <!-- ============ TAB 6: DIGITAL CARD & BROADCAST ============ -->
        <div class="tab-content" id="tab-media">
            <div class="main-content">
                <h2 style="margin-bottom: 25px;"><i class="fas fa-share-alt"></i> Digital Visiting Card & Media Broadcast</h2>

                <div style="display: flex; gap: 30px; flex-wrap: wrap;">
                    <!-- Visiting Card Preview -->
                    <div style="flex: 1; min-width: 350px;">
                        <h3 style="margin-bottom: 15px;"><i class="fas fa-id-card"></i> Digital Visiting Card</h3>
                        <div class="visiting-card-preview" id="visitingCardPreview">
                            <img src="logo.png" alt="SG Fitness Evolution" style="width: 150px; display: block; margin: 0 auto 10px;">
                            <div class="gym-name" id="cardGymName">SG FITNESS <span style="color: #f5820b;">EVOLUTION</span></div>
                            <div class="tagline" id="cardTagline">Transform Your Body, Transform Your Life</div>
                            <div class="contact-info">
                                <p><i class="fas fa-phone"></i> <span id="cardPhone">+91 9876543210</span></p>
                                <p><i class="fab fa-whatsapp"></i> <span id="cardWhatsApp">+91 9876543210</span></p>
                                <p><i class="fas fa-map-marker-alt"></i> <span id="cardAddress">Your Gym Address</span></p>
                                <p><i class="fas fa-clock"></i> <span id="cardTimings">5:00 AM - 10:00 PM</span></p>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 15px; justify-content: center;">
                            <button class="btn-primary" onclick="gym.shareVisitingCard()">
                                <i class="fab fa-whatsapp"></i> Share via WhatsApp
                            </button>
                            <button class="btn-secondary" onclick="gym.downloadVisitingCard()" style="background: var(--success); color: white;">
                                <i class="fas fa-download"></i> Download
                            </button>
                        </div>
                    </div>

                    <!-- Broadcast Section -->
                    <div style="flex: 1; min-width: 350px;">
                        <h3 style="margin-bottom: 15px;"><i class="fas fa-bullhorn"></i> Broadcast Message</h3>
                        <div class="broadcast-box">
                            <label style="font-weight: 600; margin-bottom: 10px; display: block;">Message:</label>
                            <textarea id="broadcastMessage" placeholder="Type your announcement or promotional message here..."></textarea>
                            
                            <label style="font-weight: 600; margin-top: 15px; display: block;">Send To:</label>
                            <div class="broadcast-recipients">
                                <label><input type="checkbox" id="sendToAll" checked> All Members</label>
                                <label><input type="checkbox" id="sendToActive"> Active Only</label>
                                <label><input type="checkbox" id="sendToExpiring"> Expiring Soon</label>
                                <label><input type="checkbox" id="sendToExpired"> Expired Members</label>
                            </div>

                            <div style="display: flex; gap: 10px; margin-top: 15px;">
                                <button class="btn-primary" onclick="gym.sendBroadcast()" style="flex: 1;">
                                    <i class="fab fa-whatsapp"></i> Send Broadcast
                                </button>
                            </div>
                            <p style="font-size: 0.85rem; color: var(--gray); margin-top: 10px;">
                                <i class="fas fa-info-circle"></i> This will open WhatsApp for each selected member
                            </p>
                        </div>

                        <!-- WhatsApp Group Link with QR Code -->
                        <div class="broadcast-box" style="margin-top: 20px; background: var(--bg-secondary); border: 2px solid #25D366;">
                            <h4 style="margin-bottom: 15px; color: #25D366;"><i class="fab fa-whatsapp"></i> Join WhatsApp Group</h4>
                            
                            <!-- QR Code Section -->
                            <div style="text-align: center; margin-bottom: 20px;">
                                <div id="whatsappQRCode" style="background: white; padding: 15px; border-radius: 10px; display: inline-block;">
                                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=https://chat.whatsapp.com/H7Bg7hXumjhCTJKhYQSFLZ" alt="WhatsApp Group QR Code" style="width: 180px; height: 180px;">
                                </div>
                                <p style="margin-top: 10px; color: var(--text-secondary); font-size: 0.9rem;">
                                    <i class="fas fa-qrcode"></i> Scan to join WhatsApp Group
                                </p>
                            </div>
                            
                            <p style="margin-bottom: 15px; color: var(--text-primary); text-align: center;">Or share this link with members:</p>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="btn-primary" onclick="window.open('https://chat.whatsapp.com/H7Bg7hXumjhCTJKhYQSFLZ', '_blank')" style="background: #25D366; flex: 1;">
                                    <i class="fab fa-whatsapp"></i> Open Group
                                </button>
                                <button class="btn-secondary" onclick="gym.copyGroupLink()" style="flex: 1;">
                                    <i class="fas fa-copy"></i> Copy Link
                                </button>
                                <button class="btn-secondary" onclick="gym.shareGroupLink()" style="flex: 1;">
                                    <i class="fas fa-share-alt"></i> Share Link
                                </button>
                            </div>
                        </div>


                    </div>
                </div>
            </div>
        </div>
        <!-- End Tab 6 -->

        <!-- ============ TAB 7: WORKOUT & DIET PLANS ============ -->
        <div class="tab-content" id="tab-workout">
            <div class="main-content">
                <h2 style="margin-bottom: 25px;"><i class="fas fa-dumbbell"></i> Workout & Diet Plans</h2>
                
                <!-- Sub Tabs -->
                <div class="workout-subtabs" style="display: flex; gap: 10px; margin-bottom: 25px; flex-wrap: wrap;">
                    <button class="workout-subtab active" onclick="gym.switchWorkoutSubTab('workoutPlans')" data-subtab="workoutPlans">
                        <i class="fas fa-dumbbell"></i> Workout Plans
                    </button>
                    <button class="workout-subtab" onclick="gym.switchWorkoutSubTab('dietPlans')" data-subtab="dietPlans">
                        <i class="fas fa-utensils"></i> Diet Plans
                    </button>
                    <button class="workout-subtab" onclick="gym.switchWorkoutSubTab('assignPlan')" data-subtab="assignPlan">
                        <i class="fas fa-user-check"></i> Assign to Member
                    </button>
                    <button class="workout-subtab" onclick="gym.switchWorkoutSubTab('memberPlans')" data-subtab="memberPlans">
                        <i class="fas fa-users"></i> Member Plans
                    </button>
                </div>

                <!-- Workout Plans Section -->
                <div class="workout-section" id="section-workoutPlans">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                        <h3><i class="fas fa-dumbbell"></i> Workout Plan Templates</h3>
                        <button class="btn-primary" onclick="gym.showCreateWorkoutModal()">
                            <i class="fas fa-plus"></i> Create Workout Plan
                        </button>
                    </div>
                    <div id="workoutPlansList" class="plans-grid">
                        <!-- Workout plans will be loaded here -->
                    </div>
                </div>

                <!-- Diet Plans Section -->
                <div class="workout-section" id="section-dietPlans" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                        <h3><i class="fas fa-utensils"></i> Diet Plan Templates</h3>
                        <button class="btn-primary" onclick="gym.showCreateDietModal()">
                            <i class="fas fa-plus"></i> Create Diet Plan
                        </button>
                    </div>
                    <div id="dietPlansList" class="plans-grid">
                        <!-- Diet plans will be loaded here -->
                    </div>
                </div>

                <!-- Assign Plan Section -->
                <div class="workout-section" id="section-assignPlan" style="display: none;">
                    <div class="settings-card" style="max-width: 600px;">
                        <h3 style="margin-bottom: 20px;"><i class="fas fa-user-check"></i> Assign Plan to Member</h3>
                        
                        <div class="form-group">
                            <label>Search Member</label>
                            <div class="member-search-box">
                                <input type="text" id="assignMemberSearch" placeholder="Search by Roll No, Name, Mobile..." 
                                    oninput="gym.searchMemberForAssign(this.value)"
                                    style="width: 100%; padding: 12px 12px 12px 40px; border: 1px solid #ddd; border-radius: 8px;">
                                <i class="fas fa-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #999;"></i>
                                <div class="member-search-results" id="assignMemberResults" style="display: none;"></div>
                            </div>
                            <input type="hidden" id="assignMemberSelect" value="">
                            <div id="selectedMemberDisplay" style="display: none; margin-top: 10px; padding: 12px; background: #e8f5e9; border-radius: 8px; border: 1px solid #4caf50;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span id="selectedMemberName" style="font-weight: 600; color: #2e7d32;"></span>
                                    <button type="button" onclick="gym.clearSelectedMember()" style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8rem;">
                                        <i class="fas fa-times"></i> Clear
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Select Workout Plan</label>
                            <select id="assignWorkoutSelect" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">
                                <option value="">-- No Workout Plan --</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Select Diet Plan</label>
                            <select id="assignDietSelect" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">
                                <option value="">-- No Diet Plan --</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Start Date</label>
                            <input type="date" id="assignStartDate" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                        
                        <div class="form-group">
                            <label>Duration (Weeks)</label>
                            <select id="assignDuration" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">
                                <option value="4">4 Weeks</option>
                                <option value="8">8 Weeks</option>
                                <option value="12">12 Weeks</option>
                                <option value="16">16 Weeks</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Trainer Notes (Optional)</label>
                            <textarea id="assignNotes" placeholder="Any special instructions..." style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; min-height: 80px;"></textarea>
                        </div>
                        
                        <button class="btn-primary" onclick="gym.assignPlanToMember()" style="width: 100%; padding: 15px; margin-top: 10px;">
                            <i class="fas fa-check"></i> Assign Plan
                        </button>
                    </div>
                </div>

                <!-- Member Plans Section -->
                <div class="workout-section" id="section-memberPlans" style="display: none;">
                    <div style="margin-bottom: 20px;">
                        <h3><i class="fas fa-users"></i> Members with Assigned Plans</h3>
                        <p style="color: var(--gray); margin-top: 5px;">View and share member workout/diet plans</p>
                    </div>
                    <div class="form-group" style="max-width: 400px; margin-bottom: 20px;">
                        <input type="text" id="memberPlanSearch" placeholder="Search member by name or roll no..." style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;" oninput="gym.filterMemberPlans()">
                    </div>
                    <div id="memberPlansList">
                        <!-- Member plans will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
        <!-- End Tab 7 -->

        <!-- ============ TAB 8: MESSAGE SETTINGS ============ -->
        <div class="tab-content" id="tab-messages">
            <div class="main-content">
                <h2 style="margin-bottom: 25px;"><i class="fas fa-envelope-open-text"></i> Message Settings</h2>
                
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
                    <h3 style="margin: 0 0 10px 0;"><i class="fas fa-info-circle"></i> Dynamic Message Templates</h3>
                    <p style="margin: 0; opacity: 0.9;">Select a message type to edit. Use placeholders like {name}, {date}, {amount} etc.</p>
                    <div id="activeMessageDisplay" style="margin-top: 15px; padding: 12px; background: rgba(255,255,255,0.15); border-radius: 8px; display: none;">
                        <i class="fas fa-check-circle"></i> <strong>Currently Editing:</strong> <span id="activeMessageName">None</span>
                    </div>
                </div>
                
                <!-- Message Type Selector -->
                <div style="background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600; color: var(--text-primary);">
                        <i class="fas fa-list"></i> Select Message to Edit:
                    </label>
                    <select id="messageTypeSelector" onchange="gym.showSelectedMessageEditor()" style="width: 100%; padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; background: var(--bg-secondary); color: var(--text-primary); cursor: pointer;">
                        <option value="">-- Choose Message Type --</option>
                        <option value="expiredMember"> Expired Member Message</option>
                        <option value="expiringSoon"> Expiring Soon Message</option>
                        <option value="duesReminder"> Dues Reminder Message</option>
                        <option value="duesCleared"> Dues Cleared Message</option>
                        <option value="paymentConfirm"> Payment Confirmation Message</option>
                        <option value="newAdmission"> New Admission Message</option>
                        <option value="birthdayWish"> Birthday Wish Message</option>
                    </select>
                </div>
                
                <!-- Dynamic Message Editor Area -->
                <div id="messageEditorArea" style="display: none; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 12px; padding: 25px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 id="messageEditorTitle" style="margin: 0; color: var(--text-primary);"></h3>
                        <button onclick="gym.closeMessageEditor()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary);">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <p id="messageEditorHelp" style="color: var(--text-secondary); margin-bottom: 15px; font-size: 0.9rem;"></p>
                    <textarea id="messageEditorTextarea" rows="6" style="width: 100%; padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; background: var(--bg-secondary); color: var(--text-primary); resize: vertical; font-family: inherit;"></textarea>
                    
                    <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn-primary" onclick="gym.saveCurrentMessage()" style="padding: 12px 25px;">
                            <i class="fas fa-save"></i> Save This Message
                        </button>
                        <button class="btn-secondary" onclick="gym.resetCurrentMessage()" style="padding: 12px 25px;">
                            <i class="fas fa-undo"></i> Reset to Default
                        </button>
                    </div>
                </div>
                
                <!-- Hidden textareas for storing values -->
                <div style="display: none;">
                    <textarea id="expiredMemberMessage"></textarea>
                    <textarea id="expiringSoonMessage"></textarea>
                    <textarea id="duesReminderMessage"></textarea>
                    <textarea id="duesClearedMessage"></textarea>
                    <textarea id="paymentConfirmMessage"></textarea>
                    <textarea id="newAdmissionMessage"></textarea>
                    <textarea id="birthdayWishMessage"></textarea>
                </div>
                
                <!-- Save All & Reset Buttons -->
                <div style="text-align: center; margin-top: 30px; padding: 20px; background: var(--bg-secondary); border-radius: 12px;">
                    <p style="margin-bottom: 15px; color: var(--text-secondary);">Save all messages at once or reset all to defaults</p>
                    <button class="btn-primary" onclick="gym.saveMessageSettings()" style="padding: 15px 40px; font-size: 1.1rem;">
                        <i class="fas fa-save"></i> Save All Messages
                    </button>
                    <button class="btn-secondary" onclick="gym.resetMessageDefaults()" style="padding: 15px 40px; font-size: 1.1rem; margin-left: 10px;">
                        <i class="fas fa-undo"></i> Reset All to Defaults
                    </button>
                </div>
            </div>
        </div>
        <!-- End Tab 8 -->

        <!-- Add Plan Modal -->
        <div class="modal" id="addPlanModal">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h2 id="planModalTitle"><i class="fas fa-plus"></i> Add New Plan</h2>
                    <button class="close-modal" onclick="gym.closeAllModals()">&times;</button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editPlanId" value="">
                    <div class="form-group">
                        <label>Plan Name</label>
                        <input type="text" id="newPlanName" placeholder="e.g., Monthly, Quarterly">
                    </div>
                    <div class="form-group">
                        <label>Duration (Days)</label>
                        <input type="number" id="newPlanDays" placeholder="30" min="1">
                    </div>
                    <div class="form-group">
                        <label>Price ()</label>
                        <input type="number" id="newPlanPrice" placeholder="500" min="1">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" id="newPlanDesc" placeholder="Plan features">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="gym.closeAllModals()">Cancel</button>
                    <button class="btn-primary" onclick="gym.savePlan()">
                        <i class="fas fa-save"></i> Save Plan
                    </button>
                </div>
            </div>
        </div>

        <!-- Add/Edit Member Modal -->
        <div class="modal" id="memberModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalTitle">Add New Member</h2>
                    <button class="close-modal">&times;</button>
                </div>
                <form id="memberForm">
                    <div class="modal-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="serialNumber">Roll Number *</label>
                                <input type="text" id="serialNumber" required placeholder="Enter Roll Number">
                            </div>
                            <div class="form-group">
                                <label for="fullName">Full Name *</label>
                                <input type="text" id="fullName" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="fatherName">Father's Name</label>
                                <input type="text" id="fatherName">
                            </div>
                            <div class="form-group">
                                <label for="mobileNumber">Mobile Number *</label>
                                <input type="tel" id="mobileNumber" required pattern="[0-9]{10}">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="age">Age</label>
                                <input type="number" id="age" min="1" max="100">
                            </div>
                            <div class="form-group">
                                <label for="height">Height (cm)</label>
                                <input type="number" id="height" min="100" max="250">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="dob">Date of Birth</label>
                                <input type="date" id="dob">
                            </div>
                            <div class="form-group">
                                <label for="joinDate">Join Date *</label>
                                <input type="date" id="joinDate" required>
                            </div>
                        </div>

                        <!-- Plan Selection Dropdown -->
                        <div class="form-group">
                            <label for="selectedPlan">Select Plan *</label>
                            <select id="selectedPlan" required onchange="gym.onPlanSelect()">
                                <option value="">-- Select a Plan --</option>
                            </select>
                            <div id="selectedPlanInfo" style="margin-top: 10px; padding: 10px; background: var(--bg-secondary); border-radius: 8px; display: none;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Duration:</span>
                                    <strong id="planDurationDisplay">-</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                                    <span>Price:</span>
                                    <strong id="planPriceDisplay">-</strong>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Section for New Member -->
                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label for="admissionAmount"><i class="fas fa-rupee-sign"></i> Amount Paid ()</label>
                                <input type="number" id="admissionAmount" placeholder="Enter amount paid" min="0" oninput="gym.calculateDuesPreview()">
                            </div>
                            <div class="form-group">
                                <label for="admissionPaymentMode"><i class="fas fa-wallet"></i> Payment Mode</label>
                                <select id="admissionPaymentMode">
                                    <option value="Online"> Online</option>
                                    <option value="Cash"> Cash</option>
                                    <option value="UPI"> UPI</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Dues Preview -->
                        <div id="duesPreviewBox" style="display: none; background: linear-gradient(135deg, #ff6b6b, #ee5a24); color: white; padding: 12px 15px; border-radius: 10px; margin-bottom: 15px; font-weight: 600;">
                            <i class="fas fa-exclamation-triangle"></i> 
                            <span id="duesPreviewText">Dues: 0</span>
                        </div>

                        <div class="form-group">
                            <label for="membershipDuration">Membership Duration *</label>
                            <div class="expiry-options" id="expiryOptions">
                                    <div class="expiry-option">
                                        <input type="radio" id="auto30days" name="expiryOption" value="auto30" checked>
                                        <label for="auto30days">Auto: 30 Days (Join Date + 30 days)</label>
                                    </div>
                                    <div class="expiry-option">
                                        <input type="radio" id="customDays" name="expiryOption" value="custom">
                                        <label for="customDays">Custom Number of Days</label>
                                    </div>
                                    <div class="expiry-option">
                                        <input type="radio" id="manualDate" name="expiryOption" value="manual">
                                        <label for="manualDate">Choose Specific Date</label>
                                    </div>
                                </div>

                                <!-- Custom Days Input -->
                                <div id="customDaysInput" style="display: none; margin-top: 15px;">
                                    <label for="durationDays">Enter Number of Days:</label>
                                    <div class="membership-duration-inputs">
                                        <input type="number" id="durationDays" min="1" max="365" value="30" style="flex: 1;">
                                        <button type="button" class="duration-option" onclick="gym.setPresetDuration(30)">30 Days</button>
                                        <button type="button" class="duration-option" onclick="gym.setPresetDuration(90)">90 Days</button>
                                        <button type="button" class="duration-option" onclick="gym.setPresetDuration(180)">6 Months</button>
                                        <button type="button" class="duration-option" onclick="gym.setPresetDuration(365)">1 Year</button>
                                    </div>
                                    <div style="margin-top: 10px; font-size: 0.9em; color: var(--primary);">
                                        Expiry Date: <span id="calculatedExpiryDate">-</span>
                                    </div>
                                </div>

                                <!-- Manual Date Input -->
                                <div id="manualDateInput" style="display: none; margin-top: 15px;">
                                    <label for="expiryDate">Select Expiry Date:</label>
                                    <input type="date" id="expiryDate">
                                </div>

                                <!-- Auto 30 Days Display -->
                                <div id="autoExpiryDisplay" style="margin-top: 15px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-color);">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span>Expiry Date (Auto-calculated):</span>
                                        <strong id="autoExpiryDate">-</strong>
                                    </div>
                                    <div style="font-size: 0.9em; color: var(--gray); margin-top: 5px;">
                                        Join Date + 30 days
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <input type="hidden" id="memberId">
                        
                        <!-- New Admission Checkbox -->
                        <div id="newAdmissionSection" style="margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #e8f5e9, #c8e6c9); border-radius: 10px; border: 2px solid #4CAF50;">
                            <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; font-weight: 600; color: #2e7d32;">
                                <input type="checkbox" id="isNewAdmission" checked style="width: 22px; height: 22px; accent-color: #4CAF50;">
                                <span><i class="fas fa-user-plus"></i> New Admission - Send Welcome Message</span>
                            </label>
                            <p style="margin: 8px 0 0 34px; font-size: 0.85rem; color: #558b2f;">Check this to send WhatsApp/SMS welcome message after saving</p>
                        </div>
                        
                        <!-- Buttons inside form -->
                        <div style="display: flex; gap: 12px; margin-top: 20px; justify-content: flex-end;">
                            <button type="button" class="btn-secondary close-modal" style="padding: 12px 25px; border-radius: 10px; font-weight: 600;">Cancel</button>
                            <button type="button" class="btn-primary" onclick="gym.saveMember()" style="padding: 12px 30px; border-radius: 10px; font-weight: 600;">Save Member</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Excel Import Modal -->
        <div class="modal" id="excelModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-file-excel"></i> Import Members from Excel</h2>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <!-- Step 1: Upload -->
                    <div id="uploadStep">
                        <div class="upload-area" id="dropArea" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <h3>Upload Excel or CSV File</h3>
                            <p>Click to browse or drag and drop your file here</p>
                            <p style="font-size: 0.9em; color: var(--gray);">
                                Supports: .xlsx, .xls, .csv (Max: 10MB)
                            </p>
                            <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls,.csv">
                        </div>
                        
                        <div class="sample-template">
                            <h4><i class="fas fa-download"></i> Download Sample Template</h4>
                            <p>Use this template to ensure correct format:</p>
                            <button class="btn-excel" onclick="gym.downloadTemplate()" style="margin-top: 10px;">
                                <i class="fas fa-download"></i> Download Template
                            </button>
                            <div style="margin-top: 15px; font-size: 0.9em;">
                                <strong>Required Fields:</strong> Full Name, Mobile Number, Join Date
                                <br><strong>Optional Fields:</strong> Father's Name, Age, Height, Date of Birth, Expiry Date
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Preview & Map -->
                    <div id="previewStep" style="display: none;">
                        <div class="file-info" id="fileInfo">
                            <div class="file-name">
                                <i class="fas fa-file-excel"></i>
                                <span id="fileName">No file selected</span>
                            </div>
                            <div class="file-size" id="fileSize">-</div>
                        </div>

                        <div class="mapping-section">
                            <h4><i class="fas fa-columns"></i> Map Excel Columns</h4>
                            <p style="margin-bottom: 15px; color: var(--gray);">
                                Match your Excel columns with our system fields:
                            </p>
                            
                            <div id="columnMapping">
                                <!-- Mappings will be added here -->
                            </div>

                            <div class="form-group" style="margin-top: 20px;">
                                <label for="defaultDuration">Default Membership Duration (if expiry date not in file):</label>
                                <select id="defaultDuration" class="form-control">
                                    <option value="30">30 Days</option>
                                    <option value="90">90 Days</option>
                                    <option value="180">180 Days (6 Months)</option>
                                    <option value="365">365 Days (1 Year)</option>
                                </select>
                            </div>
                        </div>

                        <div style="margin-top: 20px;">
                            <h4><i class="fas fa-eye"></i> Data Preview (First 10 rows)</h4>
                            <div class="preview-table-container" style="max-height: 300px; overflow-y: auto;">
                                <table class="preview-table" id="dataPreview">
                                    <thead>
                                        <tr>
                                            <!-- Headers will be added here -->
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Data will be added here -->
                                    </tbody>
                                </table>
                            </div>
                            <div style="margin-top: 10px; font-size: 0.9em; color: var(--gray);">
                                Showing first 10 rows. Total rows: <span id="totalRows">0</span>
                            </div>
                        </div>

                        <!-- Progress Bar -->
                        <div class="progress-bar" style="display: none;">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-secondary" id="cancelImport">Cancel</button>
                    <button type="button" class="btn-primary" id="processImport" style="display: none;">
                        <i class="fas fa-cogs"></i> Process Import
                    </button>
                    <button type="button" class="btn-success" id="confirmImport" style="display: none;">
                        <i class="fas fa-check"></i> Confirm Import
                    </button>
                </div>
            </div>
        </div>

        <!-- Member Details Modal -->
        <div class="modal" id="detailsModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Member Details</h2>
                    <button class="close-details">&times;</button>
                </div>
                <div class="details-content" id="memberDetails">
                    <!-- Details will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Payment Modal -->
        <div class="modal" id="paymentModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-credit-card"></i> Renew Membership</h2>
                    <button class="close-payment">&times;</button>
                </div>
                <div class="modal-body" id="paymentContent">
                    <!-- Payment content will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Create Workout Plan Modal -->
        <div class="modal" id="createWorkoutModal">
            <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
                <div class="modal-header">
                    <h2><i class="fas fa-dumbbell"></i> Create Workout Plan</h2>
                    <button class="close-modal" onclick="gym.closeAllModals()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Plan Name *</label>
                        <input type="text" id="workoutPlanName" placeholder="e.g., Beginner Full Body, Muscle Building">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" id="workoutPlanDesc" placeholder="Brief description of this plan">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>Days per Week</label>
                            <select id="workoutDaysPerWeek">
                                <option value="3">3 Days</option>
                                <option value="4">4 Days</option>
                                <option value="5" selected>5 Days</option>
                                <option value="6">6 Days</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Level</label>
                            <select id="workoutLevel">
                                <option value="Beginner">Beginner</option>
                                <option value="Intermediate">Intermediate</option>
                                <option value="Advanced">Advanced</option>
                            </select>
                        </div>
                    </div>
                    
                    <h4 style="margin: 20px 0 15px; color: var(--primary);"><i class="fas fa-calendar-week"></i> Weekly Schedule</h4>
                    
                    <div id="workoutDaysContainer">
                        <!-- Days will be added dynamically -->
                    </div>
                    
                    <button type="button" onclick="gym.addWorkoutDay()" class="btn-secondary" style="width: 100%; margin-top: 15px;">
                        <i class="fas fa-plus"></i> Add Day
                    </button>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="gym.closeAllModals()">Cancel</button>
                    <button class="btn-primary" onclick="gym.saveWorkoutPlan()">
                        <i class="fas fa-save"></i> Save Workout Plan
                    </button>
                </div>
            </div>
        </div>

        <!-- Create Diet Plan Modal -->
        <div class="modal" id="createDietModal">
            <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
                <div class="modal-header">
                    <h2><i class="fas fa-utensils"></i> Create Diet Plan</h2>
                    <button class="close-modal" onclick="gym.closeAllModals()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Plan Name *</label>
                        <input type="text" id="dietPlanName" placeholder="e.g., Weight Loss Diet, Muscle Gain Diet">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" id="dietPlanDesc" placeholder="Brief description of this diet plan">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>Goal</label>
                            <select id="dietGoal">
                                <option value="Weight Loss">Weight Loss</option>
                                <option value="Muscle Gain">Muscle Gain</option>
                                <option value="Maintenance">Maintenance</option>
                                <option value="Lean Bulk">Lean Bulk</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Approx. Calories</label>
                            <input type="number" id="dietCalories" placeholder="e.g., 2000">
                        </div>
                    </div>
                    
                    <h4 style="margin: 20px 0 15px; color: #4CAF50;"><i class="fas fa-utensils"></i> Daily Meals</h4>
                    
                    <div id="dietMealsContainer">
                        <!-- Meals will be added dynamically -->
                    </div>
                    
                    <button type="button" onclick="gym.addDietMeal()" class="btn-secondary" style="width: 100%; margin-top: 15px;">
                        <i class="fas fa-plus"></i> Add Meal
                    </button>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="gym.closeAllModals()">Cancel</button>
                    <button class="btn-primary" onclick="gym.saveDietPlan()" style="background: #4CAF50;">
                        <i class="fas fa-save"></i> Save Diet Plan
                    </button>
                </div>
            </div>
        </div>

        <!-- View Plan Modal -->
        <div class="modal" id="viewPlanModal">
            <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
                <div class="modal-header" id="viewPlanHeader">
                    <h2><i class="fas fa-eye"></i> View Plan</h2>
                    <button class="close-modal" onclick="gym.closeAllModals()">&times;</button>
                </div>
                <div class="modal-body" id="viewPlanBody">
                    <!-- Plan details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="gym.closeAllModals()">Close</button>
                </div>
            </div>
        </div>

        <!-- Toast Notification -->
        <div class="toast" id="toast">
            <i class="fas fa-check-circle"></i>
            <span id="toastMessage">Operation completed successfully!</span>
        </div>

        <!-- Update Available Popup -->
        <div id="updatePopup" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; justify-content: center; align-items: center;">
            <div style="background: white; padding: 30px; border-radius: 15px; text-align: center; max-width: 350px; margin: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #4CAF50, #8BC34A); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                    <i class="fas fa-sync-alt" style="font-size: 2.5rem; color: white;"></i>
                </div>
                <h2 style="color: #333; margin-bottom: 10px;"> Update Available!</h2>
                <p style="color: #666; margin-bottom: 25px; font-size: 1rem;">A new version of SG FITNESS EVOLUTION is available with new features and improvements!</p>
                <button onclick="updateApp()" style="background: linear-gradient(135deg, #4CAF50, #8BC34A); color: white; border: none; padding: 15px 40px; border-radius: 30px; font-size: 1.1rem; font-weight: 600; cursor: pointer; width: 100%; box-shadow: 0 4px 15px rgba(76,175,80,0.4);">
                    <i class="fas fa-download"></i> Update Now
                </button>
                <p style="color: #999; font-size: 0.8rem; margin-top: 15px;">Tap to get the latest version</p>
            </div>
        </div>
    </div>

    <script>
        // Check for app updates
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('message', event => {
                if (event.data && event.data.type === 'UPDATE_AVAILABLE') {
                    document.getElementById('updatePopup').style.display = 'flex';
                }
            });

            // Also check on page load if new service worker is waiting
            navigator.serviceWorker.ready.then(registration => {
                registration.addEventListener('updatefound', () => {
                    const newWorker = registration.installing;
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            // New update available
                            document.getElementById('updatePopup').style.display = 'flex';
                        }
                    });
                });
            });
        }

        function updateApp() {
            // Reload the page to get new version
            window.location.reload(true);
        }

        // Complete JavaScript Code with Excel Import
        class GymManagement {
            constructor() {
                this.members = [];
                this.enquiries = [];
                this.notifications = [];
                this.workoutPlans = [];
                this.dietPlans = [];
                this.currentFilter = 'all';
                this.searchQuery = '';
                this.nextId = 1;
                this.currentExpiryOption = 'auto30';
                this.excelData = null;
                this.columnMap = {};
                this.db = null;
                this.workoutDayCount = 0;
                this.dietMealCount = 0;
                this.displayedMemberCount = 50;
                this.memberBatchSize = 50;
                this.searchDebounceTimer = null;
                this.init();
            }

            init() {
                this.loadSavedTheme(); // Load dark mode preference
                this.setupEventListeners();
                this.loadMembers();
                this.loadEnquiries();
                this.loadNotifications();
                this.loadWorkoutPlans();
                this.loadDietPlans();
                this.loadMessageSettings(); // Load message templates
                this.setupExpiryCheck();
                this.updateDashboard();
                this.setupDragAndDrop();
                
                // Check for notifications after a short delay
                setTimeout(() => {
                    this.generateNotifications();
                }, 1500);
            }

            // Debounce utility for performance optimization
            debounce(func, wait) {
                let timeout;
                return (...args) => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), wait);
                };
            }

            setupEventListeners() {
                // Search functionality with debounce for better performance
                const debouncedSearch = this.debounce(() => {
                    this.searchMembers();
                }, 150);
                
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    this.searchQuery = e.target.value;
                    
                    // Auto show members grid when searching
                    if (this.searchQuery.trim()) {
                        this.showMembersGrid();
                    }
                    
                    debouncedSearch();
                });

                document.getElementById('clearSearch').addEventListener('click', () => {
                    document.getElementById('searchInput').value = '';
                    this.searchQuery = '';
                    this.hideMembersGrid();
                    this.searchMembers();
                });

                // Filter buttons
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.currentFilter = e.target.dataset.filter;
                        this.applyFilter();
                    });
                });

                // Add member button
                document.getElementById('addMemberBtn').addEventListener('click', () => {
                    this.openAddMemberModal();
                });

                // Excel import button
                document.getElementById('importExcelBtn').addEventListener('click', () => {
                    this.openExcelImportModal();
                });

                // Export button
                document.getElementById('exportExcelBtn').addEventListener('click', () => {
                    this.exportToExcel();
                });

                // Refresh button
                document.getElementById('refreshBtn').addEventListener('click', () => {
                    this.loadMembers();
                    this.showToast('Data refreshed successfully!');
                });

                // Modal close buttons
                document.querySelectorAll('.close-modal, .close-details, .close-payment').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.closeAllModals();
                    });
                });

                // Member form submission
                document.getElementById('memberForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveMember();
                });

                // Join date change listener
                document.getElementById('joinDate').addEventListener('change', (e) => {
                    this.updateExpiryDateDisplay();
                });

                // Expiry option change listeners
                document.querySelectorAll('input[name="expiryOption"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        this.currentExpiryOption = e.target.value;
                        this.updateExpiryInputs();
                        this.updateExpiryDateDisplay();
                    });
                });

                // Custom days input listener
                document.getElementById('durationDays').addEventListener('input', (e) => {
                    this.updateExpiryDateDisplay();
                });

                // Manual date input listener
                document.getElementById('expiryDate').addEventListener('change', (e) => {
                    this.validateManualExpiryDate();
                });

                // File input listener
                document.getElementById('fileInput').addEventListener('change', (e) => {
                    this.handleFileSelect(e);
                });

                // Import process buttons
                document.getElementById('processImport').addEventListener('click', () => {
                    this.processImport();
                });

                document.getElementById('confirmImport').addEventListener('click', () => {
                    this.confirmImport();
                });

                document.getElementById('cancelImport').addEventListener('click', () => {
                    this.closeAllModals();
                });

                // Click outside modal to close
                window.addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal')) {
                        this.closeAllModals();
                    }
                });

                // Initialize date fields
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('joinDate').min = '2020-01-01';
                document.getElementById('joinDate').max = today;
                document.getElementById('dob').max = today;
                document.getElementById('expiryDate').min = today;
            }

            setupDragAndDrop() {
                const dropArea = document.getElementById('dropArea');
                
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, preventDefaults, false);
                });

                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }

                ['dragenter', 'dragover'].forEach(eventName => {
                    dropArea.addEventListener(eventName, highlight, false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, unhighlight, false);
                });

                function highlight() {
                    dropArea.style.borderColor = 'var(--primary)';
                    dropArea.style.background = 'rgba(74, 111, 165, 0.1)';
                }

                function unhighlight() {
                    dropArea.style.borderColor = 'var(--gray)';
                    dropArea.style.background = 'white';
                }

                dropArea.addEventListener('drop', (e) => {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    if (files.length > 0) {
                        this.handleFileSelect({ target: { files } });
                    }
                }, false);
            }

            handleFileSelect(event) {
                const files = event.target.files;
                if (!files.length) return;

                const file = files[0];
                const fileName = file.name;
                const fileSize = (file.size / 1024 / 1024).toFixed(2); // MB
                
                // Validate file size (max 10MB)
                if (file.size > 10 * 1024 * 1024) {
                    this.showToast('File size should be less than 10MB', 'error');
                    return;
                }

                // Validate file type
                const validExtensions = ['.xlsx', '.xls', '.csv'];
                const fileExt = fileName.substring(fileName.lastIndexOf('.')).toLowerCase();
                if (!validExtensions.includes(fileExt)) {
                    this.showToast('Please select an Excel or CSV file', 'error');
                    return;
                }

                // Update file info
                document.getElementById('fileName').textContent = fileName;
                document.getElementById('fileSize').textContent = fileSize + ' MB';

                // Read the file
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    try {
                        const data = e.target.result;
                        let workbook;
                        
                        if (fileExt === '.csv') {
                            workbook = XLSX.read(data, { type: 'binary', cellDates: true });
                        } else {
                            workbook = XLSX.read(data, { type: 'array', cellDates: true });
                        }
                        
                        // Get first sheet
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        
                        // Convert to JSON
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                        
                        if (jsonData.length === 0) {
                            this.showToast('File is empty', 'error');
                            return;
                        }

                        this.excelData = jsonData;
                        this.showPreview(jsonData);
                        
                    } catch (error) {
                        console.error('Error reading file:', error);
                        this.showToast('Error reading file. Please check the format.', 'error');
                    }
                };

                if (fileExt === '.csv') {
                    reader.readAsBinaryString(file);
                } else {
                    reader.readAsArrayBuffer(file);
                }
            }

            showPreview(data) {
                // Show preview step
                document.getElementById('uploadStep').style.display = 'none';
                document.getElementById('previewStep').style.display = 'block';
                document.getElementById('processImport').style.display = 'inline-flex';
                document.getElementById('confirmImport').style.display = 'none';

                // Get headers (first row)
                const headers = data[0] || [];
                
                // Update total rows
                document.getElementById('totalRows').textContent = data.length - 1;
                
                // Create column mapping UI
                const mappingContainer = document.getElementById('columnMapping');
                mappingContainer.innerHTML = '';
                
                // System fields to map
                const systemFields = [
                    { id: 'fullName', label: 'Full Name *', required: true },
                    { id: 'fatherName', label: 'Father\'s Name', required: false },
                    { id: 'mobileNumber', label: 'Mobile Number *', required: true },
                    { id: 'age', label: 'Age', required: false },
                    { id: 'height', label: 'Height (cm)', required: false },
                    { id: 'dob', label: 'Date of Birth', required: false },
                    { id: 'joinDate', label: 'Join Date *', required: true },
                    { id: 'expiryDate', label: 'Expiry Date', required: false }
                ];
                
                systemFields.forEach(field => {
                    const row = document.createElement('div');
                    row.className = 'mapping-row';
                    
                    const label = document.createElement('label');
                    label.textContent = field.label;
                    label.style.fontWeight = '500';
                    
                    const select = document.createElement('select');
                    select.className = 'form-control';
                    select.id = `map_${field.id}`;
                    
                    // Add options
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = '-- Select Excel Column --';
                    select.appendChild(defaultOption);
                    
                    headers.forEach((header, index) => {
                        if (header) {
                            const option = document.createElement('option');
                            option.value = index;
                            option.textContent = `${header} (Column ${String.fromCharCode(65 + index)})`;
                            select.appendChild(option);
                        }
                    });
                    
                    // Auto-detect common column names
                    const headerText = headers.join(' ').toLowerCase();
                    if (field.id === 'fullName') {
                        if (headerText.includes('name') || headerText.includes('full')) {
                            const nameIndex = headers.findIndex(h => 
                                h && (h.toLowerCase().includes('name') || h.toLowerCase().includes('full')));
                            if (nameIndex !== -1) select.value = nameIndex;
                        }
                    } else if (field.id === 'mobileNumber') {
                        if (headerText.includes('mobile') || headerText.includes('phone') || headerText.includes('contact')) {
                            const mobileIndex = headers.findIndex(h => 
                                h && (h.toLowerCase().includes('mobile') || h.toLowerCase().includes('phone') || h.toLowerCase().includes('contact')));
                            if (mobileIndex !== -1) select.value = mobileIndex;
                        }
                    } else if (field.id === 'joinDate') {
                        if (headerText.includes('join') || headerText.includes('start') || headerText.includes('registration')) {
                            const joinIndex = headers.findIndex(h => 
                                h && (h.toLowerCase().includes('join') || h.toLowerCase().includes('start') || h.toLowerCase().includes('registration')));
                            if (joinIndex !== -1) select.value = joinIndex;
                        }
                    }
                    
                    const status = document.createElement('span');
                    status.id = `status_${field.id}`;
                    status.style.fontSize = '0.9em';
                    status.style.padding = '5px 10px';
                    status.style.borderRadius = '4px';
                    
                    if (field.required) {
                        status.textContent = 'Required';
                        status.style.background = '#fff3cd';
                        status.style.color = '#856404';
                    } else {
                        status.textContent = 'Optional';
                        status.style.background = '#d4edda';
                        status.style.color = '#155724';
                    }
                    
                    row.appendChild(label);
                    row.appendChild(select);
                    row.appendChild(status);
                    mappingContainer.appendChild(row);
                });
                
                // Create preview table
                const previewTable = document.getElementById('dataPreview');
                previewTable.innerHTML = '';
                
                // Create header row
                const thead = previewTable.createTHead();
                const headerRow = thead.insertRow();
                
                headers.forEach((header, index) => {
                    const th = document.createElement('th');
                    th.textContent = `${header} (${String.fromCharCode(65 + index)})`;
                    headerRow.appendChild(th);
                });
                
                // Create data rows (max 10)
                const tbody = document.createElement('tbody');
                const maxRows = Math.min(data.length - 1, 10);
                
                for (let i = 1; i <= maxRows; i++) {
                    const row = data[i];
                    if (!row) continue;
                    
                    const tr = tbody.insertRow();
                    
                    headers.forEach((header, colIndex) => {
                        const td = tr.insertCell();
                        const value = row[colIndex];
                        
                        // Format dates
                        if (value instanceof Date) {
                            td.textContent = value.toISOString().split('T')[0];
                        } else if (value === null || value === undefined) {
                            td.textContent = '';
                            td.style.color = '#999';
                        } else {
                            td.textContent = value;
                        }
                        
                        // Add validation styling
                        if (colIndex === 0 && (!value || value.toString().trim() === '')) {
                            tr.classList.add('error-row');
                        }
                    });
                }
                
                previewTable.appendChild(tbody);
            }

            processImport() {
                // Get mappings
                const mappings = {};
                const requiredFields = ['fullName', 'mobileNumber', 'joinDate'];
                let hasErrors = false;
                
                requiredFields.forEach(field => {
                    const select = document.getElementById(`map_${field}`);
                    const colIndex = parseInt(select.value);
                    
                    if (isNaN(colIndex) || colIndex === '') {
                        hasErrors = true;
                        select.style.borderColor = 'var(--danger)';
                    } else {
                        mappings[field] = colIndex;
                        select.style.borderColor = '';
                    }
                });
                
                // Map optional fields
                ['fatherName', 'age', 'height', 'dob', 'expiryDate'].forEach(field => {
                    const select = document.getElementById(`map_${field}`);
                    const colIndex = parseInt(select.value);
                    if (!isNaN(colIndex) && colIndex !== '') {
                        mappings[field] = colIndex;
                    }
                });
                
                if (hasErrors) {
                    this.showToast('Please map all required fields', 'error');
                    return;
                }
                
                // Validate data
                const errors = [];
                const validRows = [];
                
                for (let i = 1; i < this.excelData.length; i++) {
                    const row = this.excelData[i];
                    const rowErrors = [];
                    
                    // Check required fields
                    if (!row[mappings.fullName] || row[mappings.fullName].toString().trim() === '') {
                        rowErrors.push('Full Name is missing');
                    }
                    
                    if (!row[mappings.mobileNumber] || row[mappings.mobileNumber].toString().trim() === '') {
                        rowErrors.push('Mobile Number is missing');
                    } else {
                        const mobile = row[mappings.mobileNumber].toString().trim();
                        if (!/^\d{10}$/.test(mobile.replace(/\D/g, ''))) {
                            rowErrors.push('Invalid Mobile Number');
                        }
                    }
                    
                    if (!row[mappings.joinDate]) {
                        rowErrors.push('Join Date is missing');
                    }
                    
                    if (rowErrors.length === 0) {
                        validRows.push(i);
                    } else {
                        errors.push(`Row ${i + 1}: ${rowErrors.join(', ')}`);
                    }
                }
                
                // Show errors if any
                if (errors.length > 0) {
                    const errorMessage = `Found ${errors.length} error(s) in ${errors.length} row(s):\n\n${errors.slice(0, 5).join('\n')}`;
                    if (errors.length > 5) {
                        errorMessage += `\n\n... and ${errors.length - 5} more errors`;
                    }
                    
                    if (confirm(`Found ${errors.length} error(s). Show details?`)) {
                        alert(errorMessage);
                    }
                    
                    if (validRows.length === 0) {
                        this.showToast('No valid rows found', 'error');
                        return;
                    }
                }
                
                // Show confirmation with stats
                const totalRows = this.excelData.length - 1;
                const validCount = validRows.length;
                const errorCount = errors.length;
                
                if (confirm(`${validCount} out of ${totalRows} rows are valid. Import ${validCount} members?`)) {
                    this.columnMap = mappings;
                    document.getElementById('processImport').style.display = 'none';
                    document.getElementById('confirmImport').style.display = 'inline-flex';
                    this.showToast(`Ready to import ${validCount} members`, 'success');
                }
            }

            confirmImport() {
                const defaultDuration = parseInt(document.getElementById('defaultDuration').value) || 30;
                const totalRows = this.excelData.length - 1;
                let importedCount = 0;
                let skippedCount = 0;
                
                // Show progress bar
                const progressBar = document.querySelector('.progress-bar');
                const progressFill = document.getElementById('progressFill');
                progressBar.style.display = 'block';
                
                // Process each row
                for (let i = 1; i < this.excelData.length; i++) {
                    const row = this.excelData[i];
                    
                    try {
                        // Skip if any required field is missing
                        if (!row[this.columnMap.fullName] || !row[this.columnMap.mobileNumber] || !row[this.columnMap.joinDate]) {
                            skippedCount++;
                            continue;
                        }
                        
                        // Parse data
                        const fullName = row[this.columnMap.fullName].toString().trim();
                        const fatherName = this.columnMap.fatherName !== undefined ? 
                            (row[this.columnMap.fatherName] || '').toString().trim() : '';
                        const mobileNumber = row[this.columnMap.mobileNumber].toString().trim().replace(/\D/g, '');
                        const age = this.columnMap.age !== undefined ? 
                            parseInt(row[this.columnMap.age]) || null : null;
                        const height = this.columnMap.height !== undefined ? 
                            parseInt(row[this.columnMap.height]) || null : null;
                        
                        // Parse dates
                        let dob = null;
                        if (this.columnMap.dob !== undefined && row[this.columnMap.dob]) {
                            const dobValue = row[this.columnMap.dob];
                            if (dobValue instanceof Date) {
                                dob = dobValue.toISOString().split('T')[0];
                            } else {
                                dob = new Date(dobValue).toISOString().split('T')[0];
                            }
                        }
                        
                        let joinDate = null;
                        const joinValue = row[this.columnMap.joinDate];
                        if (joinValue instanceof Date) {
                            joinDate = joinValue.toISOString().split('T')[0];
                        } else {
                            joinDate = new Date(joinValue).toISOString().split('T')[0];
                        }
                        
                        // Calculate expiry date
                        let expiryDate = null;
                        if (this.columnMap.expiryDate !== undefined && row[this.columnMap.expiryDate]) {
                            const expiryValue = row[this.columnMap.expiryDate];
                            if (expiryValue instanceof Date) {
                                expiryDate = expiryValue.toISOString().split('T')[0];
                            } else {
                                expiryDate = new Date(expiryValue).toISOString().split('T')[0];
                            }
                        } else {
                            // Use default duration
                            const join = new Date(joinDate);
                            join.setDate(join.getDate() + defaultDuration);
                            expiryDate = join.toISOString().split('T')[0];
                        }
                        
                        // Check if mobile number already exists
                        const existingMember = this.members.find(m => m.mobileNumber === mobileNumber);
                        if (existingMember) {
                            skippedCount++;
                            continue;
                        }
                        
                        // Create new member
                        const newMember = {
                            id: this.nextId++,
                            serialNumber: String(this.members.length + 1),
                            fullName: fullName,
                            fatherName: fatherName,
                            mobileNumber: mobileNumber,
                            age: age,
                            height: height,
                            dob: dob,
                            joinDate: joinDate,
                            expiryDate: expiryDate,
                            attendance: [],
                            status: 'active',
                            expiryOption: 'auto30'
                        };
                        
                        // Update status based on expiry
                        const expiry = new Date(expiryDate);
                        const today = new Date();
                        if (expiry < today) {
                            newMember.status = 'expired';
                        } else if (this.isExpiring(newMember)) {
                            newMember.status = 'expiring';
                        }
                        
                        this.members.push(newMember);
                        importedCount++;
                        
                        // Update progress
                        const progress = ((i) / totalRows) * 100;
                        progressFill.style.width = `${progress}%`;
                        
                    } catch (error) {
                        console.error(`Error processing row ${i}:`, error);
                        skippedCount++;
                    }
                }
                
                // Hide progress bar
                progressBar.style.display = 'none';
                
                // Save and update
                this.saveToLocalStorage();
                this.renderMembers();
                this.updateDashboard();
                
                // Show result
                this.showToast(`Successfully imported ${importedCount} members. ${skippedCount} skipped.`, 'success');
                this.closeAllModals();
            }

            downloadTemplate() {
                // Create sample data
                const sampleData = [
                    ['Full Name', 'Father Name', 'Mobile Number', 'Age', 'Height', 'Date of Birth', 'Join Date', 'Expiry Date'],
                    ['John Smith', 'Robert Smith', '9876543210', 25, 175, '1998-05-15', '2024-01-01', '2024-01-31'],
                    ['Sarah Johnson', 'Michael Johnson', '9876543211', 28, 165, '1995-08-22', '2024-01-15', '2024-02-14'],
                    ['Mike Wilson', 'David Wilson', '9876543212', 32, 180, '1991-11-10', '2024-01-10', '2024-02-09']
                ];
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(sampleData);
                
                // Set column widths
                const colWidths = [
                    { wch: 20 }, // Full Name
                    { wch: 15 }, // Father Name
                    { wch: 15 }, // Mobile Number
                    { wch: 5 },  // Age
                    { wch: 8 },  // Height
                    { wch: 12 }, // Date of Birth
                    { wch: 12 }, // Join Date
                    { wch: 12 }  // Expiry Date
                ];
                ws['!cols'] = colWidths;
                
                XLSX.utils.book_append_sheet(wb, ws, 'Members Template');
                
                // Download
                XLSX.writeFile(wb, 'Gym_Members_Template.xlsx');
                this.showToast('Template downloaded successfully!');
            }

            exportToExcel() {
                if (this.members.length === 0) {
                    this.showToast('No members to export', 'warning');
                    return;
                }
                
                // Prepare data
                const exportData = [
                    ['Serial No', 'Full Name', 'Father Name', 'Mobile Number', 'Age', 'Height', 'Date of Birth', 'Join Date', 'Expiry Date', 'Status', 'Attendance Count']
                ];
                
                this.members.forEach(member => {
                    exportData.push([
                        member.serialNumber,
                        member.fullName,
                        member.fatherName || '',
                        member.mobileNumber,
                        member.age || '',
                        member.height || '',
                        member.dob || '',
                        member.joinDate,
                        member.expiryDate,
                        this.getStatusText(member),
                        member.attendance ? member.attendance.length : 0
                    ]);
                });
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(exportData);
                
                // Set column widths
                const colWidths = [
                    { wch: 10 }, // Serial No
                    { wch: 20 }, // Full Name
                    { wch: 15 }, // Father Name
                    { wch: 15 }, // Mobile Number
                    { wch: 5 },  // Age
                    { wch: 8 },  // Height
                    { wch: 12 }, // Date of Birth
                    { wch: 12 }, // Join Date
                    { wch: 12 }, // Expiry Date
                    { wch: 12 }, // Status
                    { wch: 15 }  // Attendance Count
                ];
                ws['!cols'] = colWidths;
                
                XLSX.utils.book_append_sheet(wb, ws, 'Gym Members');
                
                // Download
                const today = new Date().toISOString().split('T')[0];
                XLSX.writeFile(wb, `Gym_Members_Export_${today}.xlsx`);
                this.showToast(`Exported ${this.members.length} members successfully!`);
            }

            openExcelImportModal() {
                const modal = document.getElementById('excelModal');
                
                // Reset modal
                document.getElementById('uploadStep').style.display = 'block';
                document.getElementById('previewStep').style.display = 'none';
                document.getElementById('processImport').style.display = 'none';
                document.getElementById('confirmImport').style.display = 'none';
                document.getElementById('fileInput').value = '';
                document.getElementById('fileName').textContent = 'No file selected';
                document.getElementById('fileSize').textContent = '-';
                document.querySelector('.progress-bar').style.display = 'none';
                
                modal.style.display = 'flex';
            }

            updateExpiryInputs() {
                const autoDisplay = document.getElementById('autoExpiryDisplay');
                const customInput = document.getElementById('customDaysInput');
                const manualInput = document.getElementById('manualDateInput');

                switch(this.currentExpiryOption) {
                    case 'auto30':
                        autoDisplay.style.display = 'block';
                        customInput.style.display = 'none';
                        manualInput.style.display = 'none';
                        break;
                    case 'custom':
                        autoDisplay.style.display = 'none';
                        customInput.style.display = 'block';
                        manualInput.style.display = 'none';
                        break;
                    case 'manual':
                        autoDisplay.style.display = 'none';
                        customInput.style.display = 'none';
                        manualInput.style.display = 'block';
                        break;
                }
            }

            updateExpiryDateDisplay() {
                const joinDateInput = document.getElementById('joinDate').value;
                
                if (!joinDateInput) {
                    document.getElementById('autoExpiryDate').textContent = '-';
                    document.getElementById('calculatedExpiryDate').textContent = '-';
                    return;
                }

                const joinDate = new Date(joinDateInput);
                
                switch(this.currentExpiryOption) {
                    case 'auto30':
                        const autoExpiryDate = new Date(joinDate);
                        autoExpiryDate.setDate(autoExpiryDate.getDate() + 30);
                        document.getElementById('autoExpiryDate').textContent = this.formatDate(autoExpiryDate.toISOString().split('T')[0]);
                        break;
                    
                    case 'custom':
                        const days = parseInt(document.getElementById('durationDays').value) || 30;
                        const calculatedExpiry = new Date(joinDate);
                        calculatedExpiry.setDate(calculatedExpiry.getDate() + days);
                        document.getElementById('calculatedExpiryDate').textContent = this.formatDate(calculatedExpiry.toISOString().split('T')[0]);
                        break;
                    
                    case 'manual':
                        const manualDate = document.getElementById('expiryDate').value;
                        if (manualDate) {
                            document.getElementById('expiryDate').min = joinDateInput;
                        }
                        break;
                }
            }

            // Calculate and show dues preview in Add Member form
            calculateDuesPreview() {
                const selectedPlanId = document.getElementById('selectedPlan').value;
                const amountPaid = parseFloat(document.getElementById('admissionAmount').value) || 0;
                const duesPreviewBox = document.getElementById('duesPreviewBox');
                const duesPreviewText = document.getElementById('duesPreviewText');
                
                if (!selectedPlanId) {
                    duesPreviewBox.style.display = 'none';
                    return;
                }
                
                const plans = JSON.parse(localStorage.getItem('gymPlans')) || [];
                const selectedPlan = plans.find(p => p.id == selectedPlanId);
                
                if (!selectedPlan) {
                    duesPreviewBox.style.display = 'none';
                    return;
                }
                
                const planPrice = selectedPlan.price || 0;
                const dues = Math.max(0, planPrice - amountPaid);
                
                if (dues > 0) {
                    duesPreviewBox.style.display = 'block';
                    duesPreviewText.textContent = `Dues: ${dues} (Plan: ${planPrice} - Paid: ${amountPaid})`;
                } else if (amountPaid > 0) {
                    duesPreviewBox.style.display = 'block';
                    duesPreviewBox.style.background = 'linear-gradient(135deg, #27ae60, #2ecc71)';
                    duesPreviewText.innerHTML = '<i class="fas fa-check-circle"></i> Full Payment Done! No Dues';
                } else {
                    duesPreviewBox.style.display = 'none';
                }
            }

            setPresetDuration(days) {
                document.getElementById('durationDays').value = days;
                document.querySelectorAll('.duration-option').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
                this.updateExpiryDateDisplay();
            }

            validateManualExpiryDate() {
                const joinDate = document.getElementById('joinDate').value;
                const expiryDate = document.getElementById('expiryDate').value;
                
                if (joinDate && expiryDate) {
                    const join = new Date(joinDate);
                    const expiry = new Date(expiryDate);
                    
                    if (expiry <= join) {
                        this.showToast('Expiry date must be after join date!', 'error');
                        document.getElementById('expiryDate').value = '';
                        return false;
                    }
                    
                    // Calculate days difference
                    const diffTime = Math.abs(expiry - join);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    // Update the calculated expiry date display
                    document.getElementById('calculatedExpiryDate').innerHTML = `
                        ${this.formatDate(expiryDate)} 
                        <small style="color: var(--gray);">(${diffDays} days)</small>
                    `;
                }
                return true;
            }

            getCalculatedExpiryDate() {
                const joinDateInput = document.getElementById('joinDate').value;
                if (!joinDateInput) return '';
                
                const joinDate = new Date(joinDateInput);
                
                switch(this.currentExpiryOption) {
                    case 'auto30':
                        const expiryDate = new Date(joinDate);
                        expiryDate.setDate(expiryDate.getDate() + 30);
                        return expiryDate.toISOString().split('T')[0];
                    
                    case 'custom':
                        const days = parseInt(document.getElementById('durationDays').value) || 30;
                        const calculatedExpiry = new Date(joinDate);
                        calculatedExpiry.setDate(calculatedExpiry.getDate() + days);
                        return calculatedExpiry.toISOString().split('T')[0];
                    
                    case 'manual':
                        return document.getElementById('expiryDate').value;
                    
                    default:
                        const defaultExpiry = new Date(joinDate);
                        defaultExpiry.setDate(defaultExpiry.getDate() + 30);
                        return defaultExpiry.toISOString().split('T')[0];
                }
            }

            loadMembers() {
                // Show loading
                const membersGrid = document.getElementById('membersGrid');
                membersGrid.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

                // Simulate API call delay
                setTimeout(() => {
                    // Try to load from localStorage
                    const savedMembers = localStorage.getItem('gymMembers');
                    
                    if (savedMembers) {
                        this.members = JSON.parse(savedMembers);
                        
                        // Fix serial numbers - convert GYM00001 format to simple 1, 2, 3
                        let needsUpdate = false;
                        this.members.forEach((m, index) => {
                            if (m.serialNumber && m.serialNumber.startsWith('GYM')) {
                                // Extract number from GYM00001 format
                                const num = parseInt(m.serialNumber.replace('GYM', ''));
                                m.serialNumber = String(num || (index + 1));
                                needsUpdate = true;
                            }
                        });
                        
                        // Save if updated
                        if (needsUpdate) {
                            localStorage.setItem('gymMembers', JSON.stringify(this.members));
                            this.autoSyncToCloud();
                        }
                        
                        // Update nextId based on existing members
                        if (this.members.length > 0) {
                            this.nextId = Math.max(...this.members.map(m => m.id)) + 1;
                        }
                    } else {
                        // Load sample data
                        this.loadSampleData();
                    }
                    
                    this.renderMembers();
                    this.updateDashboard();
                    this.checkExpiringMembers();
                }, 500);
            }

            loadSampleData() {
                // Create 50 sample members for testing
                const today = new Date();
                const firstNames = ['John', 'Sarah', 'Mike', 'Emma', 'Raj', 'Lisa', 'David', 'Priya', 'Alex', 'Maria'];
                const lastNames = ['Smith', 'Johnson', 'Wilson', 'Davis', 'Patel', 'Wong', 'Brown', 'Lee', 'Chen', 'Gupta'];
                
                this.members = [];
                
                for (let i = 1; i <= 50; i++) {
                    const firstName = firstNames[Math.floor(Math.random() * firstNames.length)];
                    const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
                    const joinDate = new Date(today);
                    joinDate.setDate(joinDate.getDate() - Math.floor(Math.random() * 90));
                    
                    const expiryDate = new Date(joinDate);
                    const duration = [30, 90, 180, 365][Math.floor(Math.random() * 4)];
                    expiryDate.setDate(expiryDate.getDate() + duration);
                    
                    // Random attendance (0-30 days)
                    const attendance = [];
                    const attendanceCount = Math.floor(Math.random() * 30);
                    for (let j = 0; j < attendanceCount; j++) {
                        const attDate = new Date(joinDate);
                        attDate.setDate(attDate.getDate() + Math.floor(Math.random() * 30));
                        attendance.push(attDate.toISOString().split('T')[0]);
                    }
                    
                    this.members.push({
                        id: i,
                        serialNumber: String(i),
                        fullName: `${firstName} ${lastName}`,
                        fatherName: `Father ${lastName}`,
                        mobileNumber: `9876543${String(Math.floor(100 + Math.random() * 900))}`,
                        age: Math.floor(18 + Math.random() * 40),
                        height: 150 + Math.floor(Math.random() * 50),
                        dob: this.randomDate(new Date(1970, 0, 1), new Date(2005, 11, 31)),
                        joinDate: joinDate.toISOString().split('T')[0],
                        expiryDate: expiryDate.toISOString().split('T')[0],
                        attendance: attendance,
                        status: 'active',
                        expiryOption: 'auto30',
                        durationDays: duration
                    });
                }
                
                this.nextId = this.members.length + 1;
                this.saveToLocalStorage();
            }

            randomDate(start, end) {
                const date = new Date(start.getTime() + Math.random() * (end.getTime() - start.getTime()));
                return date.toISOString().split('T')[0];
            }

            saveToLocalStorage() {
                try {
                    localStorage.setItem('gymMembers', JSON.stringify(this.members));
                } catch (e) {
                    if (e.name === 'QuotaExceededError') {
                        this.showToast(' Storage full! Consider exporting old data.', 'warning');
                    } else {
                        console.error('Save error:', e);
                    }
                }
            }

            renderMembers(append = false) {
                const membersGrid = document.getElementById('membersGrid');
                const noResults = document.getElementById('noResults');
                
                let filteredMembers = this.members;
                
                // Apply search filter
                if (this.searchQuery) {
                    const query = this.searchQuery.toLowerCase().trim();
                    const isNumericQuery = /^\d+$/.test(query);
                    
                    filteredMembers = filteredMembers.filter(member => {
                        if (isNumericQuery) {
                            const rollNo = String(member.serialNumber);
                            return rollNo === query || rollNo.startsWith(query);
                        }
                        return member.fullName.toLowerCase().includes(query) ||
                            member.fatherName.toLowerCase().includes(query) ||
                            member.mobileNumber.includes(query);
                    });
                }
                
                // Apply current filter
                filteredMembers = this.applyCurrentFilter(filteredMembers);
                
                if (filteredMembers.length === 0) {
                    membersGrid.innerHTML = `
                        <div class="no-results">
                            <i class="fas fa-user-slash"></i>
                            <h3>No members found</h3>
                            <p>Try adjusting your search or filter criteria</p>
                            ${this.searchQuery ? `<button class="btn-primary" onclick="gym.clearSearch()" style="margin-top: 20px;">
                                <i class="fas fa-times"></i> Clear Search
                            </button>` : ''}
                        </div>
                    `;
                    return;
                }
                
                // Limit display for performance
                const startIndex = append ? this.displayedMemberCount : 0;
                const endIndex = append ? this.displayedMemberCount + this.memberBatchSize : this.displayedMemberCount;
                const membersToDisplay = filteredMembers.slice(startIndex, endIndex);
                
                if (!append) {
                    this.displayedMemberCount = this.memberBatchSize;
                }
                
                // Use DocumentFragment for better performance
                const fragment = document.createDocumentFragment();
                const tempDiv = document.createElement('div');
                
                tempDiv.innerHTML = membersToDisplay.map(member => {
                    const statusClass = this.getStatusClass(member);
                    const statusText = this.getStatusText(member);
                    const isExpiring = this.isExpiring(member);
                    const isExpired = this.isExpired(member);
                    const hasDues = member.dueAmount && member.dueAmount > 0;
                    
                    // Calculate membership type for display
                    let membershipType = '30 Days';
                    if (member.durationDays) {
                        membershipType = `${member.durationDays} Days`;
                    }
                    
                    // Check if member is currently checked in
                    const today = new Date().toISOString().split('T')[0];
                    const records = this.getAttendanceRecords();
                    const isCheckedIn = records.some(r => r.memberId === member.id && r.date === today && !r.exitTime);
                    const attendanceBtnText = isCheckedIn ? 'Check Out' : 'Check In';
                    const attendanceBtnIcon = isCheckedIn ? 'fa-sign-out-alt' : 'fa-sign-in-alt';
                    const attendanceBtnStyle = isCheckedIn ? 'background: linear-gradient(135deg, #f59e0b, #d97706);' : '';
                    
                    return `
                        <div class="member-card ${isExpiring ? 'expiring' : ''} ${isExpired ? 'expired' : ''}" data-id="${member.id}">
                            <div class="member-header">
                                <span class="member-id">${member.serialNumber}</span>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    ${isCheckedIn ? '<span style="background: #22c55e; color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600;"> IN GYM</span>' : ''}
                                    ${hasDues ? `<span class="dues-badge" style="background: var(--danger); color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">${member.dueAmount.toLocaleString()} Due</span>` : ''}
                                    <span class="status-badge ${statusClass}">
                                        ${statusText}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="member-info">
                                <div class="info-row">
                                    <span class="info-label">Name:</span>
                                    <span class="info-value">${member.fullName}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Membership:</span>
                                    <span class="info-value">${membershipType}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Expiry:</span>
                                    <span class="info-value ${isExpiring ? 'text-warning' : ''} ${isExpired ? 'text-danger' : ''}">
                                        ${this.formatDate(member.expiryDate)}
                                        ${isExpiring ? ' ' : ''}
                                    </span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Last Attendance:</span>
                                    <span class="info-value">
                                        ${member.attendance && member.attendance.length > 0 ? 
                                            this.formatDate(member.attendance[member.attendance.length - 1]) : 
                                            'Never'}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="member-actions">
                                <button class="action-btn action-btn-attendance" onclick="gym.markAttendance(${member.id})" style="${attendanceBtnStyle}">
                                    <i class="fas ${attendanceBtnIcon}"></i> ${attendanceBtnText}
                                </button>
                                <button class="action-btn action-btn-details" onclick="gym.showMemberDetails(${member.id})">
                                    <i class="fas fa-info-circle"></i> Details
                                </button>
                                <button class="action-btn action-btn-edit" onclick="gym.editMember(${member.id})">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="action-btn action-btn-delete" onclick="gym.deleteMember(${member.id})">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                                <button class="action-btn action-btn-payment" onclick="gym.openPaymentModal(${member.id})">
                                    <i class="fas fa-rupee-sign"></i> Pay & Extend Membership
                                </button>
                                ${hasDues ? `
                                <button class="action-btn" onclick="gym.payDuesOnly(${member.id})" style="background: linear-gradient(135deg, #28a745, #20c997); color: white;">
                                    <i class="fas fa-money-bill-wave"></i> Pay Dues (${member.dueAmount})
                                </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Render to DOM
                membersGrid.innerHTML = filteredMembers.map(member => {
                    const statusClass = this.getStatusClass(member);
                    const statusText = this.getStatusText(member);
                    const isExpiring = this.isExpiring(member);
                    const isExpired = this.isExpired(member);
                    const hasDues = member.dueAmount && member.dueAmount > 0;
                    
                    let membershipType = '30 Days';
                    if (member.durationDays) {
                        membershipType = `${member.durationDays} Days`;
                    }
                    
                    const today = new Date().toISOString().split('T')[0];
                    const records = this.getAttendanceRecords();
                    const isCheckedIn = records.some(r => r.memberId === member.id && r.date === today && !r.exitTime);
                    const attendanceBtnText = isCheckedIn ? 'Check Out' : 'Check In';
                    const attendanceBtnIcon = isCheckedIn ? 'fa-sign-out-alt' : 'fa-sign-in-alt';
                    const attendanceBtnStyle = isCheckedIn ? 'background: linear-gradient(135deg, #f59e0b, #d97706);' : '';
                    
                    return `
                        <div class="member-card ${isExpiring ? 'expiring' : ''} ${isExpired ? 'expired' : ''}" data-id="${member.id}">
                            <div class="member-header">
                                <span class="member-id">${member.serialNumber}</span>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    ${isCheckedIn ? '<span style="background: #22c55e; color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600;"> IN GYM</span>' : ''}
                                    ${hasDues ? `<span class="dues-badge" style="background: var(--danger); color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">${member.dueAmount.toLocaleString()} Due</span>` : ''}
                                    <span class="status-badge ${statusClass}">
                                        ${statusText}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="member-info">
                                <div class="info-row">
                                    <span class="info-label">Name:</span>
                                    <span class="info-value">${member.fullName}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Membership:</span>
                                    <span class="info-value">${membershipType}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Expiry:</span>
                                    <span class="info-value ${isExpiring ? 'text-warning' : ''} ${isExpired ? 'text-danger' : ''}">
                                        ${this.formatDate(member.expiryDate)}
                                        ${isExpiring ? ' ' : ''}
                                    </span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Last Attendance:</span>
                                    <span class="info-value">
                                        ${member.attendance && member.attendance.length > 0 ? 
                                            this.formatDate(member.attendance[member.attendance.length - 1]) : 
                                            'Never'}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="member-actions">
                                <button class="action-btn action-btn-attendance" onclick="gym.markAttendance(${member.id})" style="${attendanceBtnStyle}">
                                    <i class="fas ${attendanceBtnIcon}"></i> ${attendanceBtnText}
                                </button>
                                <button class="action-btn action-btn-details" onclick="gym.showMemberDetails(${member.id})">
                                    <i class="fas fa-info-circle"></i> Details
                                </button>
                                <button class="action-btn action-btn-edit" onclick="gym.editMember(${member.id})">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="action-btn action-btn-delete" onclick="gym.deleteMember(${member.id})">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                                <button class="action-btn action-btn-payment" onclick="gym.openPaymentModal(${member.id})">
                                    <i class="fas fa-rupee-sign"></i> Pay & Extend Membership
                                </button>
                                ${hasDues ? `
                                <button class="action-btn" onclick="gym.sendDuesReminderWhatsApp('${member.mobileNumber}', '${member.fullName}', ${member.dueAmount})" style="background: linear-gradient(135deg, #25D366, #128C7E); color: white;">
                                    <i class="fab fa-whatsapp"></i> Dues Reminder
                                </button>
                                <button class="action-btn" onclick="gym.payDuesOnly(${member.id})" style="background: linear-gradient(135deg, #28a745, #20c997); color: white;">
                                    <i class="fas fa-money-bill-wave"></i> Pay Dues (${member.dueAmount})
                                </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Update members count badge
                const membersCountBadge = document.getElementById('membersCountBadge');
                if (membersCountBadge) {
                    membersCountBadge.textContent = `${filteredMembers.length} Member${filteredMembers.length !== 1 ? 's' : ''}`;
                }
            }

            searchMembers() {
                // Clear existing timer for debounce
                if (this.searchDebounceTimer) {
                    clearTimeout(this.searchDebounceTimer);
                }
                
                // Debounce search for better performance (300ms delay)
                this.searchDebounceTimer = setTimeout(() => {
                    this.renderMembers();
                }, 300);
            }

            clearSearch() {
                document.getElementById('searchInput').value = '';
                this.searchQuery = '';
                this.searchMembers();
            }

            applyCurrentFilter(members) {
                const today = new Date().toISOString().split('T')[0];
                const sevenDaysLater = new Date();
                sevenDaysLater.setDate(sevenDaysLater.getDate() + 7);
                sevenDaysLater.setHours(0, 0, 0, 0);

                switch (this.currentFilter) {
                    case 'expiring':
                        return members.filter(member => {
                            const expiryDate = new Date(member.expiryDate);
                            const todayDate = new Date();
                            return expiryDate > todayDate && expiryDate <= sevenDaysLater;
                        });
                    case 'today':
                        return members.filter(member => 
                            member.attendance && member.attendance.includes(today)
                        );
                    case 'active':
                        return members.filter(member => {
                            const expiryDate = new Date(member.expiryDate);
                            const todayDate = new Date();
                            return expiryDate > todayDate;
                        });
                    case 'expired':
                        return members.filter(member => {
                            const expiryDate = new Date(member.expiryDate);
                            const todayDate = new Date();
                            return expiryDate < todayDate;
                        });
                    case 'dues':
                        return members.filter(member => 
                            member.dueAmount && member.dueAmount > 0
                        );
                    default:
                        return members;
                }
            }

            applyFilter() {
                this.renderMembers();
            }

            markAttendance(memberId) {
                const member = this.members.find(m => m.id === memberId);
                if (!member) {
                    this.showToast('Member not found!', 'error');
                    return;
                }

                const now = new Date();
                const today = now.toISOString().split('T')[0];
                const time = now.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', hour12: true });

                const records = this.getAttendanceRecords();
                
                // Check if already checked in today without checkout
                const existingRecord = records.find(r => 
                    r.memberId === memberId && r.date === today && !r.exitTime
                );
                
                if (existingRecord) {
                    // Already checked in - do checkout
                    const recordIndex = records.findIndex(r => r.id === existingRecord.id);
                    
                    // Calculate duration
                    const entryTime = this.parseTime(records[recordIndex].entryTime);
                    const exitTime = now;
                    const durationMs = exitTime - entryTime;
                    const durationMinutes = Math.floor(durationMs / 60000);
                    const hours = Math.floor(durationMinutes / 60);
                    const minutes = durationMinutes % 60;
                    const duration = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;

                    // Update record
                    records[recordIndex].exitTime = time;
                    records[recordIndex].duration = duration;
                    
                    this.saveAttendanceRecords(records);
                    this.showToast(` ${member.fullName} checked out. Duration: ${duration}`, 'success');
                } else {
                    // Not checked in - do check-in
                    const newRecord = {
                        id: Date.now().toString(),
                        memberId: memberId,
                        memberName: member.fullName,
                        serialNumber: member.serialNumber,
                        date: today,
                        entryTime: time,
                        exitTime: null,
                        duration: null
                    };

                    records.push(newRecord);
                    this.saveAttendanceRecords(records);
                    
                    // Also update member's attendance array for backward compatibility
                    if (!member.attendance) member.attendance = [];
                    if (!member.attendance.includes(today)) {
                        member.attendance.push(today);
                        member.attendance.sort().reverse();
                    }
                    
                    this.saveToLocalStorage();
                    this.showToast(` ${member.fullName} checked in at ${time}!`, 'success');
                }
                
                this.renderMembers();
                this.updateDashboard();
                
                // Refresh attendance tab if open
                const attTab = document.getElementById('tab-attendance');
                if (attTab && attTab.classList.contains('active')) {
                    this.updateCurrentlyInGym();
                    this.loadAttendanceByDate();
                }
            }

            showMemberDetails(memberId) {
                const member = this.members.find(m => m.id === memberId);
                if (!member) return;

                const modal = document.getElementById('detailsModal');
                const detailsContent = document.getElementById('memberDetails');
                
                // Calculate days until expiry
                const expiryDate = new Date(member.expiryDate);
                const today = new Date();
                const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                
                // Calculate days from join to expiry
                const joinDate = new Date(member.joinDate);
                const totalDays = Math.ceil((expiryDate - joinDate) / (1000 * 60 * 60 * 24));
                
                // Determine membership type
                let membershipType = '30 Days';
                if (member.durationDays) {
                    membershipType = `${member.durationDays} Days`;
                }
                
                // Get dues
                const dueAmount = member.dueAmount || 0;
                
                detailsContent.innerHTML = `
                    <div class="details-grid">
                        <div class="detail-item">
                            <div class="detail-label">Roll Number</div>
                            <div class="detail-value">${member.serialNumber}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Full Name</div>
                            <div class="detail-value">${member.fullName}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Father's Name</div>
                            <div class="detail-value">${member.fatherName}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Mobile Number</div>
                            <div class="detail-value">${member.mobileNumber}</div>
                            <div class="msg-buttons">
                                <button class="btn-whatsapp" onclick="gym.sendWhatsAppOnly('${member.mobileNumber}', '${member.fullName}')">
                                    <i class="fab fa-whatsapp"></i> WhatsApp
                                </button>
                                <button class="btn-sms" onclick="gym.sendSMS('${member.mobileNumber}', '${member.fullName}')">
                                    <i class="fas fa-sms"></i> SMS
                                </button>
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Age</div>
                            <div class="detail-value">${member.age || 'N/A'} years</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Height</div>
                            <div class="detail-value">${member.height || 'N/A'} cm</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Date of Birth</div>
                            <div class="detail-value">${this.formatDate(member.dob)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Join Date</div>
                            <div class="detail-value">${this.formatDate(member.joinDate)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Membership Type</div>
                            <div class="detail-value">${membershipType}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Membership Duration</div>
                            <div class="detail-value">${totalDays} days total</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Expiry Date</div>
                            <div class="detail-value ${daysUntilExpiry <= 7 ? 'text-warning' : ''} ${daysUntilExpiry <= 0 ? 'text-danger' : ''}">
                                ${this.formatDate(member.expiryDate)}
                                ${daysUntilExpiry > 0 ? `(${daysUntilExpiry} days remaining)` : '(Expired)'}
                            </div>
                            <div style="margin-top: 8px;">
                                <button class="btn-primary" onclick="gym.editExpiryDate(${member.id})" style="padding: 6px 12px; font-size: 0.85rem; background: #17a2b8;">
                                    <i class="fas fa-calendar-edit"></i> Edit Expiry Date
                                </button>
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Pending Dues</div>
                            <div class="detail-value" style="color: ${dueAmount > 0 ? 'var(--danger)' : 'var(--success)'}; font-weight: bold;">
                                ${dueAmount > 0 ? `${dueAmount.toLocaleString()}` : 'No Dues '}
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Membership Status</div>
                            <div class="detail-value">
                                <span class="status-badge ${this.getStatusClass(member)}">
                                    ${this.getStatusText(member)}
                                </span>
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Attendance Summary</div>
                            <div class="detail-value">
                                Total: ${member.attendance ? member.attendance.length : 0} days
                            </div>
                        </div>
                        <div class="detail-item attendance-history">
                            <div class="detail-label">Attendance History (Last 10 records)</div>
                            <div class="attendance-list">
                                ${member.attendance && member.attendance.length > 0 ? 
                                    member.attendance.slice(0, 10).map(date => `
                                        <div class="attendance-item">
                                            <i class="fas fa-calendar-check"></i>
                                            ${this.formatDate(date)}
                                            ${date === new Date().toISOString().split('T')[0] ? '<span style="color: var(--success); margin-left: 10px;">(Today)</span>' : ''}
                                        </div>
                                    `).join('') :
                                    '<div class="no-attendance" style="padding: 20px; text-align: center; color: var(--gray);">No attendance records yet</div>'
                                }
                                ${member.attendance && member.attendance.length > 10 ? 
                                    `<div style="text-align: center; padding: 10px; color: var(--gray);">
                                        ... and ${member.attendance.length - 10} more records
                                    </div>` : ''
                                }
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button class="btn-primary" onclick="gym.markAttendance(${member.id}); gym.closeAllModals();" style="flex: 1;">
                            <i class="fas fa-check-circle"></i> Mark Today's Attendance
                        </button>
                        <button class="btn-secondary" onclick="gym.editMember(${member.id})" style="flex: 1;">
                            <i class="fas fa-edit"></i> Edit Member
                        </button>
                    </div>
                `;

                modal.style.display = 'flex';
            }

            payDuesOnly(memberId) {
                const member = this.members.find(m => m.id === memberId);
                if (!member) return;

                const dueAmount = member.dueAmount || 0;
                if (dueAmount <= 0) {
                    this.showToast('No dues pending!', 'warning');
                    return;
                }

                // Create pay dues modal
                const existingModal = document.getElementById('payDuesModal');
                if (existingModal) existingModal.remove();

                const modal = document.createElement('div');
                modal.id = 'payDuesModal';
                modal.className = 'modal';
                modal.style.display = 'flex';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 420px;">
                        <div class="modal-header" style="background: linear-gradient(135deg, #28a745, #20c997);">
                            <h2><i class="fas fa-money-bill-wave"></i> Pay Dues</h2>
                            <span class="close-modal" onclick="document.getElementById('payDuesModal').remove()">&times;</span>
                        </div>
                        <div class="modal-body" style="padding: 20px;">
                            <div style="background: var(--bg-secondary); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                                <p style="margin-bottom: 8px; color: var(--text-secondary);">Member: <strong style="color: var(--text-primary);">${member.fullName}</strong></p>
                                <p style="margin-bottom: 8px; color: var(--text-secondary);">Roll No: <strong style="color: var(--text-primary);">${member.serialNumber}</strong></p>
                                <p style="color: var(--danger); font-size: 1.2rem; font-weight: bold;">
                                    <i class="fas fa-exclamation-circle"></i> Total Dues: ${dueAmount.toLocaleString()}
                                </p>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Amount Paying:</label>
                                <input type="number" id="duesPayAmount" value="${dueAmount}" max="${dueAmount}" min="1" 
                                    style="width: 100%; padding: 12px; border: 2px solid #28a745; border-radius: 8px; font-size: 1.1rem; font-weight: bold;"
                                    oninput="document.getElementById('remainingDues').textContent = '' + Math.max(0, ${dueAmount} - (this.value || 0)).toLocaleString()">
                                <small style="color: var(--text-secondary);">Enter partial or full amount</small>
                            </div>
                            
                            <div style="background: #fff3cd; padding: 10px 15px; border-radius: 8px; margin-bottom: 15px;">
                                <span style="color: #856404;">Remaining after payment: </span>
                                <strong id="remainingDues" style="color: #856404;">0</strong>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Payment Mode:</label>
                                <select id="duesPaymentMode" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem;">
                                    <option value="Online"> Online</option>
                                    <option value="Cash"> Cash</option>
                                    <option value="UPI"> UPI</option>
                                </select>
                            </div>
                            
                            <div style="margin-top: 20px; display: flex; gap: 10px;">
                                <button class="btn-secondary" onclick="document.getElementById('payDuesModal').remove()" style="flex: 1;">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                                <button class="btn-primary" onclick="gym.saveDuesPayment(${member.id})" style="flex: 1; background: #28a745;">
                                    <i class="fas fa-check"></i> Pay Now
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            saveDuesPayment(memberId) {
                const payAmount = parseFloat(document.getElementById('duesPayAmount').value) || 0;
                const paymentMode = document.getElementById('duesPaymentMode').value;

                if (payAmount <= 0) {
                    this.showToast('Please enter a valid amount', 'error');
                    return;
                }

                const member = this.members.find(m => m.id === memberId);
                if (!member) return;

                const oldDues = member.dueAmount || 0;
                
                if (payAmount > oldDues) {
                    this.showToast('Amount cannot be more than dues', 'error');
                    return;
                }

                // Update dues
                member.dueAmount = oldDues - payAmount;
                
                // Determine payment type based on whether dues are fully cleared
                const paymentType = member.dueAmount === 0 ? 'Dues Cleared' : 'Dues Payment';

                // Add to payment history
                if (!member.paymentHistory) {
                    member.paymentHistory = [];
                }

                const today = new Date();
                member.paymentHistory.push({
                    date: today.toISOString().split('T')[0],
                    amount: payAmount,
                    type: paymentType,
                    mode: paymentMode,
                    note: member.dueAmount === 0 
                        ? ` All dues cleared! Previous: ${oldDues}, Paid: ${payAmount}` 
                        : `Dues payment - Previous: ${oldDues}, Paid: ${payAmount}, Remaining: ${member.dueAmount}`,
                    timestamp: today.toISOString()
                });

                this.saveToLocalStorage();
                this.autoSyncToCloud();
                this.renderMembers();
                this.updateDashboard();

                // Close modal and refresh details
                document.getElementById('payDuesModal').remove();
                this.showMemberDetails(memberId);

                // Send WhatsApp receipt message
                const receiptDate = today.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
                let receiptMsg = `Namaste *${member.fullName}* ji \n\n`;
                receiptMsg += `*SG FITNESS EVOLUTION*\n`;
                receiptMsg += ` *Dues Payment Receipt*\n\n`;
                receiptMsg += ` Date: ${receiptDate}\n`;
                receiptMsg += ` Roll No: ${member.serialNumber}\n\n`;
                receiptMsg += ` *Payment Details:*\n`;
                receiptMsg += ` Pichle Dues: ${oldDues.toLocaleString()}\n`;
                receiptMsg += ` Abhi Paid: ${payAmount.toLocaleString()}\n`;
                receiptMsg += ` Mode: ${paymentMode}\n`;
                
                if (member.dueAmount > 0) {
                    receiptMsg += `\n *Baki Dues: ${member.dueAmount.toLocaleString()}*\n\n`;
                    receiptMsg += `Kripya apni suvidha anusaar baki amount pay kar dein.\n`;
                    receiptMsg += ` Payment: Cash / UPI / Online\n`;
                } else {
                    receiptMsg += `\n *Baki Dues: 0 (All Clear!)*\n\n`;
                    receiptMsg += ` Badhai ho! Aapke sabhi dues clear ho gaye!\n`;
                }
                
                receiptMsg += `\nAapka dhanyavaad! \n`;
                receiptMsg += `_Gym mein milte hain!_ `;
                
                // Store receipt message for later use
                this.lastDuesReceiptMsg = receiptMsg;
                this.lastDuesMemberId = memberId;

                if (member.dueAmount === 0) {
                    // Dues fully cleared - show options modal
                    this.showDuesClearedOptions(memberId, receiptMsg, payAmount);
                } else {
                    // Partial payment - open WhatsApp directly
                    let cleanPhone = member.mobileNumber.replace(/\D/g, '');
                    if (cleanPhone.length > 10) cleanPhone = cleanPhone.slice(-10);
                    const whatsappUrl = `https://wa.me/91${cleanPhone}?text=${encodeURIComponent(receiptMsg)}`;
                    window.open(whatsappUrl, '_blank');
                    this.showToast(` ${payAmount} dues paid! Remaining: ${member.dueAmount}`, 'success');
                }
            }
            
            // Show options after dues are fully cleared
            showDuesClearedOptions(memberId, receiptMsg, payAmount) {
                const member = this.members.find(m => m.id === memberId);
                if (!member) return;
                
                const existingModal = document.getElementById('duesClearedModal');
                if (existingModal) existingModal.remove();
                
                // Store memberId for button handlers
                this.lastDuesClearedMemberId = memberId;
                
                const modal = document.createElement('div');
                modal.id = 'duesClearedModal';
                modal.className = 'modal';
                modal.style.display = 'flex';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 450px; text-align: center;">
                        <div class="modal-header" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white;">
                            <h2 style="margin: 0;"><i class="fas fa-check-circle"></i> Dues Cleared!</h2>
                        </div>
                        <div class="modal-body" style="padding: 30px;">
                            <div style="font-size: 4rem; margin-bottom: 20px;"></div>
                            <h3 style="color: #28a745; margin-bottom: 15px;">All Dues Cleared Successfully!</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 25px;">
                                <strong>${member.fullName}</strong> has paid ${payAmount.toLocaleString()}<br>
                                All dues are now cleared!
                            </p>
                            
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <button onclick="gym.sendDuesClearedWhatsApp()" class="btn-primary" style="padding: 15px 25px; background: #25D366; border: none; font-size: 1rem;">
                                    <i class="fab fa-whatsapp"></i> Send WhatsApp Message
                                </button>
                                <button onclick="gym.sendDuesClearedSMS()" class="btn-primary" style="padding: 15px 25px; background: #007bff; border: none; font-size: 1rem;">
                                    <i class="fas fa-sms"></i> Send SMS Message
                                </button>
                                <button onclick="document.getElementById('duesClearedModal').remove()" class="btn-secondary" style="padding: 12px 25px;">
                                    <i class="fas fa-times"></i> Close
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Show success toast
                this.showToast(' All dues cleared successfully!', 'success');
            }
            
            // Send WhatsApp message for dues cleared
            sendDuesClearedWhatsApp() {
                const memberId = this.lastDuesClearedMemberId;
                const member = this.members.find(m => m.id === memberId);
                if (!member) {
                    this.showToast('Member not found', 'error');
                    return;
                }
                
                let cleanPhone = member.mobileNumber.replace(/\D/g, '');
                if (cleanPhone.length > 10) cleanPhone = cleanPhone.slice(-10);
                
                const clearedMsg = this.getFormattedMessage('duesCleared', { name: member.fullName });
                const whatsappUrl = `https://wa.me/91${cleanPhone}?text=${encodeURIComponent(clearedMsg)}`;
                window.open(whatsappUrl, '_blank');
                
                document.getElementById('duesClearedModal')?.remove();
                this.showToast('Opening WhatsApp...', 'success');
            }
            
            // Send SMS message for dues cleared
            sendDuesClearedSMS() {
                const memberId = this.lastDuesClearedMemberId;
                const member = this.members.find(m => m.id === memberId);
                if (!member) {
                    this.showToast('Member not found', 'error');
                    return;
                }
                
                let cleanPhone = member.mobileNumber.replace(/\D/g, '');
                if (cleanPhone.length > 10) cleanPhone = cleanPhone.slice(-10);
                
                const clearedMsg = this.getFormattedMessage('duesCleared', { name: member.fullName });
                const smsUrl = `sms:${cleanPhone}?body=${encodeURIComponent(clearedMsg)}`;
                window.open(smsUrl, '_blank');
                
                document.getElementById('duesClearedModal')?.remove();
                this.showToast('Opening SMS...', 'success');
            }

            editExpiryDate(memberId) {
                const member = this.members.find(m => m.id === memberId);
                if (!member) return;

                // Create edit expiry modal
                const existingModal = document.getElementById('editExpiryModal');
                if (existingModal) existingModal.remove();

                const modal = document.createElement('div');
                modal.id = 'editExpiryModal';
                modal.className = 'modal';
                modal.style.display = 'flex';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 400px;">
                        <div class="modal-header">
                            <h2><i class="fas fa-calendar-alt"></i> Edit Expiry Date</h2>
                            <span class="close-modal" onclick="document.getElementById('editExpiryModal').remove()">&times;</span>
                        </div>
                        <div class="modal-body" style="padding: 20px;">
                            <p style="margin-bottom: 15px; color: var(--text-secondary);">Member: <strong>${member.fullName}</strong></p>
                            <p style="margin-bottom: 15px; color: var(--text-secondary);">Current Expiry: <strong>${this.formatDate(member.expiryDate)}</strong></p>
                            <div class="form-group">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">New Expiry Date:</label>
                                <input type="date" id="newExpiryDate" value="${member.expiryDate}" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem;">
                            </div>
                            <div style="margin-top: 20px; display: flex; gap: 10px;">
                                <button class="btn-secondary" onclick="document.getElementById('editExpiryModal').remove()" style="flex: 1;">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                                <button class="btn-primary" onclick="gym.saveNewExpiryDate(${member.id})" style="flex: 1; background: #28a745;">
                                    <i class="fas fa-save"></i> Save
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            saveNewExpiryDate(memberId) {
                const newExpiry = document.getElementById('newExpiryDate').value;
                if (!newExpiry) {
                    this.showToast('Please select a date', 'error');
                    return;
                }

                const member = this.members.find(m => m.id === memberId);
                if (!member) return;

                const oldExpiry = member.expiryDate;
                member.expiryDate = newExpiry;

                // Update status based on new expiry
                const today = new Date();
                const expiryDate = new Date(newExpiry);
                if (expiryDate < today) {
                    member.status = 'expired';
                } else {
                    member.status = 'active';
                }

                this.saveToLocalStorage();
                this.autoSyncToCloud();
                this.renderMembers();
                this.updateDashboard();

                // Close edit modal and refresh details
                document.getElementById('editExpiryModal').remove();
                this.showMemberDetails(memberId);
                
                this.showToast(`Expiry date updated: ${this.formatDate(oldExpiry)}  ${this.formatDate(newExpiry)}`, 'success');
            }

            openAddMemberModal() {
                const modal = document.getElementById('memberModal');
                const form = document.getElementById('memberForm');
                const title = document.getElementById('modalTitle');
                
                title.textContent = 'Add New Member';
                form.reset();
                document.getElementById('memberId').value = '';
                document.getElementById('serialNumber').value = '';
                
                // Show New Admission section when adding new member
                const newAdmissionSection = document.getElementById('newAdmissionSection');
                if (newAdmissionSection) {
                    newAdmissionSection.style.display = 'block';
                    document.getElementById('isNewAdmission').checked = true;
                }
                
                // Load plans dropdown
                this.loadPlansDropdown();
                
                // Reset expiry options
                document.getElementById('auto30days').checked = true;
                this.currentExpiryOption = 'auto30';
                this.updateExpiryInputs();
                
                // Set default dates
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('joinDate').value = today;
                document.getElementById('expiryDate').value = '';
                document.getElementById('expiryDate').min = today;
                document.getElementById('durationDays').value = '30';
                
                // Update expiry display
                this.updateExpiryDateDisplay();
                
                modal.style.display = 'flex';
                
                // Focus on serial number field
                setTimeout(() => {
                    document.getElementById('serialNumber').focus();
                }, 100);
            }

            editMember(memberId) {
                const member = this.members.find(m => m.id === memberId);
                if (!member) {
                    this.showToast('Member not found!', 'error');
                    return;
                }

                // Close any open modals first
                this.closeAllModals();

                const modal = document.getElementById('memberModal');
                const form = document.getElementById('memberForm');
                const title = document.getElementById('modalTitle');
                
                title.textContent = 'Edit Member';
                
                // Hide New Admission section when editing
                const newAdmissionSection = document.getElementById('newAdmissionSection');
                if (newAdmissionSection) {
                    newAdmissionSection.style.display = 'none';
                }
                
                // Load plans dropdown
                this.loadPlansDropdown(member.planId);
                
                // Fill form with member data
                document.getElementById('memberId').value = member.id;
                document.getElementById('serialNumber').value = member.serialNumber || '';
                document.getElementById('fullName').value = member.fullName;
                document.getElementById('fatherName').value = member.fatherName || '';
                document.getElementById('mobileNumber').value = member.mobileNumber;
                document.getElementById('age').value = member.age || '';
                document.getElementById('height').value = member.height || '';
                document.getElementById('dob').value = member.dob || '';
                document.getElementById('joinDate').value = member.joinDate;
                
                // Set expiry option based on stored data
                const expiryOption = member.expiryOption || 'auto30';
                const radioBtn = document.getElementById(expiryOption === 'auto30' ? 'auto30days' : expiryOption === 'custom' ? 'customDays' : 'manualDate');
                if (radioBtn) radioBtn.checked = true;
                this.currentExpiryOption = expiryOption;
                this.updateExpiryInputs();
                
                // Set additional fields based on expiry option
                if (expiryOption === 'custom' && member.durationDays) {
                    document.getElementById('durationDays').value = member.durationDays;
                }
                if (expiryOption === 'manual') {
                    document.getElementById('expiryDate').value = member.expiryDate;
                }
                
                this.updateExpiryDateDisplay();
                
                modal.style.display = 'flex';
            }

            saveMember() {
                const form = document.getElementById('memberForm');
                const memberId = document.getElementById('memberId').value;
                
                // Validate form
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                
                const mobileNumber = document.getElementById('mobileNumber').value.trim();
                const serialNumber = document.getElementById('serialNumber').value.trim();
                
                // Check for duplicate phone number (only for new members)
                if (!memberId) {
                    const existingMember = this.members.find(m => m.mobileNumber === mobileNumber);
                    if (existingMember) {
                        this.showToast(` Member already exists with this phone number!\n\nName: ${existingMember.fullName}\nRoll No: ${existingMember.serialNumber}`, 'error');
                        return;
                    }
                    
                    // Check for duplicate roll number
                    const existingRoll = this.members.find(m => m.serialNumber === serialNumber);
                    if (existingRoll) {
                        this.showToast(` Roll Number ${serialNumber} already exists!\n\nName: ${existingRoll.fullName}`, 'error');
                        return;
                    }
                }
                
                // Validate expiry date if manual option selected
                if (this.currentExpiryOption === 'manual') {
                    if (!this.validateManualExpiryDate()) {
                        return;
                    }
                }
                
                const now = new Date();
                const today = now.toISOString().split('T')[0];
                const currentTime = now.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', hour12: true });
                const expiryDate = this.getCalculatedExpiryDate();
                
                if (!expiryDate) {
                    this.showToast('Please set a valid expiry date!', 'error');
                    return;
                }
                
                const memberData = {
                    serialNumber: serialNumber,
                    fullName: document.getElementById('fullName').value.trim(),
                    fatherName: document.getElementById('fatherName').value.trim(),
                    mobileNumber: mobileNumber,
                    age: parseInt(document.getElementById('age').value) || null,
                    height: parseInt(document.getElementById('height').value) || null,
                    dob: document.getElementById('dob').value || null,
                    joinDate: document.getElementById('joinDate').value,
                    joinTime: currentTime,
                    expiryDate: expiryDate,
                    planId: document.getElementById('selectedPlan').value || null,
                    attendance: [],
                    status: 'active',
                    expiryOption: this.currentExpiryOption
                };
                
                // Add duration days if custom option
                if (this.currentExpiryOption === 'custom') {
                    memberData.durationDays = parseInt(document.getElementById('durationDays').value) || 30;
                }

                if (memberId) {
                    // Update existing member
                    const index = this.members.findIndex(m => m.id === parseInt(memberId));
                    if (index !== -1) {
                        // Preserve attendance history
                        memberData.attendance = this.members[index].attendance || [];
                        memberData.status = this.members[index].status;
                        memberData.id = this.members[index].id;
                        this.members[index] = { ...this.members[index], ...memberData };
                        this.showToast(`Member ${memberData.fullName} updated successfully!`);
                    }
                } else {
                    // Add new member
                    memberData.id = this.nextId++;
                    
                    // Add admission payment record if amount is provided
                    const admissionAmount = parseFloat(document.getElementById('admissionAmount').value) || 0;
                    const admissionPaymentMode = document.getElementById('admissionPaymentMode').value || 'Cash';
                    
                    // Get plan price to calculate dues
                    const selectedPlanId = document.getElementById('selectedPlan').value;
                    const plans = JSON.parse(localStorage.getItem('gymPlans')) || [];
                    const selectedPlan = plans.find(p => p.id == selectedPlanId);
                    const planPrice = selectedPlan ? selectedPlan.price : 0;
                    
                    // Calculate dues (Plan Price - Amount Paid)
                    const dueAmount = planPrice > 0 ? Math.max(0, planPrice - admissionAmount) : 0;
                    
                    // Set dues on member
                    if (dueAmount > 0) {
                        memberData.dueAmount = dueAmount;
                    }
                    
                    // Set duration days from plan
                    if (selectedPlan && selectedPlan.days) {
                        memberData.durationDays = selectedPlan.days;
                    }
                    
                    if (admissionAmount > 0 || planPrice > 0) {
                        memberData.paymentHistory = [{
                            date: today,
                            time: currentTime,
                            timestamp: now.toISOString(),
                            planAmount: planPrice,
                            amount: admissionAmount,
                            dueAmount: dueAmount,
                            type: 'Admission',
                            mode: admissionPaymentMode,
                            isAdmission: true
                        }];
                    }
                    
                    this.members.push(memberData);
                    this.showToast(`Member ${memberData.fullName} added successfully!`);
                    
                    // Check if today is member's birthday and add notification
                    this.checkAndAddBirthdayNotification(memberData);
                    
                    // Mark enquiry as converted if this was from enquiry conversion
                    this.markEnquiryConverted();
                    
                    // Check if New Admission checkbox is checked - show welcome message popup
                    const isNewAdmission = document.getElementById('isNewAdmission')?.checked;
                    if (isNewAdmission) {
                        // Save first then show welcome popup
                        this.saveToLocalStorage();
                        this.autoSyncToCloud();
                        this.renderMembers();
                        this.updateDashboard();
                        this.closeAllModals();
                        
                        // Show welcome message popup
                        this.showWelcomeMessagePopup(memberData);
                        return; // Exit early as we already saved
                    }
                }
                
                // Update status based on expiry
                this.updateMemberStatus(memberData.id || memberId);
                
                this.saveToLocalStorage();
                this.autoSyncToCloud(); // Auto sync to cloud
                this.renderMembers();
                this.updateDashboard();
                this.closeAllModals();
            }

            showWelcomeMessagePopup(member) {
                const existingModal = document.getElementById('welcomeMessageModal');
                if (existingModal) existingModal.remove();

                const settings = JSON.parse(localStorage.getItem('gymSettings')) || {};
                const gymName = settings.gymName || 'SG FITNESS EVOLUTION';

                const modal = document.createElement('div');
                modal.id = 'welcomeMessageModal';
                modal.className = 'modal';
                modal.style.display = 'flex';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 450px;">
                        <div class="modal-header" style="background: linear-gradient(135deg, #4CAF50, #8BC34A);">
                            <h2><i class="fas fa-user-check"></i> Member Added!</h2>
                            <span class="close-modal" onclick="document.getElementById('welcomeMessageModal').remove()">&times;</span>
                        </div>
                        <div class="modal-body" style="padding: 25px; text-align: center;">
                            <div style="font-size: 4rem; margin-bottom: 15px;"></div>
                            <h3 style="color: var(--success); margin-bottom: 10px;">Welcome to ${gymName}!</h3>
                            
                            <div style="background: var(--bg-secondary); padding: 15px; border-radius: 10px; margin: 20px 0; text-align: left;">
                                <p style="margin: 5px 0;"><strong>Name:</strong> ${member.fullName}</p>
                                <p style="margin: 5px 0;"><strong>Roll No:</strong> ${member.serialNumber}</p>
                                <p style="margin: 5px 0;"><strong>Mobile:</strong> ${member.mobileNumber}</p>
                                <p style="margin: 5px 0;"><strong>Valid Till:</strong> ${this.formatDate(member.expiryDate)}</p>
                            </div>
                            
                            <p style="color: var(--text-secondary); margin-bottom: 20px;">Send welcome message to new member:</p>
                            
                            <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                                <button class="btn-whatsapp" onclick="gym.sendWelcomeWhatsApp('${member.mobileNumber}', '${member.fullName}', '${member.serialNumber}', '${member.expiryDate}')" style="padding: 12px 25px; font-size: 1rem;">
                                    <i class="fab fa-whatsapp"></i> WhatsApp
                                </button>
                                <button class="btn-sms" onclick="gym.sendWelcomeSMS('${member.mobileNumber}', '${member.fullName}', '${member.serialNumber}', '${member.expiryDate}')" style="padding: 12px 25px; font-size: 1rem;">
                                    <i class="fas fa-sms"></i> SMS
                                </button>
                            </div>
                            
                            <button class="btn-secondary" onclick="document.getElementById('welcomeMessageModal').remove()" style="margin-top: 20px; padding: 10px 30px;">
                                <i class="fas fa-times"></i> Skip
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            sendWelcomeWhatsApp(mobile, name, rollNo, validTill) {
                // Clean phone number - remove all non-digits and add 91
                let cleanPhone = mobile.replace(/\D/g, '');
                if (cleanPhone.startsWith('91') && cleanPhone.length > 10) {
                    cleanPhone = cleanPhone.substring(2);
                }
                if (cleanPhone.startsWith('0')) {
                    cleanPhone = cleanPhone.substring(1);
                }
                if (cleanPhone.length > 10) {
                    cleanPhone = cleanPhone.slice(-10);
                }
                const formattedPhone = '91' + cleanPhone;
                
                const settings = JSON.parse(localStorage.getItem('gymSettings')) || {};
                const gymName = settings.gymName || 'SG FITNESS EVOLUTION';
                const gymPhone = settings.phone || '9876543210';
                const gymAddress = settings.address || 'Your Gym Address';
                const today = new Date().toLocaleDateString('en-IN');
                
                // Format valid till date
                const validDate = new Date(validTill);
                const formattedValidTill = validDate.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });

                const message = ` *${gymName}*

 *Welcome to our Gym Family!*

Namaste *${name}* Ji! 

Thank you for joining us! 

*Your Details:*
 Roll No: ${rollNo}
 Join Date: ${today}
 Valid Till: ${formattedValidTill}

Aapka aur aapki family ka swasthya humesha achha rahe! Stay fit, stay healthy! 

 ${gymAddress}
 ${gymPhone}

*Welcome aboard!* `;

                const whatsappUrl = `https://wa.me/${formattedPhone}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
                this.showToast('Opening WhatsApp...', 'success');
                
                // Close welcome modal
                const modal = document.getElementById('welcomeMessageModal');
                if (modal) modal.remove();
            }

            sendWelcomeSMS(mobile, name, rollNo, validTill) {
                // Clean phone number
                let cleanPhone = mobile.replace(/\D/g, '');
                if (cleanPhone.length > 10) {
                    cleanPhone = cleanPhone.slice(-10);
                }
                
                const settings = JSON.parse(localStorage.getItem('gymSettings')) || {};
                const gymName = settings.gymName || 'SG FITNESS EVOLUTION';
                const gymPhone = settings.phone || '9876543210';
                const today = new Date().toLocaleDateString('en-IN');
                
                // Format valid till date
                const validDate = new Date(validTill);
                const formattedValidTill = validDate.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });

                const message = `Welcome to ${gymName}!

Namaste ${name} Ji!

Thank you for joining us!

Roll No: ${rollNo}
Join Date: ${today}
Valid Till: ${formattedValidTill}

Aapka aur aapki family ka swasthya humesha achha rahe! Stay fit!

Contact: ${gymPhone}`;

                const smsUrl = `sms:${cleanPhone}?body=${encodeURIComponent(message)}`;
                window.open(smsUrl, '_blank');
                this.showToast('Opening SMS...', 'success');
                
                // Close welcome modal
                const modal = document.getElementById('welcomeMessageModal');
                if (modal) modal.remove();
            }

            deleteMember(memberId) {
                const member = this.members.find(m => m.id === memberId);
                if (!member) return;

                if (!confirm(`Are you sure you want to delete member ${member.fullName} (${member.serialNumber})? This action cannot be undone.`)) {
                    return;
                }

                this.members = this.members.filter(m => m.id !== memberId);
                this.saveToLocalStorage();
                this.autoSyncToCloud(); // Auto sync to cloud
                this.renderMembers();
                this.updateDashboard();
                this.showToast(`Member ${member.fullName} deleted successfully!`);
            }

            updateDashboard() {
                const today = new Date().toISOString().split('T')[0];
                const sevenDaysLater = new Date();
                sevenDaysLater.setDate(sevenDaysLater.getDate() + 7);
                sevenDaysLater.setHours(0, 0, 0, 0);
                
                // Total members
                document.getElementById('totalMembers').textContent = this.members.length;
                
                // Update members count badge
                this.updateMembersCountBadge();
                
                // Today's attendance - FIXED: Use attendanceRecords instead of member.attendance
                // This ensures consistency with Attendance page count
                const attendanceRecords = this.getAttendanceRecords();
                const todayAttendance = attendanceRecords.filter(r => r.date === today).length;
                document.getElementById('todayAttendance').textContent = todayAttendance;
                
                // Expiring soon (within 7 days)
                const expiringSoon = this.members.filter(member => {
                    const expiryDate = new Date(member.expiryDate);
                    const todayDate = new Date();
                    return expiryDate > todayDate && expiryDate <= sevenDaysLater;
                }).length;
                document.getElementById('expiringSoon').textContent = expiringSoon;
                
                // Active members
                const activeMembers = this.members.filter(member => {
                    const expiryDate = new Date(member.expiryDate);
                    const todayDate = new Date();
                    return expiryDate > todayDate;
                }).length;
                document.getElementById('activeMembers').textContent = activeMembers;
                
                // Total Dues
                const totalDues = this.members.reduce((sum, member) => {
                    return sum + (member.dueAmount || 0);
                }, 0);
                document.getElementById('totalDues').textContent = `${totalDues.toLocaleString()}`;
                
                // Update Today's Attendance section
                this.updateTodayAttendanceSection();
            }

            // Toggle Today's Attendance section visibility
            toggleTodayAttendance() {
                const list = document.getElementById('todayAttList');
                const arrow = document.getElementById('todayAttArrow');
                
                if (list.style.maxHeight === '0px' || list.style.maxHeight === '') {
                    list.style.maxHeight = '400px';
                    arrow.style.transform = 'rotate(180deg)';
                } else {
                    list.style.maxHeight = '0px';
                    arrow.style.transform = 'rotate(0deg)';
                }
            }

            // Update Today's Attendance section with member list
            updateTodayAttendanceSection() {
                const today = new Date().toISOString().split('T')[0];
                const records = this.getAttendanceRecords();
                const todayRecords = records.filter(r => r.date === today);
                
                // Update badge
                const badge = document.getElementById('todayAttBadge');
                if (badge) badge.textContent = todayRecords.length;
                
                const listDiv = document.getElementById('todayAttList');
                if (!listDiv) return;
                
                if (todayRecords.length === 0) {
                    listDiv.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: var(--text-secondary);">
                            <i class="fas fa-calendar-times" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;"></i>
                            <p>No attendance recorded today</p>
                        </div>
                    `;
                    return;
                }
                
                // Sort by entry time (most recent first)
                todayRecords.sort((a, b) => {
                    const timeA = this.parseTime(a.entryTime);
                    const timeB = this.parseTime(b.entryTime);
                    return timeB - timeA;
                });
                
                listDiv.innerHTML = todayRecords.map(record => {
                    const isInGym = !record.exitTime;
                    return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid var(--border-color);">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 35px; height: 35px; background: ${isInGym ? '#dcfce7' : '#f3f4f6'}; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-user" style="color: ${isInGym ? '#16a34a' : '#6b7280'};"></i>
                                </div>
                                <div>
                                    <div style="font-weight: 600; color: var(--text-primary);">${record.memberName}</div>
                                    <div style="font-size: 0.8rem; color: var(--text-secondary);">Roll: ${record.serialNumber}</div>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 0.85rem; color: #22c55e;">
                                    <i class="fas fa-sign-in-alt"></i> ${record.entryTime}
                                </div>
                                ${record.exitTime ? `
                                    <div style="font-size: 0.85rem; color: #f59e0b;">
                                        <i class="fas fa-sign-out-alt"></i> ${record.exitTime}
                                    </div>
                                ` : `
                                    <span style="font-size: 0.75rem; background: #dcfce7; color: #16a34a; padding: 2px 8px; border-radius: 10px;">In Gym</span>
                                `}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            setupExpiryCheck() {
                // Check for expiring members every minute (for demo purposes)
                setInterval(() => {
                    this.checkExpiringMembers();
                }, 60000); // 1 minute
                
                // Initial check
                this.checkExpiringMembers();
            }

            checkExpiringMembers() {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const sevenDaysLater = new Date(today);
                sevenDaysLater.setDate(sevenDaysLater.getDate() + 7);
                
                let expiringCount = 0;
                
                // Check each member for expiry within 7 days
                this.members.forEach(member => {
                    const expiryDate = new Date(member.expiryDate);
                    expiryDate.setHours(0, 0, 0, 0);
                    
                    // Check if expiring within 7 days (but not expired)
                    if (expiryDate >= today && expiryDate <= sevenDaysLater) {
                        expiringCount++;
                        const daysLeft = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                        
                        // Use dynamic message from settings
                        const dynamicMessage = this.getFormattedMessage('expiringSoon', {
                            name: member.fullName,
                            days: daysLeft,
                            date: this.formatDate(member.expiryDate)
                        });
                        
                        // Add to notification panel
                        this.addNotification({
                            type: 'expiry',
                            title: ' Membership Expiring Soon',
                            message: dynamicMessage,
                            memberId: member.id,
                            memberName: member.fullName,
                            memberMobile: member.mobileNumber,
                            expiryDate: member.expiryDate,
                            rollNo: member.serialNumber
                        });
                    }
                    
                    // Also check for already expired members
                    if (expiryDate < today && member.status !== 'expired') {
                        member.status = 'expired';
                        this.saveToLocalStorage();
                    }
                });
                
                // Update notification badge
                this.updateNotificationBadge();
                
                if (expiringCount > 0) {
                    document.title = ` ${expiringCount} Expiring Soon - Gym Management`;
                }
            }

            // ============ PAYMENT & RENEWAL METHODS ============
            openPaymentModal(memberId) {
                const member = this.members.find(m => m.id === memberId);
                if (!member) return;

                const modal = document.getElementById('paymentModal');
                const paymentContent = document.getElementById('paymentContent');
                
                // Calculate current status
                const expiryDate = new Date(member.expiryDate);
                const today = new Date();
                const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                const isExpired = daysUntilExpiry <= 0;
                
                // Get member's current dues
                const currentDues = member.dueAmount || 0;
                
                // Get plans for dropdown
                const plans = JSON.parse(localStorage.getItem('gymPlans')) || [
                    { id: 1, name: 'Monthly', days: 30, price: 500, desc: 'Standard 30-day membership', featured: true }
                ];
                
                const planOptions = plans.map(p => 
                    `<option value="${p.id}" data-days="${p.days}" data-price="${p.price}">${p.name} - ${p.days} Days - ${p.price.toLocaleString()}</option>`
                ).join('');
                
                paymentContent.innerHTML = `
                    <div class="member-payment-info" style="background: ${isExpired ? '#ffebee' : '#e8f5e9'}; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                        <h4 style="margin-bottom: 10px;">${member.fullName}</h4>
                        <p><strong>Roll No:</strong> ${member.serialNumber}</p>
                        <p><strong>Current Expiry:</strong> ${this.formatDate(member.expiryDate)}</p>
                        <p><strong>Status:</strong> <span style="color: ${isExpired ? 'var(--danger)' : 'var(--success)'}">
                            ${isExpired ? 'EXPIRED' : daysUntilExpiry + ' days remaining'}
                        </span></p>
                        ${currentDues > 0 ? `<p><strong>Previous Dues:</strong> <span style="color: var(--danger); font-weight: bold;">${currentDues.toLocaleString()}</span></p>` : ''}
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="paymentPlanSelect"><strong>Select Plan:</strong></label>
                        <select id="paymentPlanSelect" onchange="gym.onPaymentPlanSelect()" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary);">
                            <option value="">-- Select Plan --</option>
                            ${planOptions}
                        </select>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="numberOfMonths"><strong><i class="fas fa-calendar-alt"></i> Number of Months:</strong></label>
                        <select id="numberOfMonths" onchange="gym.updateMultiMonthPayment()" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary);">
                            <option value="1">1 Month</option>
                            <option value="2">2 Months</option>
                            <option value="3">3 Months</option>
                            <option value="6">6 Months</option>
                            <option value="12">12 Months (1 Year)</option>
                        </select>
                    </div>
                    
                    <div id="paymentDetails" style="display: none;">
                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div class="form-group">
                                <label for="planAmount"><strong>Plan Amount ():</strong></label>
                                <input type="number" id="planAmount" readonly style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary);">
                            </div>
                            <div class="form-group">
                                <label for="paidAmount"><strong>Amount Paid ():</strong></label>
                                <input type="number" id="paidAmount" min="0" oninput="gym.calculateDues()" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary);">
                            </div>
                        </div>
                        
                        ${currentDues > 0 ? `
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" id="includePreviousDues" onchange="gym.calculateDues()" style="width: 18px; height: 18px;">
                                <span>Include Previous Dues (${currentDues.toLocaleString()})</span>
                            </label>
                        </div>
                        ` : ''}
                        
                        <div class="payment-summary" id="paymentSummary" style="margin-top: 15px; background: var(--bg-secondary); padding: 15px; border-radius: 10px;">
                            <h4 style="margin-bottom: 10px;"><i class="fas fa-receipt"></i> Payment Summary</h4>
                            <div class="summary-row" style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span>Plan Amount (per month):</span>
                                <span id="summaryPlanAmountPerMonth">0</span>
                            </div>
                            <div class="summary-row" style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span>Number of Months:</span>
                                <span id="summaryMonths" style="color: var(--primary); font-weight: bold;">1</span>
                            </div>
                            <div class="summary-row" style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span>Plan Amount:</span>
                                <span id="summaryPlanAmount">0</span>
                            </div>
                            ${currentDues > 0 ? `
                            <div class="summary-row" style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span>Previous Dues:</span>
                                <span id="summaryPrevDues" style="color: var(--danger);">0</span>
                            </div>
                            ` : ''}
                            <div class="summary-row" style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span>Total Amount:</span>
                                <span id="summaryTotalAmount" style="font-weight: bold;">0</span>
                            </div>
                            <div class="summary-row" style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span>Amount Paid:</span>
                                <span id="summaryPaidAmount" style="color: var(--success);">0</span>
                            </div>
                            <div class="summary-row" style="display: flex; justify-content: space-between; padding-top: 10px; border-top: 1px dashed var(--border-color);">
                                <span><strong>Due Amount:</strong></span>
                                <span id="summaryDueAmount" style="color: var(--danger); font-weight: bold; font-size: 1.1em;">0</span>
                            </div>
                            <div class="summary-row" style="display: flex; justify-content: space-between; margin-top: 10px;">
                                <span>Extension:</span>
                                <span id="summaryDays">+0 days</span>
                            </div>
                            <div class="summary-row" style="display: flex; justify-content: space-between;">
                                <span>New Expiry Date:</span>
                                <span id="summaryNewExpiry" style="color: var(--success); font-weight: bold;">-</span>
                            </div>
                        </div>
                        
                        <div class="form-group" style="margin-top: 15px;">
                            <label><strong><i class="fas fa-wallet"></i> Payment Mode:</strong></label>
                            <select id="renewalPaymentMode" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary); margin-top: 5px;">
                                <option value="Online"> Online</option>
                                <option value="Cash"> Cash</option>
                                <option value="UPI"> UPI</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button class="btn-secondary" onclick="gym.closeAllModals()" style="flex: 1;">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button class="btn-primary" id="confirmPaymentBtn" onclick="gym.confirmPayment(${member.id})" style="flex: 2;" disabled>
                            <i class="fas fa-check-circle"></i> Confirm Payment
                        </button>
                    </div>
                `;
                
                // Store current member for payment
                this.paymentMemberId = memberId;
                this.selectedPlanDays = 0;
                this.selectedPlanAmount = 0;
                this.currentMemberDues = currentDues;
                
                modal.style.display = 'flex';
            }

            onPaymentPlanSelect() {
                const select = document.getElementById('paymentPlanSelect');
                const selectedOption = select.options[select.selectedIndex];
                const paymentDetails = document.getElementById('paymentDetails');
                const confirmBtn = document.getElementById('confirmPaymentBtn');
                
                if (select.value && selectedOption.dataset.days) {
                    const days = parseInt(selectedOption.dataset.days);
                    const price = parseInt(selectedOption.dataset.price);
                    
                    this.selectedPlanDays = days;
                    this.selectedPlanAmount = price;
                    this.selectedPlanPricePerMonth = price; // Store per month price
                    
                    // Reset months to 1 when plan changes
                    document.getElementById('numberOfMonths').value = '1';
                    this.selectedMonths = 1;
                    
                    document.getElementById('planAmount').value = price;
                    document.getElementById('paidAmount').value = price; // Default full payment
                    
                    paymentDetails.style.display = 'block';
                    confirmBtn.disabled = false;
                    
                    this.calculateDues();
                    this.updatePaymentSummary();
                } else {
                    paymentDetails.style.display = 'none';
                    confirmBtn.disabled = true;
                }
            }

            updateMultiMonthPayment() {
                const months = parseInt(document.getElementById('numberOfMonths').value) || 1;
                this.selectedMonths = months;
                
                if (this.selectedPlanPricePerMonth) {
                    const totalPlanAmount = this.selectedPlanPricePerMonth * months;
                    const totalDays = this.selectedPlanDays * months;
                    
                    this.selectedPlanAmount = totalPlanAmount;
                    this.selectedTotalDays = totalDays;
                    
                    document.getElementById('planAmount').value = totalPlanAmount;
                    document.getElementById('paidAmount').value = totalPlanAmount; // Default full payment
                    
                    this.calculateDues();
                    this.updatePaymentSummary();
                }
            }

            calculateDues() {
                const planAmount = parseInt(document.getElementById('planAmount').value) || 0;
                const paidAmount = parseInt(document.getElementById('paidAmount').value) || 0;
                const includePrevDues = document.getElementById('includePreviousDues')?.checked || false;
                const prevDues = includePrevDues ? (this.currentMemberDues || 0) : 0;
                const months = this.selectedMonths || 1;
                const pricePerMonth = this.selectedPlanPricePerMonth || planAmount;
                
                const totalAmount = planAmount + prevDues;
                const dueAmount = Math.max(0, totalAmount - paidAmount);
                const totalDays = (this.selectedPlanDays || 30) * months;
                
                // Update summary
                if (document.getElementById('summaryPlanAmountPerMonth')) {
                    document.getElementById('summaryPlanAmountPerMonth').textContent = `${pricePerMonth.toLocaleString()}`;
                }
                if (document.getElementById('summaryMonths')) {
                    document.getElementById('summaryMonths').textContent = `${months}`;
                }
                document.getElementById('summaryPlanAmount').textContent = `${planAmount.toLocaleString()}`;
                if (document.getElementById('summaryPrevDues')) {
                    document.getElementById('summaryPrevDues').textContent = `${prevDues.toLocaleString()}`;
                }
                document.getElementById('summaryTotalAmount').textContent = `${totalAmount.toLocaleString()}`;
                document.getElementById('summaryPaidAmount').textContent = `${paidAmount.toLocaleString()}`;
                document.getElementById('summaryDueAmount').textContent = `${dueAmount.toLocaleString()}`;
                document.getElementById('summaryDays').textContent = `+${totalDays} days`;
                
                // Calculate new expiry date
                const member = this.members.find(m => m.id === this.paymentMemberId);
                if (member) {
                    const currentExpiry = new Date(member.expiryDate);
                    const today = new Date();
                    const startDate = currentExpiry > today ? currentExpiry : today;
                    const newExpiry = new Date(startDate);
                    newExpiry.setDate(newExpiry.getDate() + totalDays);
                    document.getElementById('summaryNewExpiry').textContent = this.formatDate(newExpiry.toISOString().split('T')[0]);
                }
                
                // Store for saving
                this.currentPaidAmount = paidAmount;
                this.currentDueAmount = dueAmount;
                this.includePreviousDues = includePrevDues;
                this.selectedTotalDays = totalDays;
            }

            selectPlan(element, days, amount) {
                // Remove selected class from all plans
                document.querySelectorAll('.plan-card').forEach(card => {
                    card.classList.remove('selected');
                });
                
                // Add selected class to clicked plan
                element.classList.add('selected');
                
                // Update selection
                this.selectedPlanDays = days;
                this.selectedPlanAmount = amount;
                
                // Update summary
                this.updatePaymentSummary();
            }

            updatePaymentSummary() {
                const member = this.members.find(m => m.id === this.paymentMemberId);
                if (!member || !this.selectedPlanDays) return;
                
                // Calculate new expiry date - ALWAYS extend from current expiry date
                const currentExpiry = new Date(member.expiryDate);
                
                // Always extend from expiry date (not today)
                let baseDate = currentExpiry;
                const newExpiry = new Date(baseDate);
                newExpiry.setDate(newExpiry.getDate() + this.selectedPlanDays);
                
                // Update summary display
                document.getElementById('summaryDays').textContent = `+${this.selectedPlanDays} days`;
                document.getElementById('summaryNewExpiry').textContent = this.formatDate(newExpiry.toISOString().split('T')[0]);
                document.getElementById('summaryAmount').textContent = `${this.selectedPlanAmount.toLocaleString()}`;
            }

            confirmPayment(memberId) {
                const member = this.members.find(m => m.id === memberId);
                if (!member) return;
                
                if (!this.selectedPlanDays || !this.selectedPlanAmount) {
                    this.showToast('Please select a plan first', 'error');
                    return;
                }
                
                const paidAmount = this.currentPaidAmount || this.selectedPlanAmount;
                const dueAmount = this.currentDueAmount || 0;
                const months = this.selectedMonths || 1;
                const totalDays = this.selectedTotalDays || this.selectedPlanDays;
                
                // Calculate new expiry date
                const currentExpiry = new Date(member.expiryDate);
                const now = new Date();
                const currentTime = now.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', hour12: true });
                
                // FIXED: Always extend from current expiry date, not from today
                // This ensures expired members who pay partial months stay expired
                // Example: If member expired 2 months ago and pays 1 month, 
                // they should still be 1 month expired, not become active
                let baseDate = currentExpiry;
                const newExpiry = new Date(baseDate);
                newExpiry.setDate(newExpiry.getDate() + totalDays);
                
                // Update member
                member.expiryDate = newExpiry.toISOString().split('T')[0];
                member.durationDays = this.selectedPlanDays; // Original plan days
                
                // Update dues - if previous dues were included and paid, clear them
                if (this.includePreviousDues) {
                    member.dueAmount = dueAmount; // New due is just from current payment
                } else {
                    // Add new dues to existing
                    member.dueAmount = (member.dueAmount || 0) + dueAmount;
                }
                
                // Add payment record if not exists
                if (!member.paymentHistory) {
                    member.paymentHistory = [];
                }
                
                const paymentRecord = {
                    date: now.toISOString().split('T')[0],
                    time: currentTime,
                    timestamp: now.toISOString(),
                    days: totalDays,
                    months: months,
                    planDays: this.selectedPlanDays,
                    planAmount: this.selectedPlanAmount,
                    amount: paidAmount,
                    dueAmount: dueAmount,
                    newExpiry: member.expiryDate,
                    rollNo: member.serialNumber,
                    mode: document.getElementById('renewalPaymentMode')?.value || 'Cash'
                };
                
                member.paymentHistory.push(paymentRecord);
                
                // Save and update
                localStorage.setItem('gymMembers', JSON.stringify(this.members));
                this.autoSyncToCloud(); // Auto sync to cloud
                
                // Reset filter to 'all' to show updated member properly
                this.currentFilter = 'all';
                
                // Update filter button active states
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.filter === 'all') {
                        btn.classList.add('active');
                    }
                });
                
                this.renderMembers();
                this.updateDashboard();
                this.loadPaymentHistory(); // Refresh payment history
                
                // Add payment notification
                this.addPaymentNotification(member, this.selectedPlanAmount, totalDays);
                
                // Show Bill Modal instead of closing
                this.showBillModal(member, paymentRecord);
            }

            // ============ BILL GENERATION ============
            showBillModal(member, payment) {
                const settings = JSON.parse(localStorage.getItem('gymSettings')) || {};
                const gymName = settings.gymName || 'SG FITNESS EVOLUTION';
                const gymPhone = settings.phone || '9876543210';
                const gymAddress = settings.address || 'Your Gym Address';
                
                const billHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <div style="background: linear-gradient(135deg, #4CAF50, #8BC34A); color: white; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                            <i class="fas fa-check-circle" style="font-size: 3rem; margin-bottom: 10px;"></i>
                            <h2 style="margin: 0;">Payment Successful!</h2>
                        </div>
                        
                        <div id="billPreview" style="background: #f8f9fa; border: 2px dashed #ddd; border-radius: 10px; padding: 20px; text-align: left; margin-bottom: 20px;">
                            <div style="text-align: center; margin-bottom: 15px;">
                                <h3 style="margin: 0; color: var(--primary);"> PAYMENT RECEIPT</h3>
                                <p style="margin: 5px 0; font-size: 0.9rem; color: var(--gray);"></p>
                            </div>
                            
                            <div style="text-align: center; margin-bottom: 15px;">
                                <h4 style="margin: 0; color: var(--dark);"> ${gymName}</h4>
                                <p style="margin: 5px 0; font-size: 0.85rem; color: var(--gray);">${gymAddress}</p>
                            </div>
                            
                            <div style="border-top: 1px solid #ddd; padding-top: 15px;">
                                <p style="margin: 8px 0;"><strong>Roll No:</strong> ${member.serialNumber}</p>
                                <p style="margin: 8px 0;"><strong>Name:</strong> ${member.fullName}</p>
                                <p style="margin: 8px 0;"><strong>Mobile:</strong> ${member.mobileNumber}</p>
                                <p style="margin: 8px 0;"><strong>Date:</strong> ${this.formatDate(payment.date)} at ${payment.time || ''}</p>
                            </div>
                            
                            <div style="border-top: 1px solid #ddd; padding-top: 15px; margin-top: 15px;">
                                <p style="margin: 8px 0;"><strong>Plan:</strong> ${payment.days} Days</p>
                                <p style="margin: 8px 0; font-size: 1.2rem; color: var(--success);"><strong>Amount Paid:</strong> ${payment.amount}</p>
                                ${payment.dueAmount > 0 ? `<p style="margin: 8px 0; font-size: 1.1rem; color: #dc3545;"><strong> Pending Dues:</strong> ${payment.dueAmount}</p>` : ''}
                                <p style="margin: 8px 0;"><strong>Payment Mode:</strong> ${payment.mode === 'Cash' ? '' : payment.mode === 'UPI' ? '' : payment.mode === 'Card' ? '' : ''} ${payment.mode || 'Cash'}</p>
                                <p style="margin: 8px 0;"><strong>Valid Till:</strong> ${this.formatDate(payment.newExpiry)}</p>
                            </div>
                            
                            <div style="text-align: center; margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                                <p style="margin: 0; font-size: 0.85rem; color: var(--gray);">Thank you for choosing us! </p>
                                <p style="margin: 5px 0; font-size: 0.8rem; color: var(--gray);"> ${gymPhone}</p>
                            </div>
                        </div>
                        
                        <p style="color: var(--gray); margin-bottom: 15px;">Send bill to member:</p>
                        
                        <div class="msg-buttons" style="justify-content: center; margin-bottom: 20px;">
                            <button class="btn-whatsapp" onclick="gym.sendBillWhatsApp('${member.mobileNumber}', '${member.fullName}', '${member.serialNumber}', ${payment.days}, ${payment.amount}, '${payment.newExpiry}', '${payment.time || ''}', ${payment.dueAmount || 0})" style="padding: 12px 25px;">
                                <i class="fab fa-whatsapp"></i> WhatsApp
                            </button>
                            <button class="btn-sms" onclick="gym.sendBillSMS('${member.mobileNumber}', '${member.fullName}', '${member.serialNumber}', ${payment.days}, ${payment.amount}, '${payment.newExpiry}', '${payment.time || ''}', ${payment.dueAmount || 0})" style="padding: 12px 25px;">
                                <i class="fas fa-sms"></i> SMS
                            </button>
                        </div>
                        
                        <button class="btn-secondary" onclick="gym.closeAllModals()" style="width: 100%; padding: 12px;">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                `;
                
                document.getElementById('paymentContent').innerHTML = billHTML;
            }

            sendBillWhatsApp(mobile, name, rollNo, days, amount, validTill, time, dues = 0) {
                let cleanPhone = mobile.replace(/\D/g, '');
                if (cleanPhone.startsWith('91') && cleanPhone.length > 10) cleanPhone = cleanPhone.substring(2);
                if (cleanPhone.startsWith('0')) cleanPhone = cleanPhone.substring(1);
                if (cleanPhone.length > 10) cleanPhone = cleanPhone.slice(-10);
                const formattedPhone = '91' + cleanPhone;
                
                const settings = JSON.parse(localStorage.getItem('gymSettings')) || {};
                const gymName = settings.gymName || 'SG FITNESS EVOLUTION';
                const gymPhone = settings.phone || '9876543210';
                const gymAddress = settings.address || 'Your Gym Address';
                const today = new Date().toLocaleDateString('en-IN');
                const timeStr = time ? ` at ${time}` : '';
                const formattedValidTill = new Date(validTill).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
                
                let message = `Namaste *${name}* ji \n\n`;
                message += `*${gymName}*\n`;
                message += ` *Payment Receipt*\n\n`;
                message += ` Date: ${today}${timeStr}\n`;
                message += ` Roll No: ${rollNo}\n\n`;
                message += ` *Details:*\n`;
                message += ` Plan: ${days} Days\n`;
                message += ` Amount Paid: Rs.${amount}\n`;
                message += ` Valid Till: ${formattedValidTill}\n`;
                
                if (dues > 0) {
                    message += `\n *Pending Dues: Rs.${dues}*\n`;
                    message += `Kripya apni suvidha anusaar dues clear kar dein.\n`;
                }
                
                message += `\nAapka dhanyavaad! \n`;
                message += ` ${gymPhone}\n`;
                message += `_Gym mein milte hain!_ `;
                
                const whatsappUrl = `https://wa.me/${formattedPhone}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
                this.showToast('Opening WhatsApp with bill...');
            }

            sendBillSMS(mobile, name, rollNo, days, amount, validTill, time, dues = 0) {
                let cleanPhone = mobile.replace(/\D/g, '');
                if (cleanPhone.length > 10) cleanPhone = cleanPhone.slice(-10);
                
                const settings = JSON.parse(localStorage.getItem('gymSettings')) || {};
                const gymName = settings.gymName || 'SG FITNESS EVOLUTION';
                const today = new Date().toLocaleDateString('en-IN');
                const timeStr = time ? ` at ${time}` : '';
                const formattedValidTill = new Date(validTill).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
                
                let smsMessage = `PAYMENT RECEIPT - ${gymName}. Roll No: ${rollNo}, Name: ${name}, Date: ${today}${timeStr}, Plan: ${days} Days, Amount: Rs.${amount}, Valid Till: ${formattedValidTill}.`;
                if (dues > 0) {
                    smsMessage += ` Pending Dues: Rs.${dues}.`;
                }
                smsMessage += ` Thank you!`;
                
                const smsUrl = `sms:${cleanPhone}?body=${encodeURIComponent(smsMessage)}`;
                window.open(smsUrl, '_blank');
                this.showToast('Opening SMS with bill...');
            }
            // ============ END BILL GENERATION ============

            // ============ END PAYMENT METHODS ============

            // ============ DARK MODE ============
            toggleDarkMode() {
                const html = document.documentElement;
                const themeIcon = document.getElementById('themeIcon');
                const currentTheme = html.getAttribute('data-theme');
                
                if (currentTheme === 'dark') {
                    html.removeAttribute('data-theme');
                    themeIcon.classList.remove('fa-sun');
                    themeIcon.classList.add('fa-moon');
                    localStorage.setItem('theme', 'light');
                    this.showToast(' Light Mode Enabled');
                } else {
                    html.setAttribute('data-theme', 'dark');
                    themeIcon.classList.remove('fa-moon');
                    themeIcon.classList.add('fa-sun');
                    localStorage.setItem('theme', 'dark');
                    this.showToast(' Dark Mode Enabled');
                }
            }

            loadSavedTheme() {
                const savedTheme = localStorage.getItem('theme');
                const themeIcon = document.getElementById('themeIcon');
                
                if (savedTheme === 'dark') {
                    document.documentElement.setAttribute('data-theme', 'dark');
                    if (themeIcon) {
                        themeIcon.classList.remove('fa-moon');
                        themeIcon.classList.add('fa-sun');
                    }
                }
            }

            // ============ HAMBURGER MENU FUNCTIONS ============
            toggleSideMenu() {
                const sideMenu = document.getElementById('sideMenu');
                const menuOverlay = document.getElementById('sideMenuOverlay');
                sideMenu.classList.toggle('active');
                menuOverlay.classList.toggle('active');
            }

            closeSideMenu() {
                const sideMenu = document.getElementById('sideMenu');
                const menuOverlay = document.getElementById('sideMenuOverlay');
                sideMenu.classList.remove('active');
                menuOverlay.classList.remove('active');
            }

            // ============ SEE ALL MEMBERS TOGGLE ============
            toggleMembersView() {
                const membersGrid = document.getElementById('membersGrid');
                const btn = document.getElementById('seeMembersBtn');
                const btnText = document.getElementById('seeMembersBtnText');
                
                if (membersGrid.style.display === 'none') {
                    this.showMembersGrid();
                } else {
                    this.hideMembersGrid();
                }
            }

            showMembersGrid() {
                const membersGrid = document.getElementById('membersGrid');
                const btn = document.getElementById('seeMembersBtn');
                const btnText = document.getElementById('seeMembersBtnText');
                const arrow = document.getElementById('seeMembersArrow');
                
                membersGrid.style.display = 'grid';
                btn.classList.add('active');
                btnText.textContent = 'Hide Members';
                if (arrow) arrow.style.transform = 'rotate(180deg)';
                this.renderMembers();
            }

            hideMembersGrid() {
                const membersGrid = document.getElementById('membersGrid');
                const btn = document.getElementById('seeMembersBtn');
                const btnText = document.getElementById('seeMembersBtnText');
                const arrow = document.getElementById('seeMembersArrow');
                
                membersGrid.style.display = 'none';
                btn.classList.remove('active');
                btnText.textContent = 'See All Members';
                if (arrow) arrow.style.transform = 'rotate(0deg)';
            }

            updateMembersCountBadge() {
                const badge = document.getElementById('membersCountBadge');
                if (badge) {
                    badge.textContent = `${this.members.length} Members`;
                }
            }

            switchTabFromMenu(tabName) {
                // Close side menu
                this.closeSideMenu();
                
                // Update active state in side menu
                document.querySelectorAll('.side-menu-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelector(`.side-menu-item[data-tab="${tabName}"]`).classList.add('active');
                
                // Switch tab
                this.switchTab(tabName);
            }

            // ============ TAB NAVIGATION ============
            switchTab(tabName) {
                // Hide all tabs
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // Remove active from all nav tabs (for old nav if exists)
                document.querySelectorAll('.nav-tab').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Show selected tab
                document.getElementById(`tab-${tabName}`).classList.add('active');
                
                // Update side menu active state
                document.querySelectorAll('.side-menu-item').forEach(item => {
                    item.classList.remove('active');
                });
                const menuItem = document.querySelector(`.side-menu-item[data-tab="${tabName}"]`);
                if (menuItem) menuItem.classList.add('active');
                
                // Load tab-specific data
                this.loadTabData(tabName);
            }

            loadTabData(tabName) {
                switch(tabName) {
                    case 'attendance':
                        this.loadAttendance();
                        break;
                    case 'today':
                        this.loadTodaySummary();
                        break;
                    case 'payments':
                        this.loadPaymentHistory();
                        break;
                    case 'plans':
                        this.loadPlans();
                        this.loadSettings();
                        break;
                    case 'messages':
                        this.loadMessageSettings();
                        break;
                    case 'media':
                        this.updateVisitingCard();
                        break;
                }
            }

            // ============ ATTENDANCE SYSTEM ============
            loadAttendance() {
                // Set today's date in date picker
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('attendanceDate').value = today;
                
                // Load attendance data
                this.loadAttendanceByDate();
                this.updateCurrentlyInGym();
            }

            // Cache for attendance records to reduce localStorage reads
            _attendanceCache = null;
            _attendanceCacheTime = 0;
            
            getAttendanceRecords() {
                const now = Date.now();
                // Cache valid for 1 second to reduce repeated localStorage reads
                if (this._attendanceCache && (now - this._attendanceCacheTime) < 1000) {
                    return this._attendanceCache;
                }
                this._attendanceCache = JSON.parse(localStorage.getItem('attendanceRecords')) || [];
                this._attendanceCacheTime = now;
                return this._attendanceCache;
            }

            saveAttendanceRecords(records) {
                localStorage.setItem('attendanceRecords', JSON.stringify(records));
                // Invalidate cache
                this._attendanceCache = records;
                this._attendanceCacheTime = Date.now();
                this.syncAttendanceToFirebase();
            }

            syncAttendanceToFirebase() {
                if (!this.db) return;
                const records = this.getAttendanceRecords();
                const attendanceObj = {};
                records.forEach(r => { attendanceObj[r.id] = r; });
                this.db.ref('gymData/attendance').set(attendanceObj).catch(err => {
                    console.error('Attendance sync failed:', err);
                });
            }

            searchForAttendance() {
                const query = document.getElementById('attendanceSearch').value.toLowerCase().trim();
                const resultsDiv = document.getElementById('attendanceSearchResults');
                
                if (!query) {
                    resultsDiv.innerHTML = '';
                    return;
                }

                const matchedMembers = this.members.filter(m => 
                    m.fullName.toLowerCase().includes(query) ||
                    m.serialNumber.toLowerCase().includes(query) ||
                    m.mobile.includes(query)
                ).slice(0, 10);

                if (matchedMembers.length === 0) {
                    resultsDiv.innerHTML = '<div class="empty-state">No members found</div>';
                    return;
                }

                const today = new Date().toISOString().split('T')[0];
                const records = this.getAttendanceRecords();

                resultsDiv.innerHTML = matchedMembers.map(member => {
                    const todayRecord = records.find(r => 
                        (r.memberId == member.id || r.memberId === String(member.id)) && r.date === today && !r.exitTime
                    );
                    const isCheckedIn = !!todayRecord;

                    return `
                        <div class="attendance-member-item">
                            <div class="attendance-member-info">
                                <span class="name">${member.fullName}</span>
                                <span class="details">Roll: ${member.serialNumber} | ${member.mobile}</span>
                                ${isCheckedIn ? `<span class="status-in"> In Gym since ${todayRecord.entryTime}</span>` : ''}
                            </div>
                            ${isCheckedIn 
                                ? `<button class="btn-checkout" onclick="gym.checkOut('${member.id}')">
                                    <i class="fas fa-sign-out-alt"></i> Check Out
                                   </button>`
                                : `<button class="btn-checkin" onclick="gym.checkIn('${member.id}')">
                                    <i class="fas fa-sign-in-alt"></i> Check In
                                   </button>`
                            }
                        </div>
                    `;
                }).join('');
            }

            checkIn(memberId) {
                // Convert to number if string (for comparison with member.id)
                const memberIdNum = typeof memberId === 'string' ? parseInt(memberId) || memberId : memberId;
                const member = this.members.find(m => m.id == memberIdNum || m.id === memberId);
                if (!member) {
                    this.showToast('Member not found!', 'error');
                    return;
                }

                const now = new Date();
                const today = now.toISOString().split('T')[0];
                const time = now.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', hour12: true });

                const records = this.getAttendanceRecords();
                
                // Check if already checked in today without checkout
                const existingRecord = records.find(r => 
                    (r.memberId == memberIdNum || r.memberId === memberId) && r.date === today && !r.exitTime
                );
                
                if (existingRecord) {
                    this.showToast(`${member.fullName} is already checked in!`, 'warning');
                    return;
                }

                // Create new attendance record
                const newRecord = {
                    id: Date.now().toString(),
                    memberId: memberId,
                    memberName: member.fullName,
                    serialNumber: member.serialNumber,
                    date: today,
                    entryTime: time,
                    exitTime: null,
                    duration: null
                };

                records.push(newRecord);
                this.saveAttendanceRecords(records);

                this.showToast(`${member.fullName} checked in at ${time}`, 'success');
                
                // Refresh displays
                this.searchForAttendance();
                this.updateCurrentlyInGym();
                this.loadAttendanceByDate();
            }

            checkOut(memberId) {
                // Convert to number if string (for comparison with member.id)
                const memberIdNum = typeof memberId === 'string' ? parseInt(memberId) || memberId : memberId;
                const member = this.members.find(m => m.id == memberIdNum || m.id === memberId);
                if (!member) {
                    this.showToast('Member not found!', 'error');
                    return;
                }

                const now = new Date();
                const today = now.toISOString().split('T')[0];
                const time = now.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', hour12: true });

                const records = this.getAttendanceRecords();
                
                // Find the active check-in record (check both string and number memberId)
                const recordIndex = records.findIndex(r => 
                    (r.memberId == memberIdNum || r.memberId === memberId) && r.date === today && !r.exitTime
                );
                
                if (recordIndex === -1) {
                    this.showToast(`${member.fullName} is not checked in!`, 'warning');
                    return;
                }

                // Calculate duration
                const entryTime = this.parseTime(records[recordIndex].entryTime);
                const exitTime = now;
                const durationMs = exitTime - entryTime;
                const durationMinutes = Math.floor(durationMs / 60000);
                const hours = Math.floor(durationMinutes / 60);
                const minutes = durationMinutes % 60;
                const duration = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;

                // Update record
                records[recordIndex].exitTime = time;
                records[recordIndex].duration = duration;
                
                this.saveAttendanceRecords(records);

                this.showToast(`${member.fullName} checked out. Duration: ${duration}`, 'success');
                
                // Refresh displays
                this.searchForAttendance();
                this.updateCurrentlyInGym();
                this.loadAttendanceByDate();
            }

            parseTime(timeStr) {
                const now = new Date();
                const [time, period] = timeStr.split(' ');
                let [hours, minutes] = time.split(':').map(Number);
                
                if (period.toLowerCase() === 'pm' && hours !== 12) {
                    hours += 12;
                } else if (period.toLowerCase() === 'am' && hours === 12) {
                    hours = 0;
                }
                
                return new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes);
            }

            updateCurrentlyInGym() {
                const today = new Date().toISOString().split('T')[0];
                const records = this.getAttendanceRecords();
                
                // Get members currently in gym (checked in but not checked out today)
                const inGymRecords = records.filter(r => r.date === today && !r.exitTime);
                const checkedOutCount = records.filter(r => r.date === today && r.exitTime).length;
                const totalCheckinsToday = records.filter(r => r.date === today).length;

                // Update stats
                document.getElementById('currentlyInGym').textContent = inGymRecords.length;
                document.getElementById('totalCheckins').textContent = totalCheckinsToday;
                document.getElementById('totalCheckouts').textContent = checkedOutCount;
                document.getElementById('inGymBadge').textContent = inGymRecords.length;

                // Update in-gym list
                const listDiv = document.getElementById('inGymList');
                
                if (inGymRecords.length === 0) {
                    listDiv.innerHTML = '<div class="empty-state">No members currently in gym</div>';
                    return;
                }

                listDiv.innerHTML = inGymRecords.map(record => {
                    return `
                        <div class="in-gym-card">
                            <div class="member-info">
                                <span class="member-name">${record.memberName}</span>
                                <span class="entry-time"><i class="fas fa-clock"></i> In since ${record.entryTime}</span>
                            </div>
                            <button class="btn-checkout" onclick="gym.checkOut('${record.memberId}')">
                                <i class="fas fa-sign-out-alt"></i> Check Out
                            </button>
                        </div>
                    `;
                }).join('');
            }

            loadAttendanceByDate() {
                const selectedDate = document.getElementById('attendanceDate').value;
                const records = this.getAttendanceRecords();
                
                const dateRecords = records.filter(r => r.date === selectedDate);
                const tbody = document.getElementById('attendanceLogBody');

                if (dateRecords.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No attendance records for this date</td></tr>';
                    return;
                }

                // Sort by entry time (most recent first)
                dateRecords.sort((a, b) => {
                    const timeA = this.parseTime(a.entryTime);
                    const timeB = this.parseTime(b.entryTime);
                    return timeB - timeA;
                });

                tbody.innerHTML = dateRecords.map(record => {
                    const status = record.exitTime 
                        ? '<span class="status-badge completed"><i class="fas fa-check"></i> Completed</span>'
                        : '<span class="status-badge in-gym"><i class="fas fa-running"></i> In Gym</span>';
                    
                    return `
                        <tr>
                            <td>${record.serialNumber}</td>
                            <td>${record.memberName}</td>
                            <td><i class="fas fa-sign-in-alt" style="color: #22c55e;"></i> ${record.entryTime}</td>
                            <td>${record.exitTime ? `<i class="fas fa-sign-out-alt" style="color: #f59e0b;"></i> ${record.exitTime}` : '-'}</td>
                            <td>${record.duration || '-'}</td>
                            <td>${status}</td>
                        </tr>
                    `;
                }).join('');
            }

            // ============ TODAY'S SUMMARY ============
            loadTodaySummary() {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('todaySummaryDate').textContent = this.formatDate(today);
                
                // Today's check-ins
                const todayCheckins = this.members.filter(m => 
                    m.attendance && m.attendance.includes(today)
                );
                document.getElementById('todayCheckinCount').textContent = todayCheckins.length;
                
                // Today's payments
                let todayCollection = 0;
                let todayAdmissions = 0;
                let todayRenewals = 0;
                const todayPayments = [];
                
                this.members.forEach(m => {
                    // Check if joined today
                    if (m.joinDate === today) {
                        todayAdmissions++;
                        todayCollection += 500; // Default admission fee
                        todayPayments.push({
                            serial: m.serialNumber,
                            name: m.fullName,
                            amount: 500,
                            type: 'Admission'
                        });
                    }
                    
                    // Check payment history
                    if (m.paymentHistory) {
                        m.paymentHistory.forEach(p => {
                            if (p.date === today) {
                                todayRenewals++;
                                todayCollection += p.amount;
                                todayPayments.push({
                                    serial: m.serialNumber,
                                    name: m.fullName,
                                    amount: p.amount,
                                    type: 'Renewal'
                                });
                            }
                        });
                    }
                });
                
                document.getElementById('todayCollection').textContent = `${todayCollection.toLocaleString()}`;
                document.getElementById('todayAdmissions').textContent = todayAdmissions;
                document.getElementById('todayRenewals').textContent = todayRenewals;
                
                // Render check-in list
                const checkinList = document.getElementById('todayCheckinList');
                if (todayCheckins.length > 0) {
                    checkinList.innerHTML = todayCheckins.map(m => `
                        <tr>
                            <td>${m.serialNumber}</td>
                            <td>${m.fullName}</td>
                            <td>${new Date().toLocaleTimeString()}</td>
                        </tr>
                    `).join('');
                } else {
                    checkinList.innerHTML = '<tr><td colspan="3" class="empty-state">No check-ins today</td></tr>';
                }
                
                // Render payment list
                const paymentList = document.getElementById('todayPaymentList');
                if (todayPayments.length > 0) {
                    paymentList.innerHTML = todayPayments.map(p => `
                        <tr>
                            <td>${p.serial}</td>
                            <td>${p.name}</td>
                            <td>${p.amount}</td>
                            <td><span class="badge ${p.type === 'Admission' ? 'badge-success' : 'badge-warning'}">${p.type}</span></td>
                        </tr>
                    `).join('');
                } else {
                    paymentList.innerHTML = '<tr><td colspan="4" class="empty-state">No payments today</td></tr>';
                }
            }

            // ============ PAYMENT HISTORY ============
            loadPaymentHistory() {
                this.filterPaymentHistory();
            }

            filterPaymentHistory() {
                const dateFrom = document.getElementById('paymentDateFrom').value;
                const dateTo = document.getElementById('paymentDateTo').value;
                const searchName = document.getElementById('paymentMemberSearch').value.toLowerCase();
                const statusFilter = document.getElementById('paymentStatusFilter').value;
                
                let allPayments = [];
                
                this.members.forEach(m => {
                    // Add admission payment (not deletable individually)
                    if (m.joinDate) {
                        // Check if there's admission payment in paymentHistory
                        const admissionPayment = m.paymentHistory?.find(p => p.isAdmission);
                        allPayments.push({
                            date: m.joinDate,
                            time: m.joinTime || '',
                            timestamp: m.joinDate + 'T00:00:00',
                            serial: m.serialNumber,
                            name: m.fullName,
                            plan: '30 Days',
                            amount: admissionPayment?.amount || 500,
                            mode: admissionPayment?.mode || 'Cash',
                            newExpiry: m.expiryDate,
                            status: 'paid',
                            memberId: m.id,
                            isAdmission: true
                        });
                    }
                    
                    // Add renewal payments
                    if (m.paymentHistory) {
                        m.paymentHistory.forEach(p => {
                            if (!p.isAdmission) {
                                allPayments.push({
                                    date: p.date,
                                    time: p.time || '',
                                    timestamp: p.timestamp || p.date + 'T00:00:00',
                                    serial: m.serialNumber,
                                    name: m.fullName,
                                    plan: p.type === 'Dues Payment' ? 'Dues Payment' : `${p.days} Days`,
                                    planAmount: p.planAmount || p.amount,
                                    amount: p.amount,
                                    dueAmount: p.dueAmount || 0,
                                    mode: p.mode || 'Cash',
                                    newExpiry: p.newExpiry || '-',
                                    status: p.dueAmount > 0 ? 'partial' : 'paid',
                                    memberId: m.id,
                                    isAdmission: false,
                                    type: p.type || 'Renewal'
                                });
                            }
                        });
                    }
                });
                
                // Sort by timestamp descending (newest first)
                allPayments.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                // Apply filters
                if (dateFrom) {
                    allPayments = allPayments.filter(p => p.date >= dateFrom);
                }
                if (dateTo) {
                    allPayments = allPayments.filter(p => p.date <= dateTo);
                }
                if (searchName) {
                    allPayments = allPayments.filter(p => p.name.toLowerCase().includes(searchName));
                }
                
                // Apply status filter - Paid (no dues) or Unpaid (has dues)
                if (statusFilter === 'paid') {
                    allPayments = allPayments.filter(p => !p.dueAmount || p.dueAmount === 0);
                } else if (statusFilter === 'pending') {
                    allPayments = allPayments.filter(p => p.dueAmount && p.dueAmount > 0);
                }
                
                // Calculate total
                const total = allPayments.reduce((sum, p) => sum + p.amount, 0);
                document.getElementById('filteredTotalCollection').textContent = `${total.toLocaleString()}`;
                
                // Render table
                const tbody = document.getElementById('paymentHistoryTable');
                if (allPayments.length > 0) {
                    tbody.innerHTML = allPayments.map((p, index) => `
                        <tr>
                            <td>
                                ${this.formatDate(p.date)}
                                ${p.time ? `<br><small style="color: var(--gray);">${p.time}</small>` : ''}
                            </td>
                            <td>${p.serial}</td>
                            <td>${p.name}</td>
                            <td>${p.plan}</td>
                            <td style="color: var(--success);">${p.amount.toLocaleString()}</td>
                            <td style="color: ${p.dueAmount > 0 ? 'var(--danger)' : 'var(--gray)'}; font-weight: ${p.dueAmount > 0 ? 'bold' : 'normal'};">
                                ${p.dueAmount > 0 ? `${p.dueAmount.toLocaleString()}` : '-'}
                            </td>
                            <td>
                                <span style="padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; 
                                    background: ${p.mode === 'Cash' ? '#e8f5e9' : p.mode === 'UPI' ? '#e3f2fd' : p.mode === 'Card' ? '#fff3e0' : '#f3e5f5'};
                                    color: ${p.mode === 'Cash' ? '#2e7d32' : p.mode === 'UPI' ? '#1565c0' : p.mode === 'Card' ? '#ef6c00' : '#7b1fa2'};">
                                    ${p.mode === 'Cash' ? '' : p.mode === 'UPI' ? '' : p.mode === 'Card' ? '' : ''} ${p.mode}
                                </span>
                            </td>
                            <td>${p.newExpiry !== '-' ? this.formatDate(p.newExpiry) : '-'}</td>
                            <td>
                                <span class="badge ${p.dueAmount > 0 ? 'badge-danger' : 'badge-success'}">
                                    ${p.dueAmount > 0 ? 'Unpaid' : 'Paid'}
                                </span>
                            </td>
                            <td>
                                ${p.isAdmission ? 
                                    `<span style="color: var(--gray); font-size: 0.8rem;">Admission</span>` :
                                    `<button class="btn-danger" onclick="gym.deleteSinglePayment(${p.memberId}, '${p.date}', ${p.amount})" style="padding: 5px 10px; font-size: 0.8rem;">
                                        <i class="fas fa-trash"></i>
                                    </button>`
                                }
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="10" class="empty-state"><i class="fas fa-receipt"></i><br>No payment records found</td></tr>';
                }
            }

            // Delete single payment
            deleteSinglePayment(memberId, date, amount) {
                if (!confirm(` Warning!\n\nAre you sure you want to delete this payment?\n\nAmount: ${amount}\nDate: ${date}\n\nThis action cannot be undone!`)) {
                    return;
                }
                
                // Convert memberId to number for comparison
                const numericMemberId = typeof memberId === 'string' ? parseInt(memberId) : memberId;
                const member = this.members.find(m => m.id === numericMemberId);
                
                if (member && member.paymentHistory) {
                    const index = member.paymentHistory.findIndex(p => p.date === date && p.amount == amount);
                    if (index !== -1) {
                        member.paymentHistory.splice(index, 1);
                        this.saveToLocalStorage();
                        this.autoSyncToCloud(); // Use existing sync method
                        this.renderPaymentHistory();
                        this.showToast('Payment deleted successfully!', 'success');
                    } else {
                        this.showToast('Payment not found!', 'error');
                    }
                } else {
                    this.showToast('Member not found!', 'error');
                }
            }

            // Clear member dues
            clearMemberDues(memberId) {
                const member = this.members.find(m => m.id === memberId);
                if (!member) return;
                
                const dueAmount = member.dueAmount || 0;
                if (dueAmount === 0) {
                    this.showToast('No dues to clear!', 'error');
                    return;
                }
                
                if (!confirm(`Clear dues of ${dueAmount.toLocaleString()} for ${member.fullName}?\n\nThis will mark the dues as paid.`)) {
                    return;
                }
                
                const now = new Date();
                const currentTime = now.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', hour12: true });
                
                // Add dues payment record
                if (!member.paymentHistory) {
                    member.paymentHistory = [];
                }
                
                member.paymentHistory.push({
                    date: now.toISOString().split('T')[0],
                    time: currentTime,
                    timestamp: now.toISOString(),
                    days: 0,
                    planAmount: dueAmount,
                    amount: dueAmount,
                    dueAmount: 0,
                    newExpiry: member.expiryDate,
                    rollNo: member.serialNumber,
                    type: 'dues_payment'
                });
                
                // Clear dues
                member.dueAmount = 0;
                
                this.saveToLocalStorage();
                this.autoSyncToCloud();
                this.renderMembers();
                this.updateDashboard();
                this.loadPaymentHistory();
                
                // Refresh member details modal
                this.showMemberDetails(memberId);
                
                this.showToast(`Dues cleared for ${member.fullName}!`, 'success');
            }

            // Delete all payment history
            deleteAllPaymentHistory() {
                // Count only renewal payments (not admission)
                const totalRenewalPayments = this.members.reduce((count, m) => {
                    return count + (m.paymentHistory ? m.paymentHistory.length : 0);
                }, 0);
                
                if (totalRenewalPayments === 0) {
                    this.showToast('No renewal payment history to delete!', 'error');
                    return;
                }
                
                if (!confirm(` WARNING!\n\nYou are about to delete ALL renewal payment history!\n\nTotal renewal payments: ${totalRenewalPayments}\n\nNote: Admission payments will NOT be deleted.\nMembers will NOT be deleted.\n\nAre you sure?`)) {
                    return;
                }
                
                // Delete only renewal payment history, keep members and admission data
                this.members.forEach(m => {
                    m.paymentHistory = [];
                });
                
                this.saveToLocalStorage();
                // Force immediate cloud sync
                if (this.cloudSyncEnabled && this.firebaseDB) {
                    this.firebaseDB.ref('gymData').set({
                        members: this.members,
                        nextId: this.nextId,
                        lastSync: new Date().toISOString()
                    }).then(() => {
                        console.log('Delete all synced to cloud');
                    }).catch(err => {
                        console.error('Sync failed:', err);
                    });
                }
                this.renderPaymentHistory();
                this.showToast('All renewal payment history deleted & synced!', 'success');
            }

            exportPaymentHistory(type) {
                const payments = [];
                this.members.forEach(m => {
                    if (m.joinDate) {
                        payments.push({
                            Date: m.joinDate,
                            'Serial No': m.serialNumber,
                            'Member Name': m.fullName,
                            Plan: '30 Days',
                            Amount: 500,
                            'New Expiry': m.expiryDate,
                            Status: 'Paid'
                        });
                    }
                    if (m.paymentHistory) {
                        m.paymentHistory.forEach(p => {
                            payments.push({
                                Date: p.date,
                                'Serial No': m.serialNumber,
                                'Member Name': m.fullName,
                                Plan: `${p.days} Days`,
                                Amount: p.amount,
                                'New Expiry': p.newExpiry,
                                Status: 'Paid'
                            });
                        });
                    }
                });
                
                if (type === 'excel') {
                    const ws = XLSX.utils.json_to_sheet(payments);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Payment History');
                    XLSX.writeFile(wb, `PaymentHistory_${new Date().toISOString().split('T')[0]}.xlsx`);
                    this.showToast('Excel exported successfully!');
                } else if (type === 'pdf') {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    doc.setFontSize(16);
                    doc.text('Payment History Report', 14, 20);
                    doc.setFontSize(10);
                    doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 30);
                    
                    let y = 45;
                    payments.forEach((p, i) => {
                        if (y > 270) {
                            doc.addPage();
                            y = 20;
                        }
                        doc.text(`${i+1}. ${p['Member Name']} - ${p.Plan} - ${p.Amount} - ${p.Date}`, 14, y);
                        y += 8;
                    });
                    
                    doc.save(`PaymentHistory_${new Date().toISOString().split('T')[0]}.pdf`);
                    this.showToast('PDF exported successfully!');
                }
            }

            // ============ PLANS & SETTINGS ============
            loadPlans() {
                const plans = JSON.parse(localStorage.getItem('gymPlans')) || [
                    { id: 1, name: 'Monthly', days: 30, price: 500, desc: 'Standard 30-day membership', featured: true }
                ];
                
                const grid = document.getElementById('plansGrid');
                grid.innerHTML = plans.map(p => `
                    <div class="plan-card-big ${p.featured ? 'featured' : ''}">
                        <h3>${p.name}</h3>
                        <div class="price">${p.price.toLocaleString()}</div>
                        <div class="duration">${p.days} Days</div>
                        <p style="color: var(--gray);">${p.desc || ''}</p>
                        <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;">
                            <button class="btn-secondary" onclick="gym.editPlan(${p.id})" style="padding: 8px 15px;">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-secondary" onclick="gym.deletePlan(${p.id})" style="padding: 8px 15px; background: var(--danger); color: white;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            // Load plans into member form dropdown
            loadPlansDropdown(selectedPlanId = null) {
                const plans = JSON.parse(localStorage.getItem('gymPlans')) || [
                    { id: 1, name: 'Monthly', days: 30, price: 500, desc: 'Standard 30-day membership', featured: true }
                ];
                
                const select = document.getElementById('selectedPlan');
                select.innerHTML = '<option value="">-- Select a Plan --</option>';
                
                plans.forEach(plan => {
                    const option = document.createElement('option');
                    option.value = plan.id;
                    option.textContent = `${plan.name} - ${plan.days} Days - ${plan.price.toLocaleString()}`;
                    option.dataset.days = plan.days;
                    option.dataset.price = plan.price;
                    if (selectedPlanId && plan.id == selectedPlanId) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
                
                // Hide plan info initially
                document.getElementById('selectedPlanInfo').style.display = 'none';
                
                // If editing and plan was selected, trigger the display
                if (selectedPlanId) {
                    this.onPlanSelect();
                }
            }

            // Handle plan selection
            onPlanSelect() {
                const select = document.getElementById('selectedPlan');
                const selectedOption = select.options[select.selectedIndex];
                const planInfo = document.getElementById('selectedPlanInfo');
                
                if (select.value && selectedOption.dataset.days) {
                    const days = parseInt(selectedOption.dataset.days);
                    const price = parseInt(selectedOption.dataset.price);
                    
                    // Show plan info
                    document.getElementById('planDurationDisplay').textContent = `${days} Days`;
                    document.getElementById('planPriceDisplay').textContent = `${price.toLocaleString()}`;
                    planInfo.style.display = 'block';
                    
                    // Auto-select custom days option and set the days
                    document.getElementById('customDays').checked = true;
                    this.currentExpiryOption = 'custom';
                    this.updateExpiryInputs();
                    document.getElementById('durationDays').value = days;
                    
                    // Update expiry date display
                    this.updateExpiryDateDisplay();
                    
                    // Calculate dues preview
                    this.calculateDuesPreview();
                } else {
                    planInfo.style.display = 'none';
                    // Hide dues preview when no plan selected
                    document.getElementById('duesPreviewBox').style.display = 'none';
                }
            }

            openAddPlanModal() {
                document.getElementById('editPlanId').value = '';
                document.getElementById('planModalTitle').innerHTML = '<i class="fas fa-plus"></i> Add New Plan';
                document.getElementById('newPlanName').value = '';
                document.getElementById('newPlanDays').value = '';
                document.getElementById('newPlanPrice').value = '';
                document.getElementById('newPlanDesc').value = '';
                document.getElementById('addPlanModal').style.display = 'flex';
            }

            editPlan(id) {
                const plans = JSON.parse(localStorage.getItem('gymPlans')) || [];
                const plan = plans.find(p => p.id === id);
                if (!plan) {
                    this.showToast('Plan not found!', 'error');
                    return;
                }
                
                document.getElementById('editPlanId').value = id;
                document.getElementById('planModalTitle').innerHTML = '<i class="fas fa-edit"></i> Edit Plan';
                document.getElementById('newPlanName').value = plan.name;
                document.getElementById('newPlanDays').value = plan.days;
                document.getElementById('newPlanPrice').value = plan.price;
                document.getElementById('newPlanDesc').value = plan.desc || '';
                document.getElementById('addPlanModal').style.display = 'flex';
            }

            savePlan() {
                const editId = document.getElementById('editPlanId').value;
                const name = document.getElementById('newPlanName').value.trim();
                const days = parseInt(document.getElementById('newPlanDays').value);
                const price = parseInt(document.getElementById('newPlanPrice').value);
                const desc = document.getElementById('newPlanDesc').value.trim();
                
                if (!name || !days || !price) {
                    this.showToast('Please fill all required fields', 'error');
                    return;
                }
                
                let plans = JSON.parse(localStorage.getItem('gymPlans')) || [];
                
                if (editId) {
                    // Edit existing plan
                    const planIndex = plans.findIndex(p => p.id === parseInt(editId));
                    if (planIndex !== -1) {
                        plans[planIndex] = {
                            ...plans[planIndex],
                            name,
                            days,
                            price,
                            desc
                        };
                    }
                    this.showToast('Plan updated successfully!');
                } else {
                    // Add new plan
                    plans.push({
                        id: Date.now(),
                        name,
                        days,
                        price,
                        desc,
                        featured: false
                    });
                    this.showToast('Plan added successfully!');
                }
                
                localStorage.setItem('gymPlans', JSON.stringify(plans));
                this.autoSyncToCloud(); // Auto sync
                this.closeAllModals();
                this.loadPlans();
            }

            deletePlan(id) {
                if (!confirm('Are you sure you want to delete this plan?')) return;
                
                let plans = JSON.parse(localStorage.getItem('gymPlans')) || [];
                plans = plans.filter(p => p.id !== id);
                localStorage.setItem('gymPlans', JSON.stringify(plans));
                this.autoSyncToCloud(); // Auto sync
                this.loadPlans();
                this.showToast('Plan deleted!');
            }

            loadSettings() {
                const settings = JSON.parse(localStorage.getItem('gymSettings')) || {
                    gymName: 'SG FITNESS EVOLUTION',
                    tagline: 'Transform Your Body, Transform Your Life',
                    phone: '9876543210',
                    whatsapp: '919876543210',
                    address: 'Your Gym Address',
                    email: 'gym@email.com',
                    openTime: '05:00',
                    closeTime: '22:00',
                    maxCapacity: 50,
                    expiryAlertDays: 7,
                    enableAlerts: true
                };
                
                document.getElementById('settingGymName').value = settings.gymName;
                document.getElementById('settingTagline').value = settings.tagline;
                document.getElementById('settingPhone').value = settings.phone;
                document.getElementById('settingWhatsApp').value = settings.whatsapp;
                document.getElementById('settingAddress').value = settings.address;
                document.getElementById('settingEmail').value = settings.email;
                document.getElementById('settingOpenTime').value = settings.openTime;
                document.getElementById('settingCloseTime').value = settings.closeTime;
                document.getElementById('settingMaxCapacity').value = settings.maxCapacity;
                document.getElementById('settingExpiryAlertDays').value = settings.expiryAlertDays;
                document.getElementById('settingEnableAlerts').checked = settings.enableAlerts;
            }

            saveSettings() {
                const settings = {
                    gymName: document.getElementById('settingGymName').value,
                    tagline: document.getElementById('settingTagline').value,
                    phone: document.getElementById('settingPhone').value,
                    whatsapp: document.getElementById('settingWhatsApp').value,
                    address: document.getElementById('settingAddress').value,
                    email: document.getElementById('settingEmail').value,
                    openTime: document.getElementById('settingOpenTime').value,
                    closeTime: document.getElementById('settingCloseTime').value,
                    maxCapacity: parseInt(document.getElementById('settingMaxCapacity').value),
                    expiryAlertDays: parseInt(document.getElementById('settingExpiryAlertDays').value),
                    enableAlerts: document.getElementById('settingEnableAlerts').checked
                };
                
                localStorage.setItem('gymSettings', JSON.stringify(settings));
                this.autoSyncToCloud(); // Auto sync
                this.showToast('Settings saved!');
            }

            // ============ MESSAGE SETTINGS ============
            getDefaultMessages() {
                return {
                    expiredMember: 'Namaste *{name}* ji \n\n*SG FITNESS EVOLUTION* se aapko yaad aa rahi hai!\n\nAapki membership *{date}* ko expire ho gayi thi.\n\n Fitness ka safar ruk nahi chahiye! Aaj hi renew karein aur apne goals achieve karein.\n\nHum aapka intezaar kar rahe hain! \n\n_Contact: Gym Reception_',
                    expiringSoon: 'Namaste *{name}* ji \n\n*SG FITNESS EVOLUTION* ki taraf se reminder!\n\n Aapki membership *{days} din* mein (*{date}*) expire ho rahi hai.\n\n Abhi renew karein aur:\n Fitness streak continue rakhein\n Gym facilities enjoy karein\n Apne goals achieve karein!\n\nGym visit karein ya call karein! \n\n_Stay Fit, Stay Healthy!_ ',
                    duesReminder: 'Namaste *{name}* ji \n\n*SG FITNESS EVOLUTION* se ek gentle reminder.\n\n Aapke account mein *{amount}* dues pending hain.\n\nKripya apni suvidha anusaar payment kar dein.\n\n Payment: Cash / UPI / Online\n\nAapka saath humare liye bahut important hai! \n\n_Thank you!_ ',
                    duesCleared: 'Namaste *{name}* ji \n\n *Badhai ho!*\n\nAapke sabhi dues clear ho gaye hain!\n\n Payment successfully received.\n\nAapka dhanyavaad! Gym mein milte hain! \n\n_Keep crushing your goals!_ \n\n*SG FITNESS EVOLUTION*',
                    paymentConfirm: 'Namaste *{name}* ji \n\n *Payment Received!*\n\n*SG FITNESS EVOLUTION* mein aapka swaagat hai!\n\n Amount: *{amount}*\n Valid Till: *{expiry}*\n\nAapki membership active hai! \n\nGym mein milte hain! \n\n_Stay Fit, Stay Strong!_ ',
                    newAdmission: 'Namaste *{name}* ji \n\n *Welcome to SG FITNESS EVOLUTION!*\n\nAapne fitness ki taraf pehla kadam utha liya - Badhai ho!\n\n *Details:*\n Start: *{date}*\n Valid Till: *{expiry}*\n Paid: *{amount}*\n\nHum aapke fitness journey mein saath hain! \n\nKoi bhi sawal ho, puchne mein bilkul mat jhijhakna! \n\n_Transform Your Life!_ ',
                    birthdayWish: ' *Happy Birthday {name} ji!* \n\n*SG FITNESS EVOLUTION* ki puri team aapko\n Janamdin ki hardik shubhkamnayein deti hai! \n\nIs saal aapko mile:\n Achhi health\n Strong body\n Sabhi goals ki prapti!\n\nAaj gym aaiye - Birthday surprise ka intezaar hai! \n\n_Have a wonderful day!_ '
                };
            }

            loadMessageSettings() {
                const defaults = this.getDefaultMessages();
                const saved = JSON.parse(localStorage.getItem('messageSettings')) || defaults;
                
                const expiredInput = document.getElementById('expiredMemberMessage');
                const expiringInput = document.getElementById('expiringSoonMessage');
                const duesInput = document.getElementById('duesReminderMessage');
                const clearedInput = document.getElementById('duesClearedMessage');
                const paymentInput = document.getElementById('paymentConfirmMessage');
                const admissionInput = document.getElementById('newAdmissionMessage');
                const birthdayInput = document.getElementById('birthdayWishMessage');
                
                if (expiredInput) expiredInput.value = saved.expiredMember || defaults.expiredMember;
                if (expiringInput) expiringInput.value = saved.expiringSoon || defaults.expiringSoon;
                if (duesInput) duesInput.value = saved.duesReminder || defaults.duesReminder;
                if (clearedInput) clearedInput.value = saved.duesCleared || defaults.duesCleared;
                if (paymentInput) paymentInput.value = saved.paymentConfirm || defaults.paymentConfirm;
                if (admissionInput) admissionInput.value = saved.newAdmission || defaults.newAdmission;
                if (birthdayInput) birthdayInput.value = saved.birthdayWish || defaults.birthdayWish;
            }

            saveMessageSettings() {
                const messages = {
                    expiredMember: document.getElementById('expiredMemberMessage')?.value || this.getDefaultMessages().expiredMember,
                    expiringSoon: document.getElementById('expiringSoonMessage')?.value || this.getDefaultMessages().expiringSoon,
                    duesReminder: document.getElementById('duesReminderMessage')?.value || this.getDefaultMessages().duesReminder,
                    duesCleared: document.getElementById('duesClearedMessage')?.value || this.getDefaultMessages().duesCleared,
                    paymentConfirm: document.getElementById('paymentConfirmMessage')?.value || this.getDefaultMessages().paymentConfirm,
                    newAdmission: document.getElementById('newAdmissionMessage')?.value || this.getDefaultMessages().newAdmission,
                    birthdayWish: document.getElementById('birthdayWishMessage')?.value || this.getDefaultMessages().birthdayWish
                };
                
                localStorage.setItem('messageSettings', JSON.stringify(messages));
                this.autoSyncToCloud();
                this.showToast('Message settings saved successfully!', 'success');
            }

            resetMessageDefaults() {
                if (!confirm('Are you sure you want to reset all messages to defaults?')) return;
                
                const defaults = this.getDefaultMessages();
                localStorage.setItem('messageSettings', JSON.stringify(defaults));
                this.loadMessageSettings();
                this.closeMessageEditor();
                this.showToast('Messages reset to defaults', 'success');
            }

            // Message type configurations
            getMessageConfig() {
                return {
                    expiredMember: {
                        title: ' Expired Member Message',
                        help: 'Placeholders: <code>{name}</code>, <code>{days}</code>, <code>{date}</code>',
                        field: 'expiredMemberMessage'
                    },
                    expiringSoon: {
                        title: ' Expiring Soon Message',
                        help: 'Placeholders: <code>{name}</code>, <code>{days}</code>, <code>{date}</code>',
                        field: 'expiringSoonMessage'
                    },
                    duesReminder: {
                        title: ' Dues Reminder Message',
                        help: 'Placeholders: <code>{name}</code>, <code>{amount}</code>',
                        field: 'duesReminderMessage'
                    },
                    duesCleared: {
                        title: ' Dues Cleared Message',
                        help: 'Placeholders: <code>{name}</code>',
                        field: 'duesClearedMessage'
                    },
                    paymentConfirm: {
                        title: ' Payment Confirmation Message',
                        help: 'Placeholders: <code>{name}</code>, <code>{amount}</code>, <code>{expiry}</code>',
                        field: 'paymentConfirmMessage'
                    },
                    newAdmission: {
                        title: ' New Admission Message',
                        help: 'Placeholders: <code>{name}</code>, <code>{date}</code>, <code>{expiry}</code>, <code>{amount}</code>',
                        field: 'newAdmissionMessage'
                    },
                    birthdayWish: {
                        title: ' Birthday Wish Message',
                        help: 'Placeholders: <code>{name}</code>',
                        field: 'birthdayWishMessage'
                    }
                };
            }

            // Show selected message editor
            showSelectedMessageEditor() {
                const selector = document.getElementById('messageTypeSelector');
                const type = selector.value;
                
                if (!type) {
                    this.closeMessageEditor();
                    return;
                }
                
                const config = this.getMessageConfig()[type];
                const defaults = this.getDefaultMessages();
                const saved = JSON.parse(localStorage.getItem('messageSettings')) || defaults;
                
                // Update editor UI
                document.getElementById('messageEditorTitle').innerHTML = config.title;
                document.getElementById('messageEditorHelp').innerHTML = config.help;
                document.getElementById('messageEditorTextarea').value = saved[type] || defaults[type];
                document.getElementById('messageEditorArea').style.display = 'block';
                
                // Store current type for save
                this.currentEditingMessageType = type;
            }

            // Close message editor
            closeMessageEditor() {
                document.getElementById('messageEditorArea').style.display = 'none';
                document.getElementById('messageTypeSelector').value = '';
                this.currentEditingMessageType = null;
            }

            // Save current message only
            saveCurrentMessage() {
                if (!this.currentEditingMessageType) return;
                
                const type = this.currentEditingMessageType;
                const value = document.getElementById('messageEditorTextarea').value;
                const config = this.getMessageConfig()[type];
                
                // Update hidden textarea
                const hiddenField = document.getElementById(config.field);
                if (hiddenField) hiddenField.value = value;
                
                // Save to localStorage
                const saved = JSON.parse(localStorage.getItem('messageSettings')) || this.getDefaultMessages();
                saved[type] = value;
                localStorage.setItem('messageSettings', JSON.stringify(saved));
                this.autoSyncToCloud();
                
                // Update active message display
                this.updateActiveMessageDisplay(config.title);
                
                this.showToast(`${config.title.replace(/[]/g, '').trim()} saved & activated!`, 'success');
            }
            
            // Update active message display
            updateActiveMessageDisplay(title) {
                const display = document.getElementById('activeMessageDisplay');
                const nameSpan = document.getElementById('activeMessageName');
                if (display && nameSpan) {
                    display.style.display = 'block';
                    nameSpan.textContent = title.replace(/[]/g, '').trim();
                }
            }

            // Reset current message to default
            resetCurrentMessage() {
                if (!this.currentEditingMessageType) return;
                
                const type = this.currentEditingMessageType;
                const defaults = this.getDefaultMessages();
                
                document.getElementById('messageEditorTextarea').value = defaults[type];
                this.showToast('Message reset to default (not saved yet)', 'info');
            }

            // Get formatted message with placeholders replaced
            getFormattedMessage(type, data = {}) {
                const saved = JSON.parse(localStorage.getItem('messageSettings')) || this.getDefaultMessages();
                let message = saved[type] || this.getDefaultMessages()[type] || '';
                
                // Replace placeholders
                message = message.replace(/{name}/g, data.name || 'Member');
                message = message.replace(/{days}/g, data.days || '0');
                message = message.replace(/{date}/g, data.date || 'N/A');
                message = message.replace(/{amount}/g, data.amount || '0');
                message = message.replace(/{expiry}/g, data.expiry || 'N/A');
                
                return message;
            }

            // ============ CAPACITY TRACKER ============
            loadCapacityData() {
                const settings = JSON.parse(localStorage.getItem('gymSettings')) || { maxCapacity: 50 };
                const presentMembers = JSON.parse(localStorage.getItem('presentMembers')) || [];
                
                const current = presentMembers.length;
                const max = settings.maxCapacity;
                const percentage = Math.round((current / max) * 100);
                
                document.getElementById('currentOccupancy').textContent = current;
                document.getElementById('maxCapacityDisplay').textContent = max;
                
                const fill = document.getElementById('capacityFill');
                fill.style.width = `${Math.min(percentage, 100)}%`;
                fill.className = 'capacity-fill';
                
                if (percentage >= 90) {
                    fill.classList.add('danger');
                    document.getElementById('capacityStatus').textContent = 'Status: Almost Full!';
                } else if (percentage >= 70) {
                    fill.classList.add('warning');
                    document.getElementById('capacityStatus').textContent = 'Status: Getting Busy';
                } else {
                    document.getElementById('capacityStatus').textContent = 'Status: Available';
                }
                
                // Render present members
                const tbody = document.getElementById('presentMembersList');
                if (presentMembers.length > 0) {
                    tbody.innerHTML = presentMembers.map(p => `
                        <tr>
                            <td>${p.serial}</td>
                            <td>${p.name}</td>
                            <td>${p.checkInTime}</td>
                            <td>
                                <button class="btn-secondary" onclick="gym.checkOutMember('${p.serial}')" style="padding: 5px 10px; background: var(--danger); color: white;">
                                    <i class="fas fa-sign-out-alt"></i> Check Out
                                </button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" class="empty-state">No members currently present</td></tr>';
                }
                
                // Load peak hours
                this.loadPeakHours();
            }

            quickCheckIn() {
                const search = document.getElementById('capacityMemberSearch').value.trim();
                if (!search) {
                    this.showToast('Please enter serial number or name', 'error');
                    return;
                }
                
                const member = this.members.find(m => 
                    m.serialNumber.toLowerCase() === search.toLowerCase() ||
                    m.fullName.toLowerCase().includes(search.toLowerCase())
                );
                
                if (!member) {
                    this.showToast('Member not found!', 'error');
                    return;
                }
                
                const presentMembers = JSON.parse(localStorage.getItem('presentMembers')) || [];
                
                if (presentMembers.find(p => p.serial === member.serialNumber)) {
                    this.showToast('Member is already checked in!', 'error');
                    return;
                }
                
                const settings = JSON.parse(localStorage.getItem('gymSettings')) || { maxCapacity: 50 };
                if (presentMembers.length >= settings.maxCapacity) {
                    this.showToast('Gym is at full capacity!', 'error');
                    return;
                }
                
                presentMembers.push({
                    serial: member.serialNumber,
                    name: member.fullName,
                    checkInTime: new Date().toLocaleTimeString()
                });
                
                localStorage.setItem('presentMembers', JSON.stringify(presentMembers));
                
                // Record peak hour
                this.recordPeakHour();
                
                // Also mark attendance
                this.markAttendance(member.id);
                
                document.getElementById('capacityMemberSearch').value = '';
                this.loadCapacityData();
                this.showToast(`${member.fullName} checked in!`);
            }

            quickCheckOut() {
                const search = document.getElementById('capacityMemberSearch').value.trim();
                if (!search) {
                    this.showToast('Please enter serial number or name', 'error');
                    return;
                }
                
                const member = this.members.find(m => 
                    m.serialNumber.toLowerCase() === search.toLowerCase() ||
                    m.fullName.toLowerCase().includes(search.toLowerCase())
                );
                
                if (!member) {
                    this.showToast('Member not found!', 'error');
                    return;
                }
                
                this.checkOutMember(member.serialNumber);
                document.getElementById('capacityMemberSearch').value = '';
            }

            checkOutMember(serial) {
                let presentMembers = JSON.parse(localStorage.getItem('presentMembers')) || [];
                const member = presentMembers.find(p => p.serial === serial);
                
                if (!member) {
                    this.showToast('Member is not checked in!', 'error');
                    return;
                }
                
                presentMembers = presentMembers.filter(p => p.serial !== serial);
                localStorage.setItem('presentMembers', JSON.stringify(presentMembers));
                this.loadCapacityData();
                this.showToast(`${member.name} checked out!`);
            }

            recordPeakHour() {
                const hour = new Date().getHours();
                const peakData = JSON.parse(localStorage.getItem('peakHours')) || {};
                const today = new Date().toISOString().split('T')[0];
                
                if (!peakData[today]) {
                    peakData[today] = {};
                }
                
                peakData[today][hour] = (peakData[today][hour] || 0) + 1;
                localStorage.setItem('peakHours', JSON.stringify(peakData));
            }

            loadPeakHours() {
                const peakData = JSON.parse(localStorage.getItem('peakHours')) || {};
                const hourCounts = {};
                
                // Aggregate last 7 days
                Object.values(peakData).forEach(day => {
                    Object.entries(day).forEach(([hour, count]) => {
                        hourCounts[hour] = (hourCounts[hour] || 0) + count;
                    });
                });
                
                const container = document.getElementById('peakHoursData');
                const hours = ['6AM', '8AM', '10AM', '12PM', '4PM', '6PM', '8PM'];
                const hourKeys = [6, 8, 10, 12, 16, 18, 20];
                
                const maxCount = Math.max(...Object.values(hourCounts), 1);
                
                container.innerHTML = hourKeys.map((h, i) => {
                    const count = hourCounts[h] || 0;
                    const height = Math.max((count / maxCount) * 100, 10);
                    return `
                        <div style="text-align: center; flex: 1;">
                            <div style="background: var(--primary); width: 30px; height: ${height}px; margin: 0 auto; border-radius: 3px;"></div>
                            <div style="font-size: 0.8rem; margin-top: 5px;">${hours[i]}</div>
                            <div style="font-size: 0.7rem; color: var(--gray);">${count}</div>
                        </div>
                    `;
                }).join('');
            }

            // ============ DIGITAL CARD & BROADCAST ============
            updateVisitingCard() {
                const settings = JSON.parse(localStorage.getItem('gymSettings')) || {
                    gymName: 'SG FITNESS EVOLUTION',
                    tagline: 'Transform Your Body, Transform Your Life',
                    phone: '9876543210',
                    whatsapp: '919876543210',
                    address: 'Your Gym Address',
                    openTime: '05:00',
                    closeTime: '22:00'
                };
                
                document.getElementById('cardGymName').textContent = settings.gymName;
                document.getElementById('cardTagline').textContent = settings.tagline;
                document.getElementById('cardPhone').textContent = `+91 ${settings.phone}`;
                document.getElementById('cardWhatsApp').textContent = `+91 ${settings.whatsapp}`;
                document.getElementById('cardAddress').textContent = settings.address;
                document.getElementById('cardTimings').textContent = `${settings.openTime} - ${settings.closeTime}`;
            }

            shareVisitingCard() {
                const settings = JSON.parse(localStorage.getItem('gymSettings')) || {};
                const message = ` *${settings.gymName || 'SG FITNESS'}*\n\n` +
                    `${settings.tagline || 'Transform Your Body, Transform Your Life'}\n\n` +
                    ` Phone: +91 ${settings.phone || '9876543210'}\n` +
                    ` WhatsApp: +91 ${settings.whatsapp || '919876543210'}\n` +
                    ` Address: ${settings.address || 'Your Gym Address'}\n` +
                    ` Timing: ${settings.openTime || '05:00'} - ${settings.closeTime || '22:00'}\n\n` +
                    `Join us today! `;
                
                const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
                this.showToast('Opening WhatsApp to share...');
            }

            downloadVisitingCard() {
                this.showToast('Use screenshot or print to save the card');
            }

            sendBroadcast() {
                const message = document.getElementById('broadcastMessage').value.trim();
                if (!message) {
                    this.showToast('Please enter a message', 'error');
                    return;
                }
                
                const settings = JSON.parse(localStorage.getItem('gymSettings')) || {};
                const fullMessage = `*${settings.gymName || 'SG FITNESS EVOLUTION'}*\n\n${message}`;
                
                // Open WhatsApp with prefilled message - user just selects group and sends
                const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(fullMessage)}`;
                window.open(whatsappUrl, '_blank');
                
                this.showToast(` WhatsApp opened! Select your group  Send`, 'success');
                
                // Clear the message box
                document.getElementById('broadcastMessage').value = '';
            }

            // WhatsApp Group Link Functions
            copyGroupLink() {
                const groupLink = 'https://chat.whatsapp.com/H7Bg7hXumjhCTJKhYQSFLZ';
                navigator.clipboard.writeText(groupLink).then(() => {
                    this.showToast(' Group link copied to clipboard!');
                }).catch(() => {
                    // Fallback
                    const textArea = document.createElement('textarea');
                    textArea.value = groupLink;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    this.showToast(' Group link copied!');
                });
            }

            shareGroupLink() {
                const groupLink = 'https://chat.whatsapp.com/H7Bg7hXumjhCTJKhYQSFLZ';
                const message = ` *SG FITNESS EVOLUTION*\n\nJoin our WhatsApp group for daily updates, workout tips & announcements!\n\n ${groupLink}`;
                const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
                this.showToast('Opening WhatsApp to share...');
            }

            shareMedia(type) {
                const mediaMessages = {
                    workout: ' Check out this amazing workout routine!\n\n[Add your workout video link here]',
                    exercise: ' Exercise Guide for the Day!\n\n[Add your exercise guide link here]',
                    promo: ' Special Offer!\n\n[Add your promotion details here]',
                    tips: ' Fitness Tip of the Day!\n\n[Add your fitness tips here]'
                };
                
                const message = mediaMessages[type] || 'Check this out!';
                const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
                this.showToast('Opening WhatsApp...');
            }

            // ============ ENQUIRY MANAGEMENT ============
            
            loadEnquiries() {
                const saved = localStorage.getItem('gymEnquiries');
                if (saved) {
                    this.enquiries = JSON.parse(saved);
                }
                this.renderEnquiries();
            }

            saveEnquiries() {
                localStorage.setItem('gymEnquiries', JSON.stringify(this.enquiries));
            }

            addEnquiry() {
                const name = document.getElementById('enquiryName').value.trim();
                const mobile = document.getElementById('enquiryMobile').value.trim();
                const plan = document.getElementById('enquiryPlan').value;
                const notes = document.getElementById('enquiryNotes').value.trim();

                if (!name || !mobile) {
                    this.showToast('Please enter name and mobile number', 'error');
                    return;
                }

                if (mobile.length !== 10) {
                    this.showToast('Please enter valid 10 digit mobile number', 'error');
                    return;
                }

                const enquiry = {
                    id: Date.now(),
                    name: name,
                    mobile: mobile,
                    plan: plan,
                    notes: notes,
                    date: new Date().toISOString(),
                    status: 'pending'
                };

                this.enquiries.unshift(enquiry);
                this.saveEnquiries();
                this.autoSyncToCloud(); // Auto sync
                this.renderEnquiries();

                // Clear form
                document.getElementById('enquiryName').value = '';
                document.getElementById('enquiryMobile').value = '';
                document.getElementById('enquiryPlan').value = '';
                document.getElementById('enquiryNotes').value = '';

                this.showToast(' Enquiry added successfully!');
            }

            renderEnquiries() {
                const container = document.getElementById('enquiryList');
                if (!container) return;

                if (this.enquiries.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--gray);">
                            <i class="fas fa-user-clock" style="font-size: 3rem; margin-bottom: 15px;"></i>
                            <p>No enquiries yet. Add your first enquiry!</p>
                        </div>
                    `;
                    return;
                }

                const settings = JSON.parse(localStorage.getItem('gymSettings')) || {};
                
                container.innerHTML = this.enquiries.map(enq => `
                    <div class="enquiry-card" style="background: var(--bg-secondary); border-radius: 10px; padding: 15px; margin-bottom: 15px; border-left: 4px solid ${enq.status === 'converted' ? 'var(--success)' : 'var(--primary)'};">
                        <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 10px;">
                            <div>
                                <h4 style="margin: 0; color: var(--text-primary);">${enq.name}</h4>
                                <p style="margin: 5px 0; color: var(--text-secondary);"><i class="fas fa-phone"></i> ${enq.mobile}</p>
                                ${enq.plan ? `<p style="margin: 5px 0; color: var(--primary);"><i class="fas fa-tag"></i> Interested in: ${enq.plan}</p>` : ''}
                                ${enq.notes ? `<p style="margin: 5px 0; color: var(--text-secondary); font-size: 0.9rem;"><i class="fas fa-sticky-note"></i> ${enq.notes}</p>` : ''}
                                <p style="margin: 5px 0; font-size: 0.8rem; color: var(--text-secondary);"><i class="fas fa-calendar"></i> ${new Date(enq.date).toLocaleDateString()}</p>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <span style="background: ${enq.status === 'converted' ? 'var(--success)' : 'var(--warning)'}; color: ${enq.status === 'converted' ? 'white' : '#333'}; padding: 3px 10px; border-radius: 15px; font-size: 0.75rem;">${enq.status === 'converted' ? 'Converted' : 'Pending'}</span>
                            </div>
                        </div>
                        <div class="msg-buttons" style="margin-top: 15px;">
                            <button class="btn-whatsapp" onclick="gym.sendEnquiryCard('${enq.mobile}', '${enq.name}')" style="font-size: 0.85rem;">
                                <i class="fab fa-whatsapp"></i> Card
                            </button>
                            <button class="btn-sms" onclick="gym.sendEnquirySMS('${enq.mobile}', '${enq.name}')" style="font-size: 0.85rem;">
                                <i class="fas fa-sms"></i> SMS
                            </button>
                            <button class="btn-primary" onclick="gym.sendEnquiryPlans('${enq.mobile}', '${enq.name}')" style="font-size: 0.85rem; background: var(--warning); color: #333;">
                                <i class="fas fa-tags"></i> Plans
                            </button>
                            <button class="btn-primary" onclick="gym.convertEnquiry(${enq.id})" style="font-size: 0.85rem; background: var(--success);">
                                <i class="fas fa-user-check"></i> Convert
                            </button>
                            <button class="btn-secondary" onclick="gym.deleteEnquiry(${enq.id})" style="font-size: 0.85rem; background: var(--danger); color: white;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            sendEnquiryCard(mobile, name) {
                const formattedPhone = this.formatPhoneNumber(mobile);
                const settings = JSON.parse(localStorage.getItem('gymSettings')) || {};
                
                const message = ` *${settings.gymName || 'SG FITNESS EVOLUTION'}*\n\n` +
                    `${settings.tagline || 'Transform Your Body, Transform Your Life'}\n\n` +
                    `Dear ${name},\n\n` +
                    `Thank you for your interest in our gym! \n\n` +
                    ` Phone: +91 ${settings.phone || '9876543210'}\n` +
                    ` WhatsApp: +91 ${settings.whatsapp || '9876543210'}\n` +
                    ` Address: ${settings.address || 'Your Gym Address'}\n` +
                    ` Timing: ${settings.openTime || '05:00'} - ${settings.closeTime || '22:00'}\n\n` +
                    `Visit us today and start your fitness journey! `;
                
                const whatsappUrl = `https://wa.me/${formattedPhone}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
                this.showToast('Opening WhatsApp with gym card...');
            }

            sendEnquirySMS(mobile, name) {
                const formattedPhone = this.formatPhoneNumber(mobile);
                const settings = JSON.parse(localStorage.getItem('gymSettings')) || {};
                
                const smsMessage = `Dear ${name}, Thank you for your interest in ${settings.gymName || 'SG FITNESS EVOLUTION'}! Visit us at ${settings.address || 'Our Gym'}. Call: ${settings.phone || '9876543210'}. Timings: ${settings.openTime || '05:00'} - ${settings.closeTime || '22:00'}`;
                
                const smsUrl = `sms:${formattedPhone}?body=${encodeURIComponent(smsMessage)}`;
                window.open(smsUrl, '_blank');
                this.showToast('Opening SMS...');
            }

            sendEnquiryPlans(mobile, name) {
                const formattedPhone = this.formatPhoneNumber(mobile);
                const settings = JSON.parse(localStorage.getItem('gymSettings')) || {};
                const plans = JSON.parse(localStorage.getItem('gymPlans')) || [];
                
                let planDetails = ` *${settings.gymName || 'SG FITNESS EVOLUTION'}*\n\n`;
                planDetails += `Dear ${name},\n\n`;
                planDetails += ` *OUR GYM PLANS:*\n\n`;
                
                if (plans.length > 0) {
                    plans.forEach(plan => {
                        planDetails += ` *${plan.name}*\n`;
                        planDetails += `   Duration: ${plan.duration} days\n`;
                        planDetails += `   Price: ${plan.price}\n\n`;
                    });
                } else {
                    planDetails += ` *1 Month* - 500\n`;
                    planDetails += ` *3 Months* - 1200\n`;
                    planDetails += ` *6 Months* - 2000\n`;
                    planDetails += ` *12 Months* - 3500\n\n`;
                }
                
                planDetails += ` Contact: +91 ${settings.phone || '9876543210'}\n`;
                planDetails += ` Address: ${settings.address || 'Your Gym Address'}\n\n`;
                planDetails += `Join us today! `;
                
                const whatsappUrl = `https://wa.me/${formattedPhone}?text=${encodeURIComponent(planDetails)}`;
                window.open(whatsappUrl, '_blank');
                this.showToast('Opening WhatsApp with plans...');
            }

            convertEnquiry(id) {
                const enquiry = this.enquiries.find(e => e.id === id);
                if (!enquiry) {
                    this.showToast('Enquiry not found!', 'error');
                    return;
                }

                // Ask for confirmation
                if (!confirm(` Convert "${enquiry.name}" to Member?\n\nThis will:\n1. Open Add Member form with details filled\n2. You can set the plan and fees\n3. After adding, enquiry will be marked as converted`)) {
                    return;
                }

                // Store enquiry id for later marking as converted
                this.convertingEnquiryId = enquiry.id;

                // Switch to Members tab
                this.switchTabFromMenu('members');

                // Wait for tab switch, then open modal and fill form
                setTimeout(() => {
                    // Open Add Member Modal
                    this.openAddMemberModal();
                    
                    // Wait for modal to open, then fill the form
                    setTimeout(() => {
                        // Fill the form with enquiry data
                        const fullNameField = document.getElementById('fullName');
                        const mobileField = document.getElementById('mobileNumber');
                        
                        if (fullNameField) fullNameField.value = enquiry.name;
                        if (mobileField) mobileField.value = enquiry.mobile;
                        
                        // Highlight modal
                        const modal = document.getElementById('memberModal');
                        if (modal) {
                            modal.style.boxShadow = '0 0 30px var(--success)';
                            setTimeout(() => {
                                modal.style.boxShadow = '';
                            }, 3000);
                        }

                        this.showToast(' Fill remaining details and click "Add Member"', 'success');
                    }, 300);
                }, 300);
            }

            // Called after member is successfully added to mark enquiry as converted
            markEnquiryConverted() {
                if (this.convertingEnquiryId) {
                    const enquiry = this.enquiries.find(e => e.id === this.convertingEnquiryId);
                    if (enquiry) {
                        enquiry.status = 'converted';
                        this.saveEnquiries();
                        this.autoSyncToCloud();
                    }
                    this.convertingEnquiryId = null;
                }
            }

            deleteEnquiry(id) {
                if (confirm('Are you sure you want to delete this enquiry?')) {
                    this.enquiries = this.enquiries.filter(e => e.id !== id);
                    this.saveEnquiries();
                    this.autoSyncToCloud(); // Auto sync
                    this.renderEnquiries();
                    this.showToast('Enquiry deleted');
                }
            }

            // ============ END ENQUIRY MANAGEMENT ============

            // ============ WORKOUT & DIET PLANS ============
            loadWorkoutPlans() {
                this.workoutPlans = JSON.parse(localStorage.getItem('gymWorkoutPlans')) || this.getDefaultWorkoutPlans();
                this.renderWorkoutPlans();
            }

            loadDietPlans() {
                this.dietPlans = JSON.parse(localStorage.getItem('gymDietPlans')) || this.getDefaultDietPlans();
                this.renderDietPlans();
            }

            getDefaultWorkoutPlans() {
                return [
                    {
                        id: 1,
                        name: 'Beginner Full Body',
                        description: 'Perfect for beginners starting their fitness journey',
                        daysPerWeek: 3,
                        level: 'Beginner',
                        days: [
                            {
                                name: 'Day 1 - Full Body',
                                exercises: [
                                    'Squats - 3 sets x 12 reps',
                                    'Push-ups - 3 sets x 10 reps',
                                    'Lat Pulldown - 3 sets x 12 reps',
                                    'Dumbbell Shoulder Press - 3 sets x 12 reps',
                                    'Plank - 3 sets x 30 sec'
                                ]
                            },
                            {
                                name: 'Day 2 - Full Body',
                                exercises: [
                                    'Lunges - 3 sets x 10 each leg',
                                    'Chest Press - 3 sets x 12 reps',
                                    'Seated Rows - 3 sets x 12 reps',
                                    'Bicep Curls - 3 sets x 12 reps',
                                    'Crunches - 3 sets x 15 reps'
                                ]
                            },
                            {
                                name: 'Day 3 - Full Body',
                                exercises: [
                                    'Leg Press - 3 sets x 12 reps',
                                    'Incline Push-ups - 3 sets x 12 reps',
                                    'Face Pulls - 3 sets x 15 reps',
                                    'Tricep Dips - 3 sets x 10 reps',
                                    'Russian Twists - 3 sets x 20 reps'
                                ]
                            }
                        ]
                    },
                    {
                        id: 2,
                        name: 'Muscle Building - Push Pull Legs',
                        description: 'Build muscle with this classic PPL split',
                        daysPerWeek: 6,
                        level: 'Intermediate',
                        days: [
                            {
                                name: 'Push Day (Chest, Shoulders, Triceps)',
                                exercises: [
                                    'Bench Press - 4 sets x 8-10 reps',
                                    'Incline Dumbbell Press - 3 sets x 10 reps',
                                    'Overhead Press - 4 sets x 8-10 reps',
                                    'Lateral Raises - 3 sets x 12 reps',
                                    'Tricep Pushdowns - 3 sets x 12 reps',
                                    'Overhead Tricep Extension - 3 sets x 12 reps'
                                ]
                            },
                            {
                                name: 'Pull Day (Back, Biceps)',
                                exercises: [
                                    'Deadlifts - 4 sets x 6-8 reps',
                                    'Pull-ups/Lat Pulldown - 4 sets x 8-10 reps',
                                    'Barbell Rows - 4 sets x 8-10 reps',
                                    'Face Pulls - 3 sets x 15 reps',
                                    'Barbell Curls - 3 sets x 10 reps',
                                    'Hammer Curls - 3 sets x 12 reps'
                                ]
                            },
                            {
                                name: 'Legs Day',
                                exercises: [
                                    'Squats - 4 sets x 8-10 reps',
                                    'Romanian Deadlifts - 3 sets x 10 reps',
                                    'Leg Press - 3 sets x 12 reps',
                                    'Leg Curls - 3 sets x 12 reps',
                                    'Calf Raises - 4 sets x 15 reps',
                                    'Leg Extensions - 3 sets x 12 reps'
                                ]
                            }
                        ]
                    }
                ];
            }

            getDefaultDietPlans() {
                return [
                    {
                        id: 1,
                        name: 'Weight Loss Diet',
                        description: 'Calorie deficit diet for fat loss',
                        goal: 'Weight Loss',
                        calories: 1800,
                        meals: [
                            {
                                name: 'Breakfast (7:00 AM)',
                                items: [
                                    '2 Egg Whites + 1 Whole Egg Omelette',
                                    '2 Brown Bread Slices',
                                    '1 Glass Milk (Low Fat)',
                                    '1 Fruit (Apple/Banana)'
                                ]
                            },
                            {
                                name: 'Mid-Morning Snack (10:00 AM)',
                                items: [
                                    '10 Almonds',
                                    '1 Cup Green Tea'
                                ]
                            },
                            {
                                name: 'Lunch (1:00 PM)',
                                items: [
                                    '2 Roti (Wheat)',
                                    '1 Bowl Dal',
                                    '1 Bowl Sabzi (Low Oil)',
                                    'Salad',
                                    '1 Bowl Curd'
                                ]
                            },
                            {
                                name: 'Evening Snack (4:00 PM)',
                                items: [
                                    'Protein Shake OR',
                                    'Sprouts Chaat',
                                    '1 Cup Green Tea'
                                ]
                            },
                            {
                                name: 'Dinner (7:30 PM)',
                                items: [
                                    '1 Bowl Soup',
                                    'Grilled Chicken/Paneer 150g',
                                    'Salad',
                                    '1 Roti (Optional)'
                                ]
                            }
                        ]
                    },
                    {
                        id: 2,
                        name: 'Muscle Gain Diet',
                        description: 'High protein diet for muscle building',
                        goal: 'Muscle Gain',
                        calories: 2800,
                        meals: [
                            {
                                name: 'Breakfast (7:00 AM)',
                                items: [
                                    '4 Whole Eggs Omelette',
                                    '4 Brown Bread Slices',
                                    '1 Glass Full Fat Milk',
                                    '1 Banana',
                                    '2 Tbsp Peanut Butter'
                                ]
                            },
                            {
                                name: 'Mid-Morning Snack (10:00 AM)',
                                items: [
                                    'Protein Shake with Milk',
                                    '1 Handful Mixed Nuts'
                                ]
                            },
                            {
                                name: 'Lunch (1:00 PM)',
                                items: [
                                    '3-4 Roti/1.5 Cup Rice',
                                    'Chicken Curry/Paneer 200g',
                                    '1 Bowl Dal',
                                    'Salad',
                                    '1 Bowl Curd'
                                ]
                            },
                            {
                                name: 'Pre-Workout (5:00 PM)',
                                items: [
                                    '2 Bananas',
                                    '1 Cup Black Coffee',
                                    '4-5 Dates'
                                ]
                            },
                            {
                                name: 'Post-Workout (7:30 PM)',
                                items: [
                                    'Protein Shake',
                                    '1 Banana'
                                ]
                            },
                            {
                                name: 'Dinner (8:30 PM)',
                                items: [
                                    '2 Roti',
                                    'Chicken/Fish 200g OR Paneer 250g',
                                    '1 Bowl Sabzi',
                                    'Salad'
                                ]
                            }
                        ]
                    }
                ];
            }

            saveWorkoutPlans() {
                localStorage.setItem('gymWorkoutPlans', JSON.stringify(this.workoutPlans));
                this.autoSyncToCloud();
            }

            saveDietPlans() {
                localStorage.setItem('gymDietPlans', JSON.stringify(this.dietPlans));
                this.autoSyncToCloud();
            }

            switchWorkoutSubTab(tabName) {
                // Update button states
                document.querySelectorAll('.workout-subtab').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.subtab === tabName) {
                        btn.classList.add('active');
                    }
                });

                // Show/hide sections
                document.querySelectorAll('.workout-section').forEach(section => {
                    section.style.display = 'none';
                });
                document.getElementById('section-' + tabName).style.display = 'block';

                // Load data for specific tabs
                if (tabName === 'assignPlan') {
                    this.populateAssignDropdowns();
                } else if (tabName === 'memberPlans') {
                    this.renderMemberPlans();
                }
            }

            populateAssignDropdowns() {
                // Member selection is now done via search - no dropdown needed
                // Clear any previous selection
                document.getElementById('assignMemberSelect').value = '';
                document.getElementById('assignMemberSearch').value = '';
                document.getElementById('selectedMemberDisplay').style.display = 'none';

                // Populate workout plans dropdown
                const workoutSelect = document.getElementById('assignWorkoutSelect');
                workoutSelect.innerHTML = '<option value="">-- No Workout Plan --</option>' +
                    this.workoutPlans.map(p => `<option value="${p.id}">${p.name}</option>`).join('');

                // Populate diet plans dropdown
                const dietSelect = document.getElementById('assignDietSelect');
                dietSelect.innerHTML = '<option value="">-- No Diet Plan --</option>' +
                    this.dietPlans.map(p => `<option value="${p.id}">${p.name}</option>`).join('');

                // Set default start date to today
                document.getElementById('assignStartDate').value = new Date().toISOString().split('T')[0];
            }

            renderWorkoutPlans() {
                const container = document.getElementById('workoutPlansList');
                if (!container) return;

                if (this.workoutPlans.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 50px; color: var(--gray); grid-column: 1/-1;">
                            <i class="fas fa-dumbbell" style="font-size: 3rem; margin-bottom: 15px;"></i>
                            <p>No workout plans yet. Create your first plan!</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.workoutPlans.map(plan => `
                    <div class="plan-card">
                        <div class="plan-card-header">
                            <h4><i class="fas fa-dumbbell"></i> ${plan.name}</h4>
                            <p>${plan.daysPerWeek} Days/Week  ${plan.level}</p>
                        </div>
                        <div class="plan-card-body">
                            <p style="color: var(--gray); margin-bottom: 15px; font-size: 0.9rem;">${plan.description || ''}</p>
                            ${plan.days.slice(0, 2).map(day => `
                                <div class="plan-day">
                                    <h5>${day.name}</h5>
                                    <ul>
                                        ${day.exercises.slice(0, 3).map(ex => `<li>${ex}</li>`).join('')}
                                        ${day.exercises.length > 3 ? `<li style="color: var(--primary);">+ ${day.exercises.length - 3} more...</li>` : ''}
                                    </ul>
                                </div>
                            `).join('')}
                            ${plan.days.length > 2 ? `<p style="color: var(--primary); font-size: 0.9rem;">+ ${plan.days.length - 2} more days...</p>` : ''}
                        </div>
                        <div class="plan-card-actions">
                            <button onclick="gym.viewWorkoutPlan(${plan.id})" style="background: var(--primary); color: white;">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button onclick="gym.shareWorkoutPlan(${plan.id})" style="background: #25D366; color: white;">
                                <i class="fab fa-whatsapp"></i> Share
                            </button>
                            <button onclick="gym.deleteWorkoutPlan(${plan.id})" style="background: var(--danger); color: white;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            renderDietPlans() {
                const container = document.getElementById('dietPlansList');
                if (!container) return;

                if (this.dietPlans.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 50px; color: var(--gray); grid-column: 1/-1;">
                            <i class="fas fa-utensils" style="font-size: 3rem; margin-bottom: 15px;"></i>
                            <p>No diet plans yet. Create your first plan!</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.dietPlans.map(plan => `
                    <div class="plan-card">
                        <div class="plan-card-header diet">
                            <h4><i class="fas fa-utensils"></i> ${plan.name}</h4>
                            <p>${plan.goal}  ~${plan.calories} Cal/day</p>
                        </div>
                        <div class="plan-card-body">
                            <p style="color: var(--gray); margin-bottom: 15px; font-size: 0.9rem;">${plan.description || ''}</p>
                            ${plan.meals.slice(0, 2).map(meal => `
                                <div class="plan-day">
                                    <h5 style="color: #4CAF50;">${meal.name}</h5>
                                    <ul>
                                        ${meal.items.slice(0, 3).map(item => `<li>${item}</li>`).join('')}
                                        ${meal.items.length > 3 ? `<li style="color: #4CAF50;">+ ${meal.items.length - 3} more...</li>` : ''}
                                    </ul>
                                </div>
                            `).join('')}
                            ${plan.meals.length > 2 ? `<p style="color: #4CAF50; font-size: 0.9rem;">+ ${plan.meals.length - 2} more meals...</p>` : ''}
                        </div>
                        <div class="plan-card-actions">
                            <button onclick="gym.viewDietPlan(${plan.id})" style="background: #4CAF50; color: white;">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button onclick="gym.shareDietPlan(${plan.id})" style="background: #25D366; color: white;">
                                <i class="fab fa-whatsapp"></i> Share
                            </button>
                            <button onclick="gym.deleteDietPlan(${plan.id})" style="background: var(--danger); color: white;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            showCreateWorkoutModal() {
                this.workoutDayCount = 0;
                document.getElementById('workoutPlanName').value = '';
                document.getElementById('workoutPlanDesc').value = '';
                document.getElementById('workoutDaysPerWeek').value = '5';
                document.getElementById('workoutLevel').value = 'Beginner';
                document.getElementById('workoutDaysContainer').innerHTML = '';
                
                // Add 3 default days
                this.addWorkoutDay();
                this.addWorkoutDay();
                this.addWorkoutDay();
                
                document.getElementById('createWorkoutModal').classList.add('active');
            }

            addWorkoutDay() {
                this.workoutDayCount++;
                const container = document.getElementById('workoutDaysContainer');
                const dayHTML = `
                    <div class="workout-day-input" id="workoutDay${this.workoutDayCount}" style="background: #f8f9fa; border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <input type="text" placeholder="Day Name (e.g., Monday - Chest)" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" class="day-name">
                            <button type="button" onclick="document.getElementById('workoutDay${this.workoutDayCount}').remove()" style="background: var(--danger); color: white; border: none; padding: 8px 12px; border-radius: 5px; margin-left: 10px; cursor: pointer;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <textarea placeholder="Exercises (one per line)&#10;e.g., Bench Press - 4 sets x 12 reps&#10;Incline Dumbbell Press - 3 sets x 12 reps" style="width: 100%; min-height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" class="day-exercises"></textarea>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', dayHTML);
            }

            saveWorkoutPlan() {
                const name = document.getElementById('workoutPlanName').value.trim();
                const desc = document.getElementById('workoutPlanDesc').value.trim();
                const daysPerWeek = parseInt(document.getElementById('workoutDaysPerWeek').value);
                const level = document.getElementById('workoutLevel').value;

                if (!name) {
                    this.showToast('Please enter plan name', 'error');
                    return;
                }

                const days = [];
                document.querySelectorAll('.workout-day-input').forEach(dayEl => {
                    const dayName = dayEl.querySelector('.day-name').value.trim();
                    const exercisesText = dayEl.querySelector('.day-exercises').value.trim();
                    if (dayName && exercisesText) {
                        days.push({
                            name: dayName,
                            exercises: exercisesText.split('\n').filter(e => e.trim())
                        });
                    }
                });

                if (days.length === 0) {
                    this.showToast('Please add at least one day with exercises', 'error');
                    return;
                }

                const plan = {
                    id: Date.now(),
                    name,
                    description: desc,
                    daysPerWeek,
                    level,
                    days
                };

                this.workoutPlans.push(plan);
                this.saveWorkoutPlans();
                this.renderWorkoutPlans();
                this.closeAllModals();
                this.showToast(' Workout plan created successfully!');
            }

            showCreateDietModal() {
                this.dietMealCount = 0;
                document.getElementById('dietPlanName').value = '';
                document.getElementById('dietPlanDesc').value = '';
                document.getElementById('dietGoal').value = 'Weight Loss';
                document.getElementById('dietCalories').value = '';
                document.getElementById('dietMealsContainer').innerHTML = '';
                
                // Add default meals
                this.addDietMeal('Breakfast (7:00 AM)');
                this.addDietMeal('Mid-Morning Snack (10:00 AM)');
                this.addDietMeal('Lunch (1:00 PM)');
                this.addDietMeal('Evening Snack (4:00 PM)');
                this.addDietMeal('Dinner (8:00 PM)');
                
                document.getElementById('createDietModal').classList.add('active');
            }

            addDietMeal(defaultName = '') {
                this.dietMealCount++;
                const container = document.getElementById('dietMealsContainer');
                const mealHTML = `
                    <div class="diet-meal-input" id="dietMeal${this.dietMealCount}" style="background: #f8f9fa; border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <input type="text" placeholder="Meal Name (e.g., Breakfast 7:00 AM)" value="${defaultName}" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" class="meal-name">
                            <button type="button" onclick="document.getElementById('dietMeal${this.dietMealCount}').remove()" style="background: var(--danger); color: white; border: none; padding: 8px 12px; border-radius: 5px; margin-left: 10px; cursor: pointer;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <textarea placeholder="Food items (one per line)&#10;e.g., 2 Eggs Omelette&#10;2 Brown Bread&#10;1 Glass Milk" style="width: 100%; min-height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" class="meal-items"></textarea>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', mealHTML);
            }

            saveDietPlan() {
                const name = document.getElementById('dietPlanName').value.trim();
                const desc = document.getElementById('dietPlanDesc').value.trim();
                const goal = document.getElementById('dietGoal').value;
                const calories = parseInt(document.getElementById('dietCalories').value) || 2000;

                if (!name) {
                    this.showToast('Please enter plan name', 'error');
                    return;
                }

                const meals = [];
                document.querySelectorAll('.diet-meal-input').forEach(mealEl => {
                    const mealName = mealEl.querySelector('.meal-name').value.trim();
                    const itemsText = mealEl.querySelector('.meal-items').value.trim();
                    if (mealName && itemsText) {
                        meals.push({
                            name: mealName,
                            items: itemsText.split('\n').filter(i => i.trim())
                        });
                    }
                });

                if (meals.length === 0) {
                    this.showToast('Please add at least one meal', 'error');
                    return;
                }

                const plan = {
                    id: Date.now(),
                    name,
                    description: desc,
                    goal,
                    calories,
                    meals
                };

                this.dietPlans.push(plan);
                this.saveDietPlans();
                this.renderDietPlans();
                this.closeAllModals();
                this.showToast(' Diet plan created successfully!');
            }

            viewWorkoutPlan(id) {
                const plan = this.workoutPlans.find(p => p.id === id);
                if (!plan) return;

                document.getElementById('viewPlanHeader').innerHTML = `
                    <h2><i class="fas fa-dumbbell"></i> ${plan.name}</h2>
                    <button class="close-modal" onclick="gym.closeAllModals()">&times;</button>
                `;

                document.getElementById('viewPlanBody').innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <p style="color: var(--gray);">${plan.description || ''}</p>
                        <div style="display: flex; gap: 15px; margin-top: 10px; flex-wrap: wrap;">
                            <span style="background: var(--light); padding: 5px 12px; border-radius: 20px; font-size: 0.9rem;">
                                <i class="fas fa-calendar"></i> ${plan.daysPerWeek} Days/Week
                            </span>
                            <span style="background: var(--light); padding: 5px 12px; border-radius: 20px; font-size: 0.9rem;">
                                <i class="fas fa-signal"></i> ${plan.level}
                            </span>
                        </div>
                    </div>
                    ${plan.days.map(day => `
                        <div class="plan-day">
                            <h5><i class="fas fa-calendar-day"></i> ${day.name}</h5>
                            <ul>
                                ${day.exercises.map(ex => `<li>${ex}</li>`).join('')}
                            </ul>
                        </div>
                    `).join('')}
                    <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="gym.shareWorkoutPlan(${plan.id})" class="btn-whatsapp" style="flex: 1;">
                            <i class="fab fa-whatsapp"></i> Share on WhatsApp
                        </button>
                    </div>
                `;

                document.getElementById('viewPlanModal').classList.add('active');
            }

            viewDietPlan(id) {
                const plan = this.dietPlans.find(p => p.id === id);
                if (!plan) return;

                document.getElementById('viewPlanHeader').innerHTML = `
                    <h2 style="color: #4CAF50;"><i class="fas fa-utensils"></i> ${plan.name}</h2>
                    <button class="close-modal" onclick="gym.closeAllModals()">&times;</button>
                `;

                document.getElementById('viewPlanBody').innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <p style="color: var(--gray);">${plan.description || ''}</p>
                        <div style="display: flex; gap: 15px; margin-top: 10px; flex-wrap: wrap;">
                            <span style="background: #e8f5e9; padding: 5px 12px; border-radius: 20px; font-size: 0.9rem; color: #4CAF50;">
                                <i class="fas fa-bullseye"></i> ${plan.goal}
                            </span>
                            <span style="background: #e8f5e9; padding: 5px 12px; border-radius: 20px; font-size: 0.9rem; color: #4CAF50;">
                                <i class="fas fa-fire"></i> ~${plan.calories} Calories/day
                            </span>
                        </div>
                    </div>
                    ${plan.meals.map(meal => `
                        <div class="plan-day" style="border-left: 3px solid #4CAF50;">
                            <h5 style="color: #4CAF50;"><i class="fas fa-utensils"></i> ${meal.name}</h5>
                            <ul>
                                ${meal.items.map(item => `<li>${item}</li>`).join('')}
                            </ul>
                        </div>
                    `).join('')}
                    <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="gym.shareDietPlan(${plan.id})" class="btn-whatsapp" style="flex: 1;">
                            <i class="fab fa-whatsapp"></i> Share on WhatsApp
                        </button>
                    </div>
                `;

                document.getElementById('viewPlanModal').classList.add('active');
            }

            shareWorkoutPlan(id, mobile = null) {
                const plan = this.workoutPlans.find(p => p.id === id);
                if (!plan) return;

                const settings = JSON.parse(localStorage.getItem('gymSettings')) || {};
                const gymName = settings.gymName || 'SG FITNESS EVOLUTION';

                let message = ` *${gymName}*\n`;
                message += `\n\n`;
                message += ` *WORKOUT PLAN*\n`;
                message += `*${plan.name}*\n`;
                message += ` ${plan.daysPerWeek} Days/Week | ${plan.level}\n\n`;

                plan.days.forEach(day => {
                    message += `*${day.name}*\n`;
                    day.exercises.forEach(ex => {
                        message += ` ${ex}\n`;
                    });
                    message += `\n`;
                });

                message += `\n`;
                message += `Stay Consistent, Stay Strong! \n`;
                message += ` ${settings.phone || ''}`;

                if (mobile) {
                    const formattedPhone = this.formatPhoneNumber(mobile);
                    window.open(`https://wa.me/${formattedPhone}?text=${encodeURIComponent(message)}`, '_blank');
                } else {
                    window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
                }
                this.showToast('Opening WhatsApp...');
            }

            shareDietPlan(id, mobile = null) {
                const plan = this.dietPlans.find(p => p.id === id);
                if (!plan) return;

                const settings = JSON.parse(localStorage.getItem('gymSettings')) || {};
                const gymName = settings.gymName || 'SG FITNESS EVOLUTION';

                let message = ` *${gymName}*\n`;
                message += `\n\n`;
                message += ` *DIET PLAN*\n`;
                message += `*${plan.name}*\n`;
                message += ` ${plan.goal} | ~${plan.calories} Cal/day\n\n`;

                plan.meals.forEach(meal => {
                    message += `*${meal.name}*\n`;
                    meal.items.forEach(item => {
                        message += ` ${item}\n`;
                    });
                    message += `\n`;
                });

                message += `\n`;
                message += `Eat Clean, Stay Lean! \n`;
                message += ` ${settings.phone || ''}`;

                if (mobile) {
                    const formattedPhone = this.formatPhoneNumber(mobile);
                    window.open(`https://wa.me/${formattedPhone}?text=${encodeURIComponent(message)}`, '_blank');
                } else {
                    window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
                }
                this.showToast('Opening WhatsApp...');
            }

            deleteWorkoutPlan(id) {
                if (!confirm('Are you sure you want to delete this workout plan?')) return;
                this.workoutPlans = this.workoutPlans.filter(p => p.id !== id);
                this.saveWorkoutPlans();
                this.renderWorkoutPlans();
                this.showToast('Workout plan deleted');
            }

            deleteDietPlan(id) {
                if (!confirm('Are you sure you want to delete this diet plan?')) return;
                this.dietPlans = this.dietPlans.filter(p => p.id !== id);
                this.saveDietPlans();
                this.renderDietPlans();
                this.showToast('Diet plan deleted');
            }

            // ============ MEMBER SEARCH FOR ASSIGN ============
            searchMemberForAssign(query) {
                const resultsDiv = document.getElementById('assignMemberResults');
                
                if (!query || query.length < 1) {
                    resultsDiv.style.display = 'none';
                    return;
                }

                const searchQuery = query.toLowerCase().trim();
                const isNumericQuery = /^\d+$/.test(searchQuery);
                
                const filteredMembers = this.members.filter(m => {
                    // If searching by number, match roll number exactly or from start
                    if (isNumericQuery) {
                        const rollNo = String(m.serialNumber);
                        if (rollNo === searchQuery || rollNo.startsWith(searchQuery)) {
                            return true;
                        }
                    }
                    
                    // Text search
                    return m.fullName.toLowerCase().includes(searchQuery) ||
                        m.mobileNumber.includes(searchQuery) ||
                        (m.fatherName && m.fatherName.toLowerCase().includes(searchQuery));
                }).slice(0, 10); // Show max 10 results

                if (filteredMembers.length === 0) {
                    resultsDiv.innerHTML = '<div class="member-search-no-results"><i class="fas fa-search"></i> No members found</div>';
                    resultsDiv.style.display = 'block';
                    return;
                }

                resultsDiv.innerHTML = filteredMembers.map(member => {
                    const isExpired = new Date(member.expiryDate) < new Date();
                    const statusClass = isExpired ? 'expired' : 'active';
                    const statusText = isExpired ? 'Expired' : 'Active';
                    
                    return `
                        <div class="member-search-item" onclick="gym.selectMemberForAssign(${member.id})">
                            <div class="member-info-left">
                                <span class="member-roll">${member.serialNumber}</span>
                                <span class="member-name">${member.fullName}</span>
                            </div>
                            <span class="member-status ${statusClass}">${statusText}</span>
                        </div>
                    `;
                }).join('');

                resultsDiv.style.display = 'block';
            }

            selectMemberForAssign(memberId) {
                const member = this.members.find(m => m.id === memberId);
                if (!member) return;

                // Set hidden input value
                document.getElementById('assignMemberSelect').value = memberId;
                
                // Clear search input and hide results
                document.getElementById('assignMemberSearch').value = '';
                document.getElementById('assignMemberResults').style.display = 'none';
                
                // Show selected member
                document.getElementById('selectedMemberName').innerHTML = `
                    <i class="fas fa-user-check"></i> ${member.serialNumber} - ${member.fullName}
                `;
                document.getElementById('selectedMemberDisplay').style.display = 'block';
            }

            clearSelectedMember() {
                document.getElementById('assignMemberSelect').value = '';
                document.getElementById('selectedMemberDisplay').style.display = 'none';
                document.getElementById('assignMemberSearch').value = '';
            }

            assignPlanToMember() {
                const memberId = parseInt(document.getElementById('assignMemberSelect').value);
                const workoutPlanId = parseInt(document.getElementById('assignWorkoutSelect').value);
                const dietPlanId = parseInt(document.getElementById('assignDietSelect').value);
                const startDate = document.getElementById('assignStartDate').value;
                const duration = parseInt(document.getElementById('assignDuration').value);
                const notes = document.getElementById('assignNotes').value.trim();

                if (!memberId) {
                    this.showToast('Please search and select a member', 'error');
                    return;
                }

                if (!workoutPlanId && !dietPlanId) {
                    this.showToast('Please select at least one plan', 'error');
                    return;
                }

                const member = this.members.find(m => m.id === memberId);
                if (!member) return;

                // Assign plans to member
                member.assignedPlan = {
                    workoutPlanId: workoutPlanId || null,
                    dietPlanId: dietPlanId || null,
                    startDate: startDate,
                    duration: duration,
                    notes: notes,
                    assignedAt: new Date().toISOString()
                };

                localStorage.setItem('gymMembers', JSON.stringify(this.members));
                this.autoSyncToCloud();
                
                // Clear selected member after assign
                this.clearSelectedMember();
                
                this.showToast(' Plan assigned successfully!');

                // Ask to share on WhatsApp
                if (confirm(`Plan assigned to ${member.fullName}. Share on WhatsApp?`)) {
                    this.shareMemberPlan(memberId);
                }
            }

            renderMemberPlans() {
                const container = document.getElementById('memberPlansList');
                const membersWithPlans = this.members.filter(m => m.assignedPlan);

                if (membersWithPlans.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 50px; color: var(--gray);">
                            <i class="fas fa-user-slash" style="font-size: 3rem; margin-bottom: 15px;"></i>
                            <p>No members have plans assigned yet.</p>
                            <p style="font-size: 0.9rem;">Go to "Assign to Member" tab to assign plans.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = membersWithPlans.map(m => {
                    const workoutPlan = this.workoutPlans.find(p => p.id === m.assignedPlan.workoutPlanId);
                    const dietPlan = this.dietPlans.find(p => p.id === m.assignedPlan.dietPlanId);

                    return `
                        <div class="member-plan-card">
                            <h4><i class="fas fa-user"></i> ${m.fullName} <span style="color: var(--gray); font-weight: normal;">(${m.serialNumber})</span></h4>
                            <div class="member-plan-info">
                                ${workoutPlan ? `<span><i class="fas fa-dumbbell" style="color: var(--primary);"></i> ${workoutPlan.name}</span>` : ''}
                                ${dietPlan ? `<span><i class="fas fa-utensils" style="color: #4CAF50;"></i> ${dietPlan.name}</span>` : ''}
                                <span><i class="fas fa-calendar"></i> ${m.assignedPlan.duration} Weeks</span>
                                <span><i class="fas fa-play"></i> Started: ${this.formatDate(m.assignedPlan.startDate)}</span>
                            </div>
                            ${m.assignedPlan.notes ? `<p style="font-size: 0.9rem; color: var(--gray); margin-bottom: 15px;"><i class="fas fa-sticky-note"></i> ${m.assignedPlan.notes}</p>` : ''}
                            <div class="msg-buttons">
                                <button class="btn-whatsapp" onclick="gym.shareMemberPlan(${m.id})">
                                    <i class="fab fa-whatsapp"></i> Share Plan
                                </button>
                                <button class="btn-primary" onclick="gym.viewMemberPlan(${m.id})" style="background: var(--primary);">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                <button class="btn-secondary" onclick="gym.removeMemberPlan(${m.id})" style="background: var(--danger); color: white;">
                                    <i class="fas fa-trash"></i> Remove
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            filterMemberPlans() {
                const search = document.getElementById('memberPlanSearch').value.toLowerCase();
                const cards = document.querySelectorAll('.member-plan-card');
                cards.forEach(card => {
                    const text = card.textContent.toLowerCase();
                    card.style.display = text.includes(search) ? 'block' : 'none';
                });
            }

            shareMemberPlan(memberId) {
                const member = this.members.find(m => m.id === memberId);
                if (!member || !member.assignedPlan) return;

                const workoutPlan = this.workoutPlans.find(p => p.id === member.assignedPlan.workoutPlanId);
                const dietPlan = this.dietPlans.find(p => p.id === member.assignedPlan.dietPlanId);
                const settings = JSON.parse(localStorage.getItem('gymSettings')) || {};
                const gymName = settings.gymName || 'SG FITNESS EVOLUTION';

                let message = ` *${gymName}*\n`;
                message += `\n\n`;
                message += ` *${member.fullName}*\n`;
                message += ` Roll No: ${member.serialNumber}\n`;
                message += ` Duration: ${member.assignedPlan.duration} Weeks\n\n`;

                if (workoutPlan) {
                    message += ` *WORKOUT PLAN: ${workoutPlan.name}*\n`;
                    message += `${workoutPlan.daysPerWeek} Days/Week | ${workoutPlan.level}\n\n`;
                    workoutPlan.days.forEach(day => {
                        message += `*${day.name}*\n`;
                        day.exercises.forEach(ex => {
                            message += ` ${ex}\n`;
                        });
                        message += `\n`;
                    });
                }

                if (dietPlan) {
                    message += ` *DIET PLAN: ${dietPlan.name}*\n`;
                    message += `${dietPlan.goal} | ~${dietPlan.calories} Cal/day\n\n`;
                    dietPlan.meals.forEach(meal => {
                        message += `*${meal.name}*\n`;
                        meal.items.forEach(item => {
                            message += ` ${item}\n`;
                        });
                        message += `\n`;
                    });
                }

                if (member.assignedPlan.notes) {
                    message += ` *Trainer Notes:* ${member.assignedPlan.notes}\n\n`;
                }

                message += `\n`;
                message += `Stay Fit, Stay Strong! \n`;
                message += ` ${settings.phone || ''}`;

                const formattedPhone = this.formatPhoneNumber(member.mobileNumber);
                window.open(`https://wa.me/${formattedPhone}?text=${encodeURIComponent(message)}`, '_blank');
                this.showToast('Opening WhatsApp...');
            }

            viewMemberPlan(memberId) {
                const member = this.members.find(m => m.id === memberId);
                if (!member || !member.assignedPlan) return;

                const workoutPlan = this.workoutPlans.find(p => p.id === member.assignedPlan.workoutPlanId);
                const dietPlan = this.dietPlans.find(p => p.id === member.assignedPlan.dietPlanId);

                document.getElementById('viewPlanHeader').innerHTML = `
                    <h2><i class="fas fa-user"></i> ${member.fullName}'s Plan</h2>
                    <button class="close-modal" onclick="gym.closeAllModals()">&times;</button>
                `;

                let bodyHTML = `
                    <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <p><strong>Roll No:</strong> ${member.serialNumber}</p>
                        <p><strong>Duration:</strong> ${member.assignedPlan.duration} Weeks</p>
                        <p><strong>Started:</strong> ${this.formatDate(member.assignedPlan.startDate)}</p>
                        ${member.assignedPlan.notes ? `<p><strong>Notes:</strong> ${member.assignedPlan.notes}</p>` : ''}
                    </div>
                `;

                if (workoutPlan) {
                    bodyHTML += `
                        <h4 style="color: var(--primary); margin: 20px 0 15px;"><i class="fas fa-dumbbell"></i> ${workoutPlan.name}</h4>
                        ${workoutPlan.days.map(day => `
                            <div class="plan-day">
                                <h5>${day.name}</h5>
                                <ul>${day.exercises.map(ex => `<li>${ex}</li>`).join('')}</ul>
                            </div>
                        `).join('')}
                    `;
                }

                if (dietPlan) {
                    bodyHTML += `
                        <h4 style="color: #4CAF50; margin: 20px 0 15px;"><i class="fas fa-utensils"></i> ${dietPlan.name}</h4>
                        ${dietPlan.meals.map(meal => `
                            <div class="plan-day" style="border-left-color: #4CAF50;">
                                <h5 style="color: #4CAF50;">${meal.name}</h5>
                                <ul>${meal.items.map(item => `<li>${item}</li>`).join('')}</ul>
                            </div>
                        `).join('')}
                    `;
                }

                bodyHTML += `
                    <div style="margin-top: 20px;">
                        <button onclick="gym.shareMemberPlan(${memberId})" class="btn-whatsapp" style="width: 100%;">
                            <i class="fab fa-whatsapp"></i> Share on WhatsApp
                        </button>
                    </div>
                `;

                document.getElementById('viewPlanBody').innerHTML = bodyHTML;
                document.getElementById('viewPlanModal').classList.add('active');
            }

            removeMemberPlan(memberId) {
                if (!confirm('Remove assigned plan from this member?')) return;
                const member = this.members.find(m => m.id === memberId);
                if (member) {
                    delete member.assignedPlan;
                    localStorage.setItem('gymMembers', JSON.stringify(this.members));
                    this.autoSyncToCloud();
                    this.renderMemberPlans();
                    this.showToast('Plan removed from member');
                }
            }

            // ============ END WORKOUT & DIET PLANS ============

            // ============ END NEW FEATURES ============

            // Helper function to format phone number correctly
            formatPhoneNumber(phone) {
                // Remove all non-digit characters
                let cleaned = phone.replace(/\D/g, '');
                
                // Remove leading 91 if present (to avoid double 91)
                if (cleaned.startsWith('91') && cleaned.length > 10) {
                    cleaned = cleaned.substring(2);
                }
                
                // Remove leading 0 if present
                if (cleaned.startsWith('0')) {
                    cleaned = cleaned.substring(1);
                }
                
                // Take last 10 digits (in case of any extra digits)
                if (cleaned.length > 10) {
                    cleaned = cleaned.slice(-10);
                }
                
                // Add 91 country code
                return '91' + cleaned;
            }

            // WhatsApp Only (without SMS)
            sendWhatsAppOnly(phoneNumber, memberName) {
                let cleanPhone = phoneNumber.replace(/\D/g, '');
                if (cleanPhone.startsWith('91') && cleanPhone.length > 10) cleanPhone = cleanPhone.substring(2);
                if (cleanPhone.startsWith('0')) cleanPhone = cleanPhone.substring(1);
                if (cleanPhone.length > 10) cleanPhone = cleanPhone.slice(-10);
                const formattedPhone = '91' + cleanPhone;
                
                const settings = JSON.parse(localStorage.getItem('gymSettings')) || {};
                const gymName = settings.gymName || 'SG FITNESS EVOLUTION';
                
                const message = ` *${gymName}*

Dear *${memberName}*,

Your gym membership is about to expire soon. Kindly renew your membership at the earliest to continue enjoying our services.

Thank you! `;
                
                const whatsappUrl = `https://wa.me/${formattedPhone}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
                this.showToast(`WhatsApp ready for ${memberName}`);
            }

            // SMS Only
            sendSMS(phoneNumber, memberName) {
                let cleanPhone = phoneNumber.replace(/\D/g, '');
                if (cleanPhone.length > 10) cleanPhone = cleanPhone.slice(-10);
                
                const settings = JSON.parse(localStorage.getItem('gymSettings')) || {};
                const gymName = settings.gymName || 'SG FITNESS EVOLUTION';
                
                const smsMessage = `${gymName} - Dear ${memberName}, Your gym membership is about to expire soon. Kindly renew your membership at the earliest. Thank you!`;
                const smsUrl = `sms:${cleanPhone}?body=${encodeURIComponent(smsMessage)}`;
                window.open(smsUrl, '_blank');
                this.showToast(`SMS ready for ${memberName}`);
            }

            // WhatsApp Alert Only (for expiring members)
            sendWhatsAppAlertOnly(phoneNumber, memberName, expiryDate) {
                let cleanPhone = phoneNumber.replace(/\D/g, '');
                if (cleanPhone.startsWith('91') && cleanPhone.length > 10) cleanPhone = cleanPhone.substring(2);
                if (cleanPhone.startsWith('0')) cleanPhone = cleanPhone.substring(1);
                if (cleanPhone.length > 10) cleanPhone = cleanPhone.slice(-10);
                const formattedPhone = '91' + cleanPhone;
                
                const settings = JSON.parse(localStorage.getItem('gymSettings')) || {};
                const gymName = settings.gymName || 'SG FITNESS EVOLUTION';
                const formattedDate = new Date(expiryDate).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
                
                const message = ` *${gymName}*

Dear *${memberName}*,

Your gym membership will expire on *${formattedDate}*.

Kindly renew your membership at the earliest to continue enjoying our services.

Thank you! `;
                
                const whatsappUrl = `https://wa.me/${formattedPhone}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
                this.showToast(`WhatsApp alert ready for ${memberName}`);
            }

            // SMS Alert Only (for expiring members)
            sendSMSAlert(phoneNumber, memberName, expiryDate) {
                let cleanPhone = phoneNumber.replace(/\D/g, '');
                if (cleanPhone.length > 10) cleanPhone = cleanPhone.slice(-10);
                
                const settings = JSON.parse(localStorage.getItem('gymSettings')) || {};
                const gymName = settings.gymName || 'SG FITNESS EVOLUTION';
                const formattedDate = new Date(expiryDate).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
                
                const smsMessage = `${gymName} - Dear ${memberName}, Your membership expires on ${formattedDate}. Kindly renew at the earliest. Thank you!`;
                const smsUrl = `sms:${cleanPhone}?body=${encodeURIComponent(smsMessage)}`;
                window.open(smsUrl, '_blank');
                this.showToast(`SMS alert ready for ${memberName}`);
            }

            sendWhatsAppAlert(phoneNumber, memberName, expiryDate) {
                let cleanPhone = phoneNumber.replace(/\D/g, '');
                if (cleanPhone.startsWith('91') && cleanPhone.length > 10) cleanPhone = cleanPhone.substring(2);
                if (cleanPhone.startsWith('0')) cleanPhone = cleanPhone.substring(1);
                if (cleanPhone.length > 10) cleanPhone = cleanPhone.slice(-10);
                const formattedPhone = '91' + cleanPhone;
                
                const settings = JSON.parse(localStorage.getItem('gymSettings')) || {};
                const gymName = settings.gymName || 'SG FITNESS EVOLUTION';
                const formattedDate = new Date(expiryDate).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
                
                const message = ` *${gymName}*

Dear *${memberName}*,

Your gym membership will expire on *${formattedDate}*.

Kindly renew your membership at the earliest to continue enjoying our services.

Thank you! `;
                
                const whatsappUrl = `https://wa.me/${formattedPhone}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
                
                // Open SMS (after small delay)
                setTimeout(() => {
                    const smsMessage = `${gymName} - Dear ${memberName}, Your membership expires on ${formattedDate}. Kindly renew at the earliest. Thank you!`;
                    const smsUrl = `sms:${cleanPhone}?body=${encodeURIComponent(smsMessage)}`;
                    window.open(smsUrl, '_blank');
                }, 500);
                
                this.showToast(`WhatsApp + SMS ready for ${memberName}`);
            }

            sendWhatsApp(phoneNumber, memberName) {
                let cleanPhone = phoneNumber.replace(/\D/g, '');
                if (cleanPhone.startsWith('91') && cleanPhone.length > 10) cleanPhone = cleanPhone.substring(2);
                if (cleanPhone.startsWith('0')) cleanPhone = cleanPhone.substring(1);
                if (cleanPhone.length > 10) cleanPhone = cleanPhone.slice(-10);
                const formattedPhone = '91' + cleanPhone;
                
                const settings = JSON.parse(localStorage.getItem('gymSettings')) || {};
                const gymName = settings.gymName || 'SG FITNESS EVOLUTION';
                
                const message = ` *${gymName}*

Dear *${memberName}*,

Your gym membership is about to expire soon. Kindly renew your membership at the earliest to continue enjoying our services.

Thank you! `;
                
                const smsMessage = `${gymName} - Dear ${memberName}, Your gym membership is about to expire soon. Kindly renew at the earliest. Thank you!`;
                
                const whatsappUrl = `https://wa.me/${formattedPhone}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
                
                // Open SMS (after small delay)
                setTimeout(() => {
                    const smsUrl = `sms:${formattedPhone}?body=${encodeURIComponent(smsMessage)}`;
                    window.open(smsUrl, '_blank');
                }, 500);
                
                this.showToast(`WhatsApp + SMS ready for ${memberName}`);
            }

            showToast(message, type = 'success') {
                const toast = document.getElementById('toast');
                const toastMessage = document.getElementById('toastMessage');
                
                // Set icon based on type
                const icon = type === 'error' ? 'fa-exclamation-circle' : 
                            type === 'warning' ? 'fa-exclamation-triangle' : 
                            'fa-check-circle';
                
                toast.innerHTML = `<i class="fas ${icon}"></i><span id="toastMessage">${message}</span>`;
                
                // Set background color based on type
                toast.style.background = type === 'error' ? 'var(--danger)' : 
                                       type === 'warning' ? 'var(--warning)' : 
                                       'var(--success)';
                
                toast.style.display = 'flex';
                
                // Hide after 3 seconds
                setTimeout(() => {
                    toast.style.display = 'none';
                }, 3000);
            }

            closeAllModals() {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.style.display = 'none';
                });
            }

            updateMemberStatus(memberId) {
                const member = this.members.find(m => m.id === memberId);
                if (!member) return;
                
                const expiryDate = new Date(member.expiryDate);
                const today = new Date();
                
                if (expiryDate < today) {
                    member.status = 'expired';
                } else if (this.isExpiring(member)) {
                    member.status = 'expiring';
                } else {
                    member.status = 'active';
                }
                
                this.saveToLocalStorage();
            }

            // Helper methods
            formatDate(dateString) {
                if (!dateString) return 'N/A';
                try {
                    const date = new Date(dateString);
                    return date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                } catch (e) {
                    return dateString;
                }
            }

            getStatusClass(member) {
                if (this.isExpired(member)) return 'status-expired';
                if (this.isExpiring(member)) return 'status-expiring';
                return 'status-active';
            }

            getStatusText(member) {
                if (this.isExpired(member)) return 'Expired';
                if (this.isExpiring(member)) return 'Expiring Soon';
                return 'Active';
            }

            isExpiring(member) {
                const expiryDate = new Date(member.expiryDate);
                const today = new Date();
                const daysDiff = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                return daysDiff > 0 && daysDiff <= 7;
            }

            isExpired(member) {
                const expiryDate = new Date(member.expiryDate);
                const today = new Date();
                return expiryDate < today;
            }

            // ============ CLOUD SYNC METHODS ============
            initFirebase() {
                // Check if Firebase config exists
                const savedConfig = localStorage.getItem('firebaseConfig');
                if (savedConfig) {
                    try {
                        const config = JSON.parse(savedConfig);
                        firebase.initializeApp(config);
                        this.db = firebase.database();
                        this.setupRealtimeSync();
                        
                        // Immediately load data from cloud
                        this.loadFromCloud();
                        
                        this.showToast('Cloud sync connected!', 'success');
                        // Update side menu sync status
                        this.updateSyncStatus(true);
                    } catch (e) {
                        console.log('Firebase error:', e);
                        this.showToast('Firebase connection failed. Check your config.', 'error');
                        this.updateSyncStatus(false);
                    }
                } else {
                    this.updateSyncStatus(false);
                }
            }

            updateSyncStatus(connected) {
                const menuSync = document.getElementById('syncStatusMenu');
                if (menuSync) {
                    if (connected) {
                        menuSync.innerHTML = '<i class="fas fa-cloud" style="color: #2ecc71;"></i><span>Connected</span>';
                        menuSync.style.color = '#2ecc71';
                    } else {
                        menuSync.innerHTML = '<i class="fas fa-cloud-slash" style="color: #ffc107;"></i><span>Not Connected</span>';
                        menuSync.style.color = '#ffc107';
                    }
                }
            }

            loadFromCloud() {
                if (!this.db) {
                    this.showToast('Firebase not connected', 'error');
                    return;
                }
                
                this.showToast('Loading data from cloud...', 'info');
                
                // Load all data from Firebase
                this.db.ref('gymData').once('value').then((snapshot) => {
                    const data = snapshot.val();
                    
                    if (data) {
                        // Load members
                        if (data.members) {
                            this.members = Object.values(data.members);
                            
                            // Fix serial numbers
                            this.members.forEach((m, index) => {
                                if (m.serialNumber && m.serialNumber.toString().startsWith('GYM')) {
                                    const num = parseInt(m.serialNumber.replace('GYM', ''));
                                    m.serialNumber = String(num || (index + 1));
                                }
                            });
                            
                            localStorage.setItem('gymMembers', JSON.stringify(this.members));
                        }
                        
                        // Load settings
                        if (data.settings) {
                            localStorage.setItem('gymSettings', JSON.stringify(data.settings));
                            this.loadSettings();
                        }
                        
                        // Load plans
                        if (data.plans) {
                            localStorage.setItem('gymPlans', JSON.stringify(data.plans));
                            this.loadPlans();
                        }
                        
                        // Load enquiries
                        if (data.enquiries) {
                            this.enquiries = Object.values(data.enquiries);
                            localStorage.setItem('gymEnquiries', JSON.stringify(this.enquiries));
                        }
                        
                        // Load attendance
                        if (data.attendance) {
                            localStorage.setItem('attendanceRecords', JSON.stringify(Object.values(data.attendance)));
                        }
                        
                        // Load message settings
                        if (data.messageSettings) {
                            localStorage.setItem('messageSettings', JSON.stringify(data.messageSettings));
                            this.loadMessageSettings();
                        }
                        
                        // Refresh UI
                        this.renderMembers();
                        this.updateDashboard();
                        this.generateNotifications();
                        
                        this.showToast(` Cloud data loaded! ${this.members.length} members synced`, 'success');
                    } else {
                        this.showToast('No data found in cloud. Upload your local data first.', 'warning');
                    }
                }).catch((error) => {
                    console.error('Firebase load error:', error);
                    this.showToast('Failed to load from cloud: ' + error.message, 'error');
                });
            }

            setupRealtimeSync() {
                if (!this.db) return;
                
                // Listen for changes from cloud
                let isFirstLoad = true;
                this.db.ref('gymData/members').on('value', (snapshot) => {
                    const cloudData = snapshot.val();
                    if (cloudData && !this.isSyncing) {
                        const oldCount = this.members.length;
                        this.members = Object.values(cloudData);
                        
                        // Fix serial numbers - convert GYM00001 format to simple 1, 2, 3
                        let needsCloudUpdate = false;
                        this.members.forEach((m, index) => {
                            if (m.serialNumber && m.serialNumber.toString().startsWith('GYM')) {
                                const num = parseInt(m.serialNumber.replace('GYM', ''));
                                m.serialNumber = String(num || (index + 1));
                                needsCloudUpdate = true;
                            }
                        });
                        
                        localStorage.setItem('gymMembers', JSON.stringify(this.members));
                        
                        // Update cloud with fixed serial numbers
                        if (needsCloudUpdate) {
                            this.isSyncing = true;
                            const membersObj = {};
                            this.members.forEach(m => { membersObj[m.id] = m; });
                            this.db.ref('gymData/members').set(membersObj).then(() => {
                                this.isSyncing = false;
                            });
                        }
                        
                        this.renderMembers();
                        this.updateDashboard();
                        
                        // Show notification only after first load
                        if (!isFirstLoad && oldCount !== this.members.length) {
                            this.showToast(` Data synced from cloud! ${this.members.length} members`, 'info');
                        }
                        isFirstLoad = false;
                    }
                });
                
                // Also listen for settings changes
                this.db.ref('gymData/settings').on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        localStorage.setItem('gymSettings', JSON.stringify(data));
                        this.loadSettings();
                    }
                });
                
                // Also listen for plans changes
                this.db.ref('gymData/plans').on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        localStorage.setItem('gymPlans', JSON.stringify(data));
                        this.loadPlans();
                    }
                });
                
                // Also listen for enquiries changes
                this.db.ref('gymData/enquiries').on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        this.enquiries = Object.values(data);
                        localStorage.setItem('gymEnquiries', JSON.stringify(this.enquiries));
                        this.renderEnquiries();
                    }
                });
                
                // Also listen for attendance changes
                this.db.ref('gymData/attendance').on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data && !this.isSyncing) {
                        localStorage.setItem('attendanceRecords', JSON.stringify(Object.values(data)));
                        
                        // Always update dashboard attendance section for real-time updates
                        this.updateDashboard();
                        
                        // Refresh attendance if on attendance tab
                        const attTab = document.getElementById('tab-attendance');
                        if (attTab && attTab.classList.contains('active')) {
                            this.updateCurrentlyInGym();
                            this.loadAttendanceByDate();
                        }
                    }
                });
                
                // Listen for message settings changes
                this.db.ref('gymData/messageSettings').on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data && !this.isSyncing) {
                        localStorage.setItem('messageSettings', JSON.stringify(data));
                        this.loadMessageSettings();
                    }
                });
            }

            syncToCloud() {
                if (!this.db) {
                    return; // Silently skip if not configured
                }
                
                this.isSyncing = true;
                
                this.isSyncing = true;
                const membersObj = {};
                this.members.forEach(m => {
                    membersObj[m.id] = m;
                });
                
                // Also sync enquiries
                const enquiriesObj = {};
                this.enquiries.forEach(e => {
                    enquiriesObj[e.id] = e;
                });
                
                // Get settings and plans
                const settings = JSON.parse(localStorage.getItem('gymSettings')) || {};
                const plans = JSON.parse(localStorage.getItem('gymPlans')) || [];
                const attendanceRecords = this.getAttendanceRecords();
                const attendanceObj = {};
                attendanceRecords.forEach(r => { attendanceObj[r.id] = r; });
                
                Promise.all([
                    this.db.ref('gymData/members').set(membersObj),
                    this.db.ref('gymData/enquiries').set(enquiriesObj),
                    this.db.ref('gymData/settings').set(settings),
                    this.db.ref('gymData/plans').set(plans),
                    this.db.ref('gymData/attendance').set(attendanceObj)
                ]).then(() => {
                    this.isSyncing = false;
                    this.showToast(' Data synced to cloud!', 'success');
                }).catch(err => {
                    this.isSyncing = false;
                    this.showToast('Sync failed: ' + err.message, 'error');
                });
            }

            // Auto sync to cloud (silent, no toast)
            autoSyncToCloud() {
                if (!this.db) return;
                
                const membersObj = {};
                this.members.forEach(m => {
                    membersObj[m.id] = m;
                });
                
                const enquiriesObj = {};
                this.enquiries.forEach(e => {
                    enquiriesObj[e.id] = e;
                });
                
                // Get settings and plans
                const settings = JSON.parse(localStorage.getItem('gymSettings')) || {};
                const plans = JSON.parse(localStorage.getItem('gymPlans')) || [];
                const workoutPlans = JSON.parse(localStorage.getItem('gymWorkoutPlans')) || [];
                const dietPlans = JSON.parse(localStorage.getItem('gymDietPlans')) || [];
                const messageSettings = JSON.parse(localStorage.getItem('messageSettings')) || this.getDefaultMessages();
                const attendanceRecords = this.getAttendanceRecords();
                const attendanceObj = {};
                attendanceRecords.forEach(r => { attendanceObj[r.id] = r; });
                
                Promise.all([
                    this.db.ref('gymData/members').set(membersObj),
                    this.db.ref('gymData/enquiries').set(enquiriesObj),
                    this.db.ref('gymData/settings').set(settings),
                    this.db.ref('gymData/plans').set(plans),
                    this.db.ref('gymData/workoutPlans').set(workoutPlans),
                    this.db.ref('gymData/dietPlans').set(dietPlans),
                    this.db.ref('gymData/messageSettings').set(messageSettings),
                    this.db.ref('gymData/attendance').set(attendanceObj)
                ]).then(() => {
                    console.log('Auto synced to cloud');
                }).catch(err => {
                    console.error('Auto sync failed:', err);
                });
            }

            // ============ NOTIFICATION CENTER ============
            loadNotifications() {
                this.notifications = JSON.parse(localStorage.getItem('gymNotifications')) || [];
                this.updateNotificationBadge();
            }

            saveNotifications() {
                localStorage.setItem('gymNotifications', JSON.stringify(this.notifications));
                this.updateNotificationBadge();
            }

            // Check and add birthday notification for a specific member (used when adding new member)
            checkAndAddBirthdayNotification(member) {
                if (!member.dob) return;
                
                const today = new Date();
                const todayMonth = today.getMonth() + 1;
                const todayDate = today.getDate();
                const dob = new Date(member.dob);
                
                if (dob.getMonth() + 1 === todayMonth && dob.getDate() === todayDate) {
                    this.addNotification({
                        type: 'birthday',
                        title: ` ${member.fullName}'s Birthday!`,
                        message: `Today is ${member.fullName}'s birthday. Send wishes!`,
                        memberId: member.id,
                        memberName: member.fullName,
                        memberMobile: member.mobileNumber,
                        rollNo: member.serialNumber
                    });
                    this.renderNotifications();
                    this.showToast(` Today is ${member.fullName}'s Birthday!`, 'success');
                }
            }

            generateNotifications() {
                const today = new Date();
                const todayStr = today.toDateString();
                const todayMonth = today.getMonth() + 1;
                const todayDate = today.getDate();
                
                // Get dismissed notifications list
                const dismissedNotifications = JSON.parse(localStorage.getItem('dismissedNotifications')) || [];
                // Clean up old dismissed entries (keep only today's)
                const todayDismissed = dismissedNotifications.filter(d => d.date === todayStr);
                localStorage.setItem('dismissedNotifications', JSON.stringify(todayDismissed));
                
                // Always check for today's birthdays (for all members - old and new)
                this.members.forEach(member => {
                    if (!member.dob) return;
                    const dob = new Date(member.dob);
                    if (dob.getMonth() + 1 === todayMonth && dob.getDate() === todayDate) {
                        // Check if notification was dismissed today
                        const wasDismissed = todayDismissed.find(d => 
                            d.type === 'birthday' && 
                            d.memberId === member.id
                        );
                        
                        if (wasDismissed) return; // Skip if already dismissed
                        
                        // Check if birthday notification already exists for this member today
                        const birthdayExists = this.notifications.find(n => 
                            n.type === 'birthday' && 
                            n.memberId === member.id &&
                            new Date(n.createdAt).toDateString() === todayStr
                        );
                        
                        if (!birthdayExists) {
                            this.notifications.unshift({
                                id: Date.now() + Math.random(),
                                type: 'birthday',
                                title: ` ${member.fullName}'s Birthday!`,
                                message: `Today is ${member.fullName}'s birthday. Send wishes!`,
                                memberId: member.id,
                                memberName: member.fullName,
                                memberMobile: member.mobileNumber,
                                rollNo: member.serialNumber,
                                read: false,
                                createdAt: new Date().toISOString()
                            });
                        }
                    }
                });
                
                // Check if expiry notifications already generated today
                const lastGenerated = localStorage.getItem('notificationsLastGenerated');
                if (lastGenerated !== todayStr) {
                    // Generate expiry notifications only once per day
                    const alertDays = parseInt(JSON.parse(localStorage.getItem('gymSettings'))?.expiryAlertDays) || 7;
                    
                    this.members.forEach(member => {
                        if (!member.expiryDate) return;
                        const expiry = new Date(member.expiryDate);
                        const diffDays = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
                        
                        if (diffDays <= alertDays && diffDays >= 0) {
                            this.addNotification({
                                type: 'expiry',
                                title: ` ${member.fullName}'s Plan Expiring`,
                                message: diffDays === 0 ? 'Plan expires TODAY!' : `Plan expires in ${diffDays} day${diffDays > 1 ? 's' : ''}`,
                                memberId: member.id,
                                memberName: member.fullName,
                                memberMobile: member.mobileNumber,
                                rollNo: member.serialNumber,
                                expiryDate: member.expiryDate
                            });
                        } else if (diffDays < 0) {
                            this.addNotification({
                                type: 'expiry',
                                title: ` ${member.fullName}'s Plan Expired`,
                                message: `Plan expired ${Math.abs(diffDays)} day${Math.abs(diffDays) > 1 ? 's' : ''} ago`,
                                memberId: member.id,
                                memberName: member.fullName,
                                memberMobile: member.mobileNumber,
                                rollNo: member.serialNumber,
                                expiryDate: member.expiryDate
                            });
                        }
                        
                        // Check for dues - use both dueAmount and duesAmount for compatibility
                        const dues = member.dueAmount || member.duesAmount || 0;
                        if (dues > 0) {
                            this.addNotification({
                                type: 'dues',
                                title: ` ${member.fullName} - Dues Pending`,
                                message: `Pending amount: ${dues}`,
                                memberId: member.id,
                                memberName: member.fullName,
                                memberMobile: member.mobileNumber,
                                rollNo: member.serialNumber,
                                duesAmount: dues
                            });
                        }
                    });
                    
                    localStorage.setItem('notificationsLastGenerated', todayStr);
                }
                
                this.saveNotifications();
                this.renderNotifications();
            }

            addNotification(notification) {
                // Check if similar notification already exists
                const exists = this.notifications.find(n => 
                    n.type === notification.type && 
                    n.memberId === notification.memberId &&
                    new Date(n.createdAt).toDateString() === new Date().toDateString()
                );
                
                // Check if this notification was dismissed today
                const dismissedNotifications = JSON.parse(localStorage.getItem('dismissedNotifications')) || [];
                const todayStr = new Date().toDateString();
                const key = `${notification.type}_${notification.memberId}_${notification.expiryDate || ''}_${notification.rollNo || ''}`;
                const wasDismissed = dismissedNotifications.find(d => d.key === key && d.date === todayStr);
                
                if (!exists && !wasDismissed) {
                    this.notifications.unshift({
                        id: Date.now(),
                        ...notification,
                        read: false,
                        createdAt: new Date().toISOString()
                    });
                    this.saveNotifications();
                }
            }

            currentNotificationFilter = 'all';

            updateNotificationBadge() {
                const badge = document.getElementById('notificationBadge');
                const unreadCount = this.notifications.filter(n => !n.read).length;
                
                if (unreadCount > 0) {
                    badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                    badge.style.display = 'block';
                } else {
                    badge.style.display = 'none';
                }
                
                // Update filter counts
                this.updateFilterCounts();
            }

            updateFilterCounts() {
                const counts = {
                    all: this.notifications.length,
                    birthday: this.notifications.filter(n => n.type === 'birthday').length,
                    expiring: this.notifications.filter(n => n.type === 'expiry' && n.message.includes('expires')).length,
                    expired: this.notifications.filter(n => n.type === 'expiry' && n.message.includes('expired')).length,
                    dues: this.notifications.filter(n => n.type === 'dues').length,
                    payment: this.notifications.filter(n => n.type === 'payment').length
                };
                
                Object.keys(counts).forEach(key => {
                    const badge = document.getElementById(`filter-count-${key}`);
                    if (badge) {
                        badge.textContent = counts[key];
                    }
                });
            }

            filterNotifications(filter) {
                this.currentNotificationFilter = filter;
                
                // Update active state
                document.querySelectorAll('.notification-filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`.notification-filter-btn.${filter}`).classList.add('active');
                
                // Re-render notifications
                this.renderNotifications();
            }

            toggleNotificationPanel() {
                const panel = document.getElementById('notificationPanel');
                const overlay = document.getElementById('notificationOverlay');
                
                if (panel.classList.contains('open')) {
                    this.closeNotificationPanel();
                } else {
                    panel.classList.add('open');
                    overlay.classList.add('open');
                    this.renderNotifications();
                }
            }

            closeNotificationPanel() {
                document.getElementById('notificationPanel').classList.remove('open');
                document.getElementById('notificationOverlay').classList.remove('open');
            }

            renderNotifications() {
                const container = document.getElementById('notificationList');
                
                // Filter notifications based on current filter
                let filteredNotifications = this.notifications;
                
                if (this.currentNotificationFilter !== 'all') {
                    if (this.currentNotificationFilter === 'birthday') {
                        filteredNotifications = this.notifications.filter(n => n.type === 'birthday');
                    } else if (this.currentNotificationFilter === 'expiring') {
                        filteredNotifications = this.notifications.filter(n => 
                            n.type === 'expiry' && n.message.includes('expires')
                        );
                    } else if (this.currentNotificationFilter === 'expired') {
                        filteredNotifications = this.notifications.filter(n => 
                            n.type === 'expiry' && n.message.includes('expired')
                        );
                    } else if (this.currentNotificationFilter === 'dues') {
                        filteredNotifications = this.notifications.filter(n => n.type === 'dues');
                    } else if (this.currentNotificationFilter === 'payment') {
                        filteredNotifications = this.notifications.filter(n => n.type === 'payment');
                    }
                }
                
                if (filteredNotifications.length === 0) {
                    const filterName = this.currentNotificationFilter === 'all' ? '' : ` (${this.currentNotificationFilter})`;
                    container.innerHTML = `
                        <div class="notification-empty">
                            <i class="fas fa-bell-slash"></i>
                            <p>No notifications${filterName}</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = filteredNotifications.map(n => `
                    <div class="notification-item ${n.type} ${n.read ? '' : 'unread'}" onclick="gym.markNotificationRead(${n.id})">
                        <h4>${n.title}</h4>
                        <p>${n.message}</p>
                        ${n.rollNo ? `<p style="font-size: 0.8rem;"><strong>Roll No:</strong> ${n.rollNo}</p>` : ''}
                        <div class="notification-time">
                            <i class="fas fa-clock"></i> ${this.formatNotificationTime(n.createdAt)}
                        </div>
                        <div class="notification-actions-btns">
                            ${n.type === 'birthday' ? `
                                <button class="btn-whatsapp" onclick="event.stopPropagation(); gym.sendBirthdayWish('${n.memberMobile}', '${n.memberName}')" style="font-size: 0.8rem; padding: 6px 12px;">
                                    <i class="fab fa-whatsapp"></i> Wish
                                </button>
                                <button class="btn-sms" onclick="event.stopPropagation(); gym.sendBirthdaySMS('${n.memberMobile}', '${n.memberName}')" style="font-size: 0.8rem; padding: 6px 12px;">
                                    <i class="fas fa-sms"></i> SMS
                                </button>
                            ` : ''}
                            ${n.type === 'expiry' ? `
                                <button class="btn-whatsapp" onclick="event.stopPropagation(); gym.sendExpiryReminder('${n.memberMobile}', '${n.memberName}', '${n.expiryDate}')" style="font-size: 0.8rem; padding: 6px 12px;">
                                    <i class="fab fa-whatsapp"></i> Remind
                                </button>
                                <button class="btn-primary" onclick="event.stopPropagation(); gym.showPaymentModal(${n.memberId})" style="font-size: 0.8rem; padding: 6px 12px; background: var(--success);">
                                    <i class="fas fa-rupee-sign"></i> Renew
                                </button>
                            ` : ''}
                            ${n.type === 'dues' ? `
                                <button class="btn-whatsapp" onclick="event.stopPropagation(); gym.sendDuesReminder('${n.memberMobile}', '${n.memberName}', '${n.duesAmount}')" style="font-size: 0.8rem; padding: 6px 12px;">
                                    <i class="fab fa-whatsapp"></i> Remind
                                </button>
                                <button class="btn-primary" onclick="event.stopPropagation(); gym.showPaymentModal(${n.memberId})" style="font-size: 0.8rem; padding: 6px 12px; background: var(--success);">
                                    <i class="fas fa-rupee-sign"></i> Collect
                                </button>
                            ` : ''}
                            <button onclick="event.stopPropagation(); gym.deleteNotification(${n.id})" style="font-size: 0.8rem; padding: 6px 12px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 5px; cursor: pointer;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            formatNotificationTime(dateStr) {
                const date = new Date(dateStr);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);
                
                if (diffMins < 1) return 'Just now';
                if (diffMins < 60) return `${diffMins} min ago`;
                if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
                if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
                return date.toLocaleDateString();
            }

            markNotificationRead(id) {
                const notification = this.notifications.find(n => n.id === id);
                if (notification && !notification.read) {
                    notification.read = true;
                    this.saveNotifications();
                    this.renderNotifications();
                    this.updateNotificationBadge();
                }
            }

            markAllNotificationsRead() {
                this.notifications.forEach(n => n.read = true);
                this.saveNotifications();
                this.renderNotifications();
                this.updateNotificationBadge();
                this.showToast('All notifications marked as read');
            }

            deleteNotification(id) {
                this.notifications = this.notifications.filter(n => n.id !== id);
                
                // Track dismissed notification to prevent re-adding
                const dismissedNotifications = JSON.parse(localStorage.getItem('dismissedNotifications')) || [];
                const notification = this.notifications.find(n => n.id === id);
                if (notification) {
                    dismissedNotifications.push({
                        type: notification.type,
                        memberId: notification.memberId,
                        date: new Date().toDateString()
                    });
                    localStorage.setItem('dismissedNotifications', JSON.stringify(dismissedNotifications));
                }
                
                this.saveNotifications();
                this.renderNotifications();
            }

            clearAllNotifications() {
                if (confirm('Are you sure you want to clear all notifications?')) {
                    // Track all dismissed notifications with unique key
                    const dismissedNotifications = JSON.parse(localStorage.getItem('dismissedNotifications')) || [];
                    const todayStr = new Date().toDateString();
                    
                    this.notifications.forEach(n => {
                        // Create unique key for each notification
                        const key = `${n.type}_${n.memberId}_${n.expiryDate || ''}_${n.rollNo || ''}`;
                        if (!dismissedNotifications.find(d => d.key === key && d.date === todayStr)) {
                            dismissedNotifications.push({
                                key: key,
                                type: n.type,
                                memberId: n.memberId,
                                date: todayStr
                            });
                        }
                    });
                    localStorage.setItem('dismissedNotifications', JSON.stringify(dismissedNotifications));
                    
                    // Clear all notifications
                    this.notifications = [];
                    this.saveNotifications();
                    this.renderNotifications();
                    this.updateNotificationBadge();
                    this.showToast('All notifications cleared');
                }
            }

            sendExpiryReminder(mobile, name, expiryDate) {
                // Clean phone number
                let cleanPhone = mobile.replace(/\D/g, '');
                if (cleanPhone.startsWith('91') && cleanPhone.length > 10) cleanPhone = cleanPhone.substring(2);
                if (cleanPhone.startsWith('0')) cleanPhone = cleanPhone.substring(1);
                if (cleanPhone.length > 10) cleanPhone = cleanPhone.slice(-10);
                const formattedPhone = '91' + cleanPhone;
                
                const settings = JSON.parse(localStorage.getItem('gymSettings')) || {};
                const gymName = settings.gymName || 'SG FITNESS EVOLUTION';
                const gymPhone = settings.phone || '9876543210';
                
                const expDate = new Date(expiryDate);
                const today = new Date();
                const diffDays = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));
                const formattedExpiry = expDate.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
                
                let statusText = '';
                if (diffDays < 0) {
                    statusText = `expired ${Math.abs(diffDays)} days ago`;
                } else if (diffDays === 0) {
                    statusText = 'expires TODAY';
                } else {
                    statusText = `expires in ${diffDays} days`;
                }
                
                const message = ` *${gymName}*

Dear *${name}*,

This is a friendly reminder that your gym membership ${statusText}.

 Expiry Date: ${formattedExpiry}

Please renew your membership to continue enjoying our facilities and services.

 Stay Fit, Stay Healthy!

 Contact: ${gymPhone}

Thank you! `;
                
                const whatsappUrl = `https://wa.me/${formattedPhone}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
                this.showToast('Opening WhatsApp with reminder...');
            }

            sendDuesReminder(mobile, name, duesAmount) {
                // Clean phone number
                let cleanPhone = mobile.replace(/\D/g, '');
                if (cleanPhone.startsWith('91') && cleanPhone.length > 10) cleanPhone = cleanPhone.substring(2);
                if (cleanPhone.startsWith('0')) cleanPhone = cleanPhone.substring(1);
                if (cleanPhone.length > 10) cleanPhone = cleanPhone.slice(-10);
                const formattedPhone = '91' + cleanPhone;
                
                const settings = JSON.parse(localStorage.getItem('gymSettings')) || {};
                const gymName = settings.gymName || 'SG FITNESS EVOLUTION';
                const gymPhone = settings.phone || '9876543210';
                
                const message = ` *${gymName}*

Dear *${name}*,

This is a friendly reminder about your pending dues:

 Pending Amount: ${duesAmount}

Please clear your dues at your earliest convenience to continue enjoying our services.

 Thank you for your cooperation!

 Contact: ${gymPhone}

Thank you! `;
                
                const whatsappUrl = `https://wa.me/${formattedPhone}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
                this.showToast('Opening WhatsApp with dues reminder...');
            }

            sendDuesReminderWhatsApp(mobile, name, duesAmount) {
                // Clean phone number
                let cleanPhone = mobile.replace(/\D/g, '');
                if (cleanPhone.startsWith('91') && cleanPhone.length > 10) cleanPhone = cleanPhone.substring(2);
                if (cleanPhone.startsWith('0')) cleanPhone = cleanPhone.substring(1);
                if (cleanPhone.length > 10) cleanPhone = cleanPhone.slice(-10);
                const formattedPhone = '91' + cleanPhone;
                
                const settings = JSON.parse(localStorage.getItem('gymSettings')) || {};
                const gymName = settings.gymName || 'SG FITNESS EVOLUTION';
                const gymPhone = settings.phone || '9876543210';
                const upiId = settings.upiId || '';
                
                const message = ` *${gymName}*

Namaste *${name}* ji! 

 *Pending Dues Reminder*

Aapki gym membership ke pending dues hain:

 *Amount: ${duesAmount}*

Kripya jaldi se jaldi apne dues clear kar dijiye taaki aap hamari services ka poora labh utha sakein.

 *Payment Options:*
${upiId ? ` UPI: ${upiId}
` : ''} Cash
 Online Transfer

 Aapka cooperation bahut zaroori hai!

 Contact: ${gymPhone}

Dhanyavaad! 
*Team ${gymName}*`;
                
                const whatsappUrl = `https://wa.me/${formattedPhone}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
                this.showToast(` Dues reminder opening for ${name}...`, 'success');
            }

            // Add payment notification
            addPaymentNotification(member, amount, days) {
                this.addNotification({
                    type: 'payment',
                    title: ` Payment Received - ${member.fullName}`,
                    message: `${amount} received for ${days} days plan`,
                    memberId: member.id,
                    memberName: member.fullName,
                    rollNo: member.serialNumber
                });
            }

            // ============ END NOTIFICATION CENTER ============

            // Check for birthdays
            checkBirthdays() {
                const today = new Date();
                const todayMonth = today.getMonth() + 1;
                const todayDate = today.getDate();
                
                const birthdayMembers = this.members.filter(member => {
                    if (!member.dob) return false;
                    const dob = new Date(member.dob);
                    return dob.getMonth() + 1 === todayMonth && dob.getDate() === todayDate;
                });
                
                if (birthdayMembers.length > 0) {
                    this.showBirthdayPopup(birthdayMembers);
                }
            }

            showBirthdayPopup(members) {
                const membersList = members.map(m => `
                    <div style="background: #fff3e0; border-radius: 10px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <div>
                            <h4 style="margin: 0; color: var(--dark);"> ${m.fullName}</h4>
                            <p style="margin: 5px 0 0; color: var(--gray); font-size: 0.9rem;">Roll No: ${m.serialNumber}</p>
                        </div>
                        <div class="msg-buttons">
                            <button class="btn-whatsapp" onclick="gym.sendBirthdayWish('${m.mobileNumber}', '${m.fullName}')" style="font-size: 0.85rem; padding: 8px 15px;">
                                <i class="fab fa-whatsapp"></i> Wish
                            </button>
                            <button class="btn-sms" onclick="gym.sendBirthdaySMS('${m.mobileNumber}', '${m.fullName}')" style="font-size: 0.85rem; padding: 8px 15px;">
                                <i class="fas fa-sms"></i> SMS
                            </button>
                        </div>
                    </div>
                `).join('');
                
                const popupHTML = `
                    <div id="birthdayPopup" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; justify-content: center; align-items: center; padding: 20px;">
                        <div style="background: white; padding: 25px; border-radius: 20px; max-width: 450px; width: 100%; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                            <div style="text-align: center; margin-bottom: 20px;">
                                <div style="font-size: 4rem; margin-bottom: 10px;"></div>
                                <h2 style="margin: 0; color: var(--primary);">Today's Birthdays!</h2>
                                <p style="color: var(--gray); margin-top: 5px;">${members.length} member${members.length > 1 ? 's have' : ' has'} birthday today</p>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                ${membersList}
                            </div>
                            
                            <button onclick="document.getElementById('birthdayPopup').remove()" style="width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 1rem; cursor: pointer;">
                                <i class="fas fa-times"></i> Close
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', popupHTML);
            }

            sendBirthdayWish(mobile, name) {
                const formattedPhone = this.formatPhoneNumber(mobile);
                const settings = JSON.parse(localStorage.getItem('gymSettings')) || {};
                const gymName = settings.gymName || 'SG FITNESS EVOLUTION';
                
                const message = ` *Happy Birthday ${name}!* 

 *${gymName}* wishes you a very Happy Birthday!

May this special day bring you:
 Good Health
 Strength & Fitness
 Success in all your goals

Stay fit, stay healthy! 
Have a wonderful year ahead! 

With best wishes,
Team ${gymName} `;
                
                const whatsappUrl = `https://wa.me/${formattedPhone}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
                this.showToast('Opening WhatsApp with birthday wish...');
            }

            sendBirthdaySMS(mobile, name) {
                const formattedPhone = this.formatPhoneNumber(mobile);
                const settings = JSON.parse(localStorage.getItem('gymSettings')) || {};
                const gymName = settings.gymName || 'SG FITNESS EVOLUTION';
                
                const smsMessage = `Happy Birthday ${name}! ${gymName} wishes you good health, strength & fitness. Stay fit, stay healthy! Have a wonderful year ahead!`;
                
                const smsUrl = `sms:${formattedPhone}?body=${encodeURIComponent(smsMessage)}`;
                window.open(smsUrl, '_blank');
                this.showToast('Opening SMS with birthday wish...');
            }

            saveFirebaseConfig() {
                const apiKey = document.getElementById('firebaseApiKey').value.trim();
                const projectId = document.getElementById('firebaseProjectId').value.trim();
                const databaseURL = document.getElementById('firebaseDatabaseURL').value.trim();
                
                if (!apiKey || !projectId || !databaseURL) {
                    this.showToast('Please fill all Firebase fields', 'error');
                    return;
                }
                
                const config = {
                    apiKey: apiKey,
                    authDomain: `${projectId}.firebaseapp.com`,
                    databaseURL: databaseURL,
                    projectId: projectId
                };
                
                localStorage.setItem('firebaseConfig', JSON.stringify(config));
                this.showToast('Firebase config saved! Connecting...', 'success');
                
                // Auto-reload page to initialize Firebase
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            }
        }

        // Initialize the application when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.gym = new GymManagement();
            
            // Initialize Firebase if configured
            setTimeout(() => {
                window.gym.initFirebase();
            }, 500);
        });

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed:', err));
            });
        }

        // Install prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
        });

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((result) => {
                    if (result.outcome === 'accepted') {
                        console.log('App installed');
                        alert(' App installed successfully!');
                    }
                    deferredPrompt = null;
                });
            } else {
                // Fallback for browsers that don't support install prompt
                alert(' App Install   :\n\n' +
                      ' Chrome/Edge: Menu ()  "Install App"  "Add to Home Screen"\n\n' +
                      ' iPhone Safari: Share button  "Add to Home Screen"\n\n' +
                      ' Android Chrome: Menu  "Add to Home Screen"');
            }
        }
    </script>
</body>
</html>